<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEON CLASH - 2D Fighting Game</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');

  :root {
    --neon-red: #ff003c;
    --neon-blue: #00d4ff;
    --neon-yellow: #ffe600;
    --neon-green: #00ff88;
    --neon-purple: #b400ff;
    --dark-bg: #050510;
    --panel-bg: rgba(5, 5, 20, 0.95);
    --glow-red: 0 0 10px #ff003c, 0 0 20px #ff003c, 0 0 40px #ff003c;
    --glow-blue: 0 0 10px #00d4ff, 0 0 20px #00d4ff, 0 0 40px #00d4ff;
    --glow-yellow: 0 0 10px #ffe600, 0 0 20px #ffe600;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark-bg);
    font-family: 'Orbitron', monospace;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
  }

  #gameContainer {
    position: relative;
    width: 900px;
    height: 600px;
    background: var(--dark-bg);
    border: 2px solid var(--neon-blue);
    box-shadow: var(--glow-blue), inset 0 0 50px rgba(0,212,255,0.05);
    overflow: hidden;
  }

  /* ===== SCREENS ===== */
  .screen {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  /* ===== TITLE SCREEN ===== */
  #titleScreen {
    background: radial-gradient(ellipse at center, #0a0a2e 0%, #050510 70%);
  }

  .title-bg-grid {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image:
      linear-gradient(rgba(0,212,255,0.08) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.08) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridScroll 8s linear infinite;
  }

  @keyframes gridScroll {
    0% { transform: translateY(0); }
    100% { transform: translateY(40px); }
  }

  .game-logo {
    font-size: 72px;
    font-weight: 900;
    letter-spacing: 8px;
    color: white;
    text-shadow: var(--glow-blue), 0 0 60px rgba(0,212,255,0.5);
    animation: logoFlicker 3s ease-in-out infinite;
    z-index: 1;
    line-height: 1;
  }

  .game-logo span {
    color: var(--neon-red);
    text-shadow: var(--glow-red), 0 0 60px rgba(255,0,60,0.5);
  }

  @keyframes logoFlicker {
    0%, 90%, 100% { opacity: 1; }
    92% { opacity: 0.8; }
    94% { opacity: 1; }
    96% { opacity: 0.7; }
  }

  .logo-subtitle {
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    letter-spacing: 12px;
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow);
    margin-top: 8px;
    z-index: 1;
  }

  .title-buttons {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 50px;
    z-index: 1;
  }

  .btn-neon {
    padding: 14px 50px;
    background: transparent;
    border: 2px solid var(--neon-blue);
    color: var(--neon-blue);
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 4px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
  }

  .btn-neon::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0,212,255,0.2), transparent);
    transition: left 0.4s;
  }

  .btn-neon:hover::before { left: 100%; }

  .btn-neon:hover {
    background: rgba(0,212,255,0.15);
    box-shadow: var(--glow-blue);
    color: white;
    transform: scale(1.03);
  }

  .btn-neon.red {
    border-color: var(--neon-red);
    color: var(--neon-red);
  }
  .btn-neon.red:hover {
    background: rgba(255,0,60,0.15);
    box-shadow: var(--glow-red);
  }

  .controls-hint {
    position: absolute;
    bottom: 20px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    letter-spacing: 3px;
    z-index: 1;
  }

  /* ===== MULTIPLAYER & COMPETITIVE SCREENS ===== */
  .mp-screen {
    background: radial-gradient(ellipse at 50% 30%, #080820 0%, #050510 70%);
    padding: 20px;
  }
  .mp-title {
    font-size: 22px;
    font-weight: 900;
    letter-spacing: 8px;
    margin-bottom: 6px;
  }
  .mp-subtitle {
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    letter-spacing: 4px;
    color: rgba(255,255,255,0.4);
    margin-bottom: 20px;
  }
  .mp-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    width: 100%;
    max-width: 820px;
  }
  .mp-panel {
    border: 1px solid rgba(255,255,255,0.1);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: rgba(5,5,20,0.6);
  }
  .mp-panel-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 4px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .mp-panel-title.blue { color: var(--neon-blue); text-shadow: var(--glow-blue); border-color: rgba(0,212,255,0.2); }
  .mp-panel-title.red  { color: var(--neon-red);  text-shadow: var(--glow-red);  border-color: rgba(255,0,60,0.2); }
  .mp-panel-title.yellow { color: var(--neon-yellow); text-shadow: var(--glow-yellow); border-color: rgba(255,230,0,0.2); }
  .mp-panel-title.green { color: var(--neon-green); text-shadow: 0 0 10px #00ff88; border-color: rgba(0,255,136,0.2); }

  /* Input fields */
  .mp-input {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    padding: 8px 12px;
    outline: none;
    width: 100%;
    transition: border-color .2s;
    letter-spacing: 2px;
  }
  .mp-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 8px rgba(0,212,255,0.3); }
  .mp-input-label {
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    letter-spacing: 2px;
    margin-bottom: 3px;
  }

  /* Room list */
  .room-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .room-list::-webkit-scrollbar { width: 3px; }
  .room-list::-webkit-scrollbar-thumb { background: var(--neon-blue); }
  .room-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border: 1px solid rgba(255,255,255,0.08);
    cursor: pointer;
    transition: all .18s;
    background: rgba(0,0,0,0.3);
  }
  .room-item:hover { border-color: var(--neon-yellow); background: rgba(255,230,0,0.05); }
  .room-item-info { display: flex; flex-direction: column; gap: 2px; }
  .room-item-id { font-size: 11px; font-weight: 700; color: var(--neon-blue); letter-spacing: 2px; }
  .room-item-players { font-family: 'Rajdhani', sans-serif; font-size: 10px; color: rgba(255,255,255,0.5); letter-spacing: 1px; }
  .room-item-badge {
    font-family: 'Rajdhani', sans-serif;
    font-size: 9px;
    padding: 2px 8px;
    border: 1px solid;
    letter-spacing: 1px;
  }
  .room-item-badge.open { color: var(--neon-green); border-color: var(--neon-green); }
  .room-item-badge.locked { color: var(--neon-yellow); border-color: var(--neon-yellow); }
  .room-empty {
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    color: rgba(255,255,255,0.25);
    text-align: center;
    padding: 20px;
    letter-spacing: 2px;
  }

  /* Competitive / ELO */
  .rank-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border: 1px solid;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 3px;
  }
  .elo-display {
    font-size: 32px;
    font-weight: 900;
    letter-spacing: 4px;
    line-height: 1;
  }
  .rank-progress-bg {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.1);
    margin-top: 4px;
  }
  .rank-progress-fill {
    height: 100%;
    transition: width .6s ease-out;
  }
  .queue-status {
    text-align: center;
    padding: 14px;
    border: 1px solid rgba(255,230,0,0.3);
    background: rgba(255,230,0,0.04);
  }
  .queue-dots {
    display: inline-flex;
    gap: 6px;
    margin-top: 8px;
  }
  .queue-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--neon-yellow);
    animation: queuePulse 1.2s ease-in-out infinite;
  }
  .queue-dot:nth-child(2) { animation-delay: .2s; }
  .queue-dot:nth-child(3) { animation-delay: .4s; }
  @keyframes queuePulse { 0%,80%,100%{opacity:.3;transform:scale(.8)} 40%{opacity:1;transform:scale(1.2)} }

  /* Leaderboard */
  .leaderboard-list {
    display: flex;
    flex-direction: column;
    gap: 3px;
    max-height: 220px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .leaderboard-list::-webkit-scrollbar { width: 3px; }
  .leaderboard-list::-webkit-scrollbar-thumb { background: var(--neon-yellow); }
  .lb-row {
    display: grid;
    grid-template-columns: 24px 1fr 80px 60px;
    align-items: center;
    gap: 8px;
    padding: 5px 8px;
    border: 1px solid rgba(255,255,255,0.05);
    font-size: 10px;
    transition: background .15s;
  }
  .lb-row:hover { background: rgba(255,255,255,0.04); }
  .lb-row.me { border-color: rgba(255,230,0,0.4); background: rgba(255,230,0,0.04); }
  .lb-pos { color: rgba(255,255,255,0.4); font-family: 'Rajdhani', sans-serif; text-align: center; }
  .lb-name { font-weight: 700; letter-spacing: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .lb-elo { font-family: 'Rajdhani', sans-serif; font-size: 11px; color: var(--neon-yellow); text-align: right; }
  .lb-rank { font-family: 'Rajdhani', sans-serif; font-size: 9px; text-align: right; }

  /* Connection / Match found overlay */
  .overlay-screen {
    position: absolute;
    inset: 0;
    background: rgba(5,5,16,0.94);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 500;
    gap: 16px;
  }
  .overlay-screen.active { display: flex; }
  .match-found-title {
    font-size: 36px;
    font-weight: 900;
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow);
    letter-spacing: 6px;
    animation: matchPulse 1s ease-in-out infinite alternate;
  }
  @keyframes matchPulse { from{text-shadow:var(--glow-yellow)} to{text-shadow:var(--glow-yellow),0 0 60px rgba(255,230,0,.6)} }
  .match-vs-row {
    display: flex;
    align-items: center;
    gap: 24px;
  }
  .match-player-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    min-width: 180px;
  }
  .match-player-name { font-size: 18px; font-weight: 900; letter-spacing: 4px; }
  .match-timer-bar {
    width: 300px;
    height: 4px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
  }
  .match-timer-fill {
    height: 100%;
    background: var(--neon-yellow);
    box-shadow: var(--glow-yellow);
    transition: width .1s linear;
  }
  .countdown-num {
    font-size: 64px;
    font-weight: 900;
    color: white;
    text-shadow: 0 0 20px white;
    animation: cntAnim .8s ease-out;
  }
  @keyframes cntAnim { from{transform:scale(1.4);opacity:0} to{transform:scale(1);opacity:1} }

  /* Online status indicator */
  .online-dot {
    display: inline-block;
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--neon-green);
    box-shadow: 0 0 6px var(--neon-green);
    animation: onlinePulse 2s ease-in-out infinite;
  }
  .online-dot.offline { background: var(--neon-red); box-shadow: 0 0 6px var(--neon-red); animation: none; }
  @keyframes onlinePulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  .ws-status {
    position: absolute;
    top: 8px;
    right: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 9px;
    letter-spacing: 2px;
    color: rgba(255,255,255,0.4);
    z-index: 600;
  }

  /* Chat */
  .chat-box {
    display: flex;
    flex-direction: column;
    gap: 4px;
    height: 100px;
    overflow-y: auto;
    padding: 6px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.06);
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
  }
  .chat-box::-webkit-scrollbar { width: 3px; }
  .chat-box::-webkit-scrollbar-thumb { background: var(--neon-blue); }
  .chat-msg { line-height: 1.4; }
  .chat-name { color: var(--neon-blue); font-weight: 700; margin-right: 4px; }
  .chat-name.you { color: var(--neon-yellow); }
  .chat-sys { color: rgba(255,255,255,0.3); font-style: italic; }
  .chat-input-row { display: flex; gap: 6px; }
  .chat-input {
    flex: 1;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.12);
    color: #fff;
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    padding: 5px 8px;
    outline: none;
  }
  .chat-input:focus { border-color: var(--neon-blue); }

  /* ELO result overlay */
  .elo-result {
    position: absolute;
    inset: 0;
    background: rgba(5,5,16,.96);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 600;
    gap: 12px;
  }
  .elo-result.active { display: flex; }
  .elo-change {
    font-size: 52px;
    font-weight: 900;
    letter-spacing: 4px;
  }
  .elo-change.gain { color: var(--neon-green); text-shadow: 0 0 20px var(--neon-green); }
  .elo-change.loss { color: var(--neon-red); text-shadow: var(--glow-red); }
  .rank-up-anim {
    font-size: 28px;
    font-weight: 900;
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow);
    animation: rankUp 1s ease-out infinite alternate;
  }
  @keyframes rankUp { from{transform:scale(1)} to{transform:scale(1.06)} }

  /* Spectator bar */
  .spectator-bar {
    position: absolute;
    top: 90px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--neon-purple);
    z-index: 50;
    pointer-events: none;
  }

  /* Ping display */
  .ping-display {
    position: absolute;
    bottom: 26px;
    right: 10px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 9px;
    letter-spacing: 2px;
    color: rgba(255,255,255,0.3);
    z-index: 50;
    pointer-events: none;
  }
  .ping-display.good { color: var(--neon-green); }
  .ping-display.medium { color: var(--neon-yellow); }
  .ping-display.bad { color: var(--neon-red); }

  /* ===== CHARACTER SELECT ===== */
  #selectScreen {
    background: linear-gradient(180deg, #050510 0%, #0a0520 100%);
  }

  .select-title {
    font-size: 22px;
    letter-spacing: 8px;
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow);
    margin-bottom: 30px;
  }

  .char-select-grid {
    display: flex;
    gap: 30px;
    z-index: 1;
  }

  .char-panel {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .char-panel-title {
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--neon-blue);
    text-shadow: var(--glow-blue);
  }

  .char-panel-title.p2 { color: var(--neon-red); text-shadow: var(--glow-red); }

  .char-cards {
    display: flex;
    gap: 12px;
  }

  .char-card {
    width: 110px;
    height: 140px;
    border: 2px solid rgba(255,255,255,0.2);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    padding-bottom: 10px;
  }

  .char-card:hover {
    border-color: var(--neon-yellow);
    box-shadow: 0 0 15px rgba(255,230,0,0.5);
    transform: translateY(-4px);
  }

  .char-card.selected-p1 {
    border-color: var(--neon-blue);
    box-shadow: var(--glow-blue);
  }

  .char-card.selected-p2 {
    border-color: var(--neon-red);
    box-shadow: var(--glow-red);
  }

  .char-card-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
  }

  .char-card-name {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    color: white;
    z-index: 1;
    text-shadow: 0 0 10px rgba(0,0,0,1);
  }

  .char-card-type {
    font-family: 'Rajdhani', sans-serif;
    font-size: 9px;
    color: rgba(255,255,255,0.6);
    z-index: 1;
    letter-spacing: 1px;
  }

  .select-preview {
    display: flex;
    gap: 60px;
    margin-top: 20px;
    align-items: center;
  }

  .preview-info {
    text-align: center;
    width: 150px;
  }

  .preview-name {
    font-size: 18px;
    font-weight: 900;
    color: white;
    letter-spacing: 3px;
  }

  .preview-name.p1 { color: var(--neon-blue); text-shadow: var(--glow-blue); }
  .preview-name.p2 { color: var(--neon-red); text-shadow: var(--glow-red); }

  .preview-stats {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .stat-bar-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
    color: rgba(255,255,255,0.6);
    letter-spacing: 2px;
  }

  .stat-bar-bg {
    flex: 1;
    height: 4px;
    background: rgba(255,255,255,0.1);
  }

  .stat-bar-fill {
    height: 100%;
    background: var(--neon-yellow);
    box-shadow: 0 0 5px var(--neon-yellow);
    transition: width 0.3s;
  }

  .vs-divider {
    font-size: 36px;
    font-weight: 900;
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow);
    animation: vsPulse 1s ease-in-out infinite alternate;
  }

  @keyframes vsPulse {
    from { transform: scale(1); }
    to { transform: scale(1.1); }
  }

  /* ===== GAME HUD ===== */
  #hud {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 90px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 12px 15px 0;
    z-index: 50;
    pointer-events: none;
  }

  .player-hud {
    display: flex;
    flex-direction: column;
    gap: 5px;
    width: 320px;
  }

  .player-hud.p2 { align-items: flex-end; }

  .player-name-display {
    font-size: 11px;
    letter-spacing: 3px;
    font-weight: 700;
  }

  .player-name-display.p1 { color: var(--neon-blue); text-shadow: var(--glow-blue); }
  .player-name-display.p2 { color: var(--neon-red); text-shadow: var(--glow-red); }

  .health-bar-container {
    width: 100%;
    height: 18px;
    background: rgba(0,0,0,0.8);
    border: 1px solid rgba(255,255,255,0.15);
    position: relative;
    overflow: hidden;
  }

  .health-bar-bg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,0,0,0.3);
  }

  .health-bar-fill {
    position: absolute;
    top: 0;
    height: 100%;
    transition: width 0.15s ease-out;
  }

  .health-bar-fill.p1 {
    left: 0;
    background: linear-gradient(90deg, #00ff88, #00d4ff);
    box-shadow: 0 0 8px rgba(0,212,255,0.8);
  }

  .health-bar-fill.p2 {
    right: 0;
    background: linear-gradient(270deg, #ff003c, #ff7700);
    box-shadow: 0 0 8px rgba(255,0,60,0.8);
  }

  .health-bar-segments {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    pointer-events: none;
  }

  .health-segment {
    flex: 1;
    border-right: 1px solid rgba(0,0,0,0.5);
  }

  .health-text {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 1px;
    color: rgba(255,255,255,0.9);
    z-index: 2;
  }

  .super-bar-container {
    width: 100%;
    height: 8px;
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.1);
    position: relative;
  }

  .super-bar-fill {
    height: 100%;
    transition: width 0.2s;
  }

  .super-bar-fill.p1 {
    background: linear-gradient(90deg, var(--neon-yellow), var(--neon-green));
    box-shadow: 0 0 6px var(--neon-yellow);
  }

  .super-bar-fill.p2 {
    float: right;
    background: linear-gradient(270deg, var(--neon-yellow), var(--neon-purple));
    box-shadow: 0 0 6px var(--neon-yellow);
  }

  .timer-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .round-display {
    font-size: 10px;
    letter-spacing: 4px;
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow);
  }

  .timer-display {
    font-size: 36px;
    font-weight: 900;
    color: white;
    text-shadow: 0 0 15px rgba(255,255,255,0.8);
    line-height: 1;
    min-width: 70px;
    text-align: center;
  }

  .timer-display.urgent {
    color: var(--neon-red);
    text-shadow: var(--glow-red);
    animation: timerUrgent 0.5s ease-in-out infinite alternate;
  }

  @keyframes timerUrgent {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
  }

  .win-dots {
    display: flex;
    gap: 5px;
  }

  .win-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    background: transparent;
  }

  .win-dot.filled.p1 {
    background: var(--neon-blue);
    box-shadow: var(--glow-blue);
    border-color: var(--neon-blue);
  }

  .win-dot.filled.p2 {
    background: var(--neon-red);
    box-shadow: var(--glow-red);
    border-color: var(--neon-red);
  }

  /* ===== CANVAS ===== */
  #gameCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
  }

  /* ===== ANNOUNCER ===== */
  #announcer {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 56px;
    font-weight: 900;
    text-align: center;
    letter-spacing: 6px;
    pointer-events: none;
    z-index: 200;
    opacity: 0;
    transition: none;
  }

  #announcer.show {
    animation: announcerAnim 1.8s ease-out forwards;
  }

  @keyframes announcerAnim {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
    15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  }

  #announcer.fight {
    color: var(--neon-yellow);
    text-shadow: var(--glow-yellow), 0 0 80px rgba(255,230,0,0.5);
  }

  #announcer.ko {
    color: var(--neon-red);
    text-shadow: var(--glow-red), 0 0 80px rgba(255,0,60,0.5);
  }

  #announcer.round {
    color: white;
    text-shadow: 0 0 20px white, 0 0 40px rgba(255,255,255,0.5);
    font-size: 36px;
  }

  #announcer.winner {
    font-size: 28px;
    line-height: 1.4;
  }

  /* ===== COMBO DISPLAY ===== */
  .combo-display {
    position: absolute;
    bottom: 100px;
    font-weight: 900;
    pointer-events: none;
    z-index: 80;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .combo-display.p1 { left: 20px; color: var(--neon-blue); text-shadow: var(--glow-blue); }
  .combo-display.p2 { right: 20px; color: var(--neon-red); text-shadow: var(--glow-red); text-align: right; }

  .combo-display.active { opacity: 1; }

  .combo-number {
    font-size: 60px;
    line-height: 1;
  }

  .combo-text {
    font-size: 14px;
    letter-spacing: 4px;
  }

  /* ===== DAMAGE NUMBERS ===== */
  .damage-number {
    position: absolute;
    font-size: 22px;
    font-weight: 900;
    pointer-events: none;
    z-index: 90;
    animation: floatUp 0.8s ease-out forwards;
    font-family: 'Orbitron', monospace;
  }

  .damage-number.normal { color: var(--neon-yellow); text-shadow: var(--glow-yellow); }
  .damage-number.crit { color: var(--neon-red); text-shadow: var(--glow-red); font-size: 30px; }
  .damage-number.super { color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple), 0 0 20px var(--neon-purple); font-size: 36px; }

  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    50% { opacity: 1; transform: translateY(-40px) scale(1.1); }
    100% { opacity: 0; transform: translateY(-80px) scale(0.8); }
  }

  /* ===== RESULT SCREEN ===== */
  #resultScreen {
    background: rgba(5,5,16,0.97);
    display: none;
    z-index: 300;
  }

  .result-title {
    font-size: 48px;
    font-weight: 900;
    letter-spacing: 6px;
    animation: resultPulse 1.5s ease-in-out infinite alternate;
  }

  @keyframes resultPulse {
    from { text-shadow: 0 0 20px currentColor; }
    to { text-shadow: 0 0 40px currentColor, 0 0 80px currentColor; }
  }

  .result-winner-name {
    font-size: 28px;
    letter-spacing: 8px;
    margin-top: 10px;
    font-family: 'Rajdhani', sans-serif;
    color: rgba(255,255,255,0.8);
  }

  .result-buttons {
    display: flex;
    gap: 20px;
    margin-top: 40px;
  }

  /* ===== MOVE LIST ===== */
  #moveList {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 30px;
    z-index: 50;
    pointer-events: none;
    opacity: 0.7;
  }

  .move-hint {
    font-family: 'Rajdhani', sans-serif;
    font-size: 9px;
    letter-spacing: 1px;
    text-align: center;
    color: rgba(255,255,255,0.5);
  }

  .move-key {
    display: inline-block;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 1px 4px;
    font-size: 8px;
    border-radius: 2px;
  }

  /* ===== PAUSE SCREEN ===== */
  #pauseScreen {
    background: rgba(5,5,16,0.92);
    display: none;
    z-index: 250;
  }

  .pause-title {
    font-size: 42px;
    font-weight: 900;
    letter-spacing: 8px;
    color: white;
    text-shadow: 0 0 20px rgba(255,255,255,0.5);
  }

  /* ===== SCANLINES ===== */
  .scanlines {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  .vignette {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
    z-index: 999;
  }

  /* ===== DECORATIVE CORNERS ===== */
  .corner {
    position: absolute;
    width: 20px;
    height: 20px;
    z-index: 60;
  }
  .corner.tl { top: 5px; left: 5px; border-top: 2px solid var(--neon-blue); border-left: 2px solid var(--neon-blue); }
  .corner.tr { top: 5px; right: 5px; border-top: 2px solid var(--neon-red); border-right: 2px solid var(--neon-red); }
  .corner.bl { bottom: 5px; left: 5px; border-bottom: 2px solid var(--neon-blue); border-left: 2px solid var(--neon-blue); }
  .corner.br { bottom: 5px; right: 5px; border-bottom: 2px solid var(--neon-red); border-right: 2px solid var(--neon-red); }

  /* ===== SCREEN FLASH ===== */
  #screenFlash {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 500;
    opacity: 0;
    transition: opacity 0.05s;
  }

  /* ===== MOBILE CONTROLS ===== */
  #mobileHint {
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 3px;
    z-index: 50;
    pointer-events: none;
  }

  #modeDisplay {
    position: absolute;
    top: 95px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Rajdhani', sans-serif;
    font-size: 10px;
    letter-spacing: 4px;
    color: rgba(255,255,255,0.3);
    z-index: 50;
    pointer-events: none;
  }
</style>
</head>
<body>

<div id="gameContainer">
  <!-- Scanlines & Vignette -->
  <div class="scanlines"></div>
  <div class="vignette"></div>
  <div class="corner tl"></div>
  <div class="corner tr"></div>
  <div class="corner bl"></div>
  <div class="corner br"></div>

  <!-- Screen Flash -->
  <div id="screenFlash"></div>

  <!-- Canvas -->
  <canvas id="gameCanvas" width="900" height="600"></canvas>

  <!-- HUD -->
  <div id="hud" style="display:none">
    <!-- P1 -->
    <div class="player-hud p1">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div class="player-name-display p1" id="p1Name">KIRA</div>
        <div class="win-dots" id="p1WinDots">
          <div class="win-dot" id="p1d1"></div>
          <div class="win-dot" id="p1d2"></div>
        </div>
      </div>
      <div class="health-bar-container">
        <div class="health-bar-bg"></div>
        <div class="health-bar-fill p1" id="p1HealthBar" style="width:100%"></div>
        <div class="health-text" id="p1HealthText">100</div>
      </div>
      <div class="super-bar-container">
        <div class="super-bar-fill p1" id="p1SuperBar" style="width:0%"></div>
      </div>
    </div>

    <!-- Timer -->
    <div class="timer-box">
      <div class="round-display" id="roundDisplay">ROUND 1</div>
      <div class="timer-display" id="timerDisplay">99</div>
    </div>

    <!-- P2 -->
    <div class="player-hud p2">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div class="win-dots" id="p2WinDots">
          <div class="win-dot" id="p2d1"></div>
          <div class="win-dot" id="p2d2"></div>
        </div>
        <div class="player-name-display p2" id="p2Name">VIPER</div>
      </div>
      <div class="health-bar-container">
        <div class="health-bar-bg"></div>
        <div class="health-bar-fill p2" id="p2HealthBar" style="width:100%"></div>
        <div class="health-text" id="p2HealthText">100</div>
      </div>
      <div class="super-bar-container">
        <div class="super-bar-fill p2" id="p2SuperBar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- Mode Display -->
  <div id="modeDisplay" style="display:none"></div>

  <!-- Announcer -->
  <div id="announcer"></div>

  <!-- Combo Displays -->
  <div class="combo-display p1" id="combo1">
    <div class="combo-number" id="combo1Num">0</div>
    <div class="combo-text">COMBO</div>
  </div>
  <div class="combo-display p2" id="combo2">
    <div class="combo-number" id="combo2Num">0</div>
    <div class="combo-text">COMBO</div>
  </div>

  <!-- Move hints -->
  <div id="moveList" style="display:none">
    <div class="move-hint">
      P1: <span class="move-key">A/D</span>MOVE <span class="move-key">W</span>JUMP 
      <span class="move-key">S</span>DUCK <span class="move-key">F</span>PUNCH 
      <span class="move-key">G</span>KICK <span class="move-key">H</span>SPECIAL
    </div>
    <div class="move-hint">
      P2: <span class="move-key">‚Üê/‚Üí</span>MOVE <span class="move-key">‚Üë</span>JUMP 
      <span class="move-key">‚Üì</span>DUCK <span class="move-key">1</span>PUNCH 
      <span class="move-key">2</span>KICK <span class="move-key">3</span>SPECIAL
    </div>
  </div>

  <!-- WS Status -->
  <div class="ws-status" id="wsStatus" style="display:none">
    <span class="online-dot offline" id="wsDot"></span>
    <span id="wsLabel">DESCONECTADO</span>
    <span id="pingLabel" class="ping-display" style="position:static;margin-left:6px"></span>
  </div>

  <!-- Ping display in-game -->
  <div class="ping-display" id="pingDisplay" style="display:none">PING: --ms</div>

  <!-- Spectator label -->
  <div class="spectator-bar" id="spectatorBar" style="display:none">üëÅ MODO ESPECTADOR</div>

  <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
  <!-- ‚ïë      MULTIPLAYER SCREEN              ‚ïë -->
  <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
  <div class="screen mp-screen" id="multiplayerScreen" style="display:none">
    <div class="mp-title" style="color:var(--neon-green);text-shadow:0 0 10px #00ff88,0 0 25px #00ff88">MULTIJUGADOR</div>
    <div class="mp-subtitle">JUEGA EN L√çNEA CON AMIGOS EN TIEMPO REAL</div>

    <div class="mp-layout">
      <!-- Left: Profile & Create -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <!-- Identity panel -->
        <div class="mp-panel">
          <div class="mp-panel-title green">üë§ TU PERFIL</div>
          <div>
            <div class="mp-input-label">NOMBRE DE JUGADOR</div>
            <input class="mp-input" id="mpUsername" placeholder="Tu nombre..." maxlength="20">
          </div>
          <button class="btn-neon" style="border-color:var(--neon-green);color:var(--neon-green)" onclick="mpIdentify()">CONECTAR AL SERVIDOR</button>
          <div style="display:flex;align-items:center;gap:8px;font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.4)">
            <span class="online-dot offline" id="mpDot"></span>
            <span id="mpConnStatus">Sin conexi√≥n</span>
            <span style="margin-left:auto;color:rgba(255,255,255,0.25)" id="mpOnlineCount"></span>
          </div>
        </div>

        <!-- Create room -->
        <div class="mp-panel">
          <div class="mp-panel-title blue">‚ûï CREAR SALA</div>
          <div>
            <div class="mp-input-label">CONTRASE√ëA (OPCIONAL)</div>
            <input class="mp-input" id="mpRoomPass" placeholder="Dejar vac√≠o = p√∫blica" maxlength="20">
          </div>
          <button class="btn-neon" id="mpCreateBtn" onclick="mpCreateRoom()" disabled>CREAR SALA</button>
          <div id="mpRoomCode" style="font-family:'Rajdhani';font-size:11px;color:rgba(255,255,255,0.4);display:none">
            C√ìDIGO: <span id="mpRoomCodeVal" style="color:var(--neon-yellow);font-weight:700;letter-spacing:3px"></span>
            <button onclick="mpCopyCode()" style="background:none;border:none;color:var(--neon-blue);cursor:pointer;font-size:10px;margin-left:6px">üìã COPIAR</button>
          </div>
        </div>

        <!-- Join room -->
        <div class="mp-panel">
          <div class="mp-panel-title red">üîó UNIRSE A SALA</div>
          <div>
            <div class="mp-input-label">C√ìDIGO DE SALA</div>
            <input class="mp-input" id="mpJoinCode" placeholder="Ej: A3F7B2" maxlength="10" style="text-transform:uppercase">
          </div>
          <div>
            <div class="mp-input-label">CONTRASE√ëA (SI TIENE)</div>
            <input class="mp-input" id="mpJoinPass" placeholder="">
          </div>
          <button class="btn-neon red" id="mpJoinBtn" onclick="mpJoinRoom()" disabled>UNIRSE</button>
        </div>
      </div>

      <!-- Right: Room list + Chat -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <!-- Room list -->
        <div class="mp-panel" style="flex:1">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="mp-panel-title blue" style="border:none;padding:0">üìã SALAS P√öBLICAS</div>
            <button class="btn-neon" style="font-size:9px;padding:4px 12px" onclick="mpRefreshRooms()">‚Üª</button>
          </div>
          <div class="room-list" id="mpRoomList">
            <div class="room-empty">Sin salas disponibles. ¬°Crea una!</div>
          </div>
        </div>

        <!-- Waiting / in-room status -->
        <div class="mp-panel" id="mpRoomStatus" style="display:none">
          <div class="mp-panel-title yellow">‚è≥ SALA ACTIVA</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;justify-content:space-between;font-family:'Rajdhani';font-size:11px">
              <span>T√ö: <span id="mpMyName" style="color:var(--neon-blue);font-weight:700"></span></span>
              <span>RIVAL: <span id="mpOpponentName" style="color:var(--neon-red)">Esperando...</span></span>
            </div>
            <div style="display:flex;gap:6px">
              <button class="btn-neon" style="border-color:var(--neon-yellow);color:var(--neon-yellow);flex:1;font-size:10px" id="mpReadyBtn" onclick="mpReady()" disabled>‚úì LISTO</button>
              <button class="btn-neon red" style="font-size:10px" onclick="mpLeaveRoom()">‚Üê SALIR</button>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="mp-panel">
          <div class="mp-panel-title" style="color:rgba(255,255,255,0.5)">üí¨ CHAT</div>
          <div class="chat-box" id="mpChatBox"></div>
          <div class="chat-input-row">
            <input class="chat-input" id="mpChatInput" placeholder="Mensaje..." maxlength="100" onkeydown="if(event.key==='Enter')mpSendChat()">
            <button class="btn-neon" style="font-size:9px;padding:5px 12px" onclick="mpSendChat()">‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <button class="btn-neon red" style="margin-top:12px;font-size:11px" onclick="showTitle()">‚Üê VOLVER AL MEN√ö</button>
  </div>

  <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
  <!-- ‚ïë      COMPETITIVE SCREEN              ‚ïë -->
  <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
  <div class="screen mp-screen" id="competitiveScreen" style="display:none">
    <div class="mp-title" style="color:var(--neon-yellow);text-shadow:0 0 10px #ffe600,0 0 25px #ffe600">MODO COMPETITIVO</div>
    <div class="mp-subtitle">SISTEMA DE RANGOS ELO ‚Äî DEMUESTRA TU VAL√çA</div>

    <div class="mp-layout">
      <!-- Left: ELO & Stats -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <!-- ELO card -->
        <div class="mp-panel">
          <div class="mp-panel-title yellow">üèÜ TU RANGO</div>
          <div style="display:flex;align-items:center;gap:16px">
            <div>
              <div id="compRankIcon" style="font-size:40px;line-height:1">ü•â</div>
            </div>
            <div style="flex:1">
              <div class="rank-badge" id="compRankBadge" style="color:#cd7f32;border-color:#cd7f32;margin-bottom:4px">
                <span id="compRankName">BRONCE</span>
              </div>
              <div class="elo-display" id="compEloNum" style="color:var(--neon-yellow);text-shadow:var(--glow-yellow)">800</div>
              <div style="font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.35);margin-top:2px">PUNTOS ELO</div>
            </div>
          </div>
          <div class="rank-progress-bg">
            <div class="rank-progress-fill" id="compRankProgress" style="width:0%;background:var(--neon-yellow);box-shadow:0 0 5px var(--neon-yellow)"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.3);margin-top:2px">
            <span id="compRankMin">0 ELO</span>
            <span id="compRankNext">Pr√≥ximo rango: 800 ELO</span>
          </div>
        </div>

        <!-- Stats -->
        <div class="mp-panel">
          <div class="mp-panel-title yellow">üìä ESTAD√çSTICAS</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div style="text-align:center;padding:8px;border:1px solid rgba(255,255,255,0.06)">
              <div style="font-size:22px;font-weight:900;color:var(--neon-green)" id="compWins">0</div>
              <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px">VICTORIAS</div>
            </div>
            <div style="text-align:center;padding:8px;border:1px solid rgba(255,255,255,0.06)">
              <div style="font-size:22px;font-weight:900;color:var(--neon-red)" id="compLosses">0</div>
              <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px">DERROTAS</div>
            </div>
            <div style="text-align:center;padding:8px;border:1px solid rgba(255,255,255,0.06)">
              <div style="font-size:22px;font-weight:900;color:var(--neon-blue)" id="compWinRate">--</div>
              <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px">WIN RATE</div>
            </div>
            <div style="text-align:center;padding:8px;border:1px solid rgba(255,255,255,0.06)">
              <div style="font-size:22px;font-weight:900;color:var(--neon-yellow)" id="compStreak">0</div>
              <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px">RACHA</div>
            </div>
          </div>
        </div>

        <!-- Rank tiers visual -->
        <div class="mp-panel">
          <div class="mp-panel-title" style="color:rgba(255,255,255,0.5)">üéñ TODOS LOS RANGOS</div>
          <div id="rankTiersList" style="display:flex;flex-direction:column;gap:4px"></div>
        </div>
      </div>

      <!-- Right: Queue + Leaderboard -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <!-- Identity for comp -->
        <div class="mp-panel">
          <div class="mp-panel-title yellow">üë§ IDENTIFICARSE</div>
          <div style="display:flex;gap:8px">
            <input class="mp-input" id="compUsername" placeholder="Tu nombre..." maxlength="20" style="flex:1">
            <button class="btn-neon" style="border-color:var(--neon-yellow);color:var(--neon-yellow);font-size:10px;white-space:nowrap" onclick="compIdentify()">ENTRAR</button>
          </div>
          <div style="display:flex;align-items:center;gap:8px;font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.4)">
            <span class="online-dot offline" id="compDot"></span>
            <span id="compConnStatus">Sin conexi√≥n</span>
          </div>
        </div>

        <!-- Queue -->
        <div class="mp-panel">
          <div class="mp-panel-title yellow">‚öî BUSCAR PARTIDA</div>
          <div id="compQueueSection">
            <div style="font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:8px;letter-spacing:1px">
              El sistema busca un rival con ELO similar (¬±400 pts). El rango de b√∫squeda se expande si tardas.
            </div>
            <button class="btn-neon" style="border-color:var(--neon-yellow);color:var(--neon-yellow);width:100%" id="compSearchBtn" onclick="compSearch()" disabled>üîç BUSCAR PARTIDA</button>
          </div>
          <div class="queue-status" id="compQueueStatus" style="display:none">
            <div style="font-size:12px;font-weight:700;letter-spacing:4px;color:var(--neon-yellow)">BUSCANDO RIVAL...</div>
            <div style="font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px">Jugadores en cola: <span id="compQueueCount">1</span></div>
            <div style="font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.4)">Tiempo estimado: <span id="compQueueEta">~30s</span></div>
            <div class="queue-dots"><div class="queue-dot"></div><div class="queue-dot"></div><div class="queue-dot"></div></div>
            <button class="btn-neon red" style="font-size:10px;margin-top:10px;padding:6px 20px" onclick="compCancelSearch()">‚úñ CANCELAR</button>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="mp-panel" style="flex:1">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="mp-panel-title yellow" style="border:none;padding:0">üèÖ TOP JUGADORES</div>
            <button class="btn-neon" style="font-size:9px;padding:4px 12px" onclick="compLoadLeaderboard()">‚Üª</button>
          </div>
          <div class="leaderboard-list" id="compLeaderboard">
            <div class="room-empty">Con√©ctate para ver el ranking</div>
          </div>
        </div>
      </div>
    </div>

    <button class="btn-neon red" style="margin-top:12px;font-size:11px" onclick="showTitle()">‚Üê VOLVER AL MEN√ö</button>
  </div>

  <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
  <!-- ‚ïë   MATCH FOUND OVERLAY             ‚ïë -->
  <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
  <div class="overlay-screen" id="matchFoundOverlay">
    <div class="match-found-title">¬°PARTIDA ENCONTRADA!</div>
    <div class="match-vs-row">
      <div class="match-player-info">
        <div class="match-player-name" id="mfP1Name" style="color:var(--neon-blue)">---</div>
        <div class="rank-badge" id="mfP1Rank" style="font-size:10px">BRONCE</div>
        <div style="font-family:'Rajdhani';font-size:13px;color:rgba(255,255,255,0.5)">ELO: <span id="mfP1Elo">800</span></div>
      </div>
      <div style="font-size:38px;font-weight:900;color:var(--neon-yellow);text-shadow:var(--glow-yellow)">VS</div>
      <div class="match-player-info">
        <div class="match-player-name" id="mfP2Name" style="color:var(--neon-red)">---</div>
        <div class="rank-badge" id="mfP2Rank" style="font-size:10px">BRONCE</div>
        <div style="font-family:'Rajdhani';font-size:13px;color:rgba(255,255,255,0.5)">ELO: <span id="mfP2Elo">800</span></div>
      </div>
    </div>
    <div style="font-family:'Rajdhani';font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:3px">PREPARANDO PARTIDA...</div>
    <div class="match-timer-bar"><div class="match-timer-fill" id="mfTimerFill" style="width:100%"></div></div>
    <div class="countdown-num" id="mfCountdown">8</div>
  </div>

  <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
  <!-- ‚ïë   ELO RESULT OVERLAY              ‚ïë -->
  <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
  <div class="elo-result" id="eloResultOverlay">
    <div style="font-size:14px;letter-spacing:8px;color:rgba(255,255,255,0.5)">RESULTADO COMPETITIVO</div>
    <div style="font-size:28px;font-weight:900;letter-spacing:4px" id="eloResWinner">---</div>
    <div class="elo-change" id="eloResChange">+0</div>
    <div style="font-family:'Rajdhani';font-size:14px;color:rgba(255,255,255,0.5)" id="eloResNewElo"></div>
    <div class="rank-badge" id="eloResRank" style="margin-top:6px">---</div>
    <div class="rank-up-anim" id="eloRankUp" style="display:none">üéâ ¬°SUBISTE DE RANGO! üéâ</div>
    <div style="display:flex;gap:12px;margin-top:16px">
      <button class="btn-neon yellow" onclick="compSearchAgain()">‚Üª BUSCAR OTRA</button>
      <button class="btn-neon red" onclick="showTitle()">‚åÇ MEN√ö</button>
    </div>
  </div>
    <div class="title-bg-grid"></div>
    <div class="game-logo">NEON<span>CLASH</span></div>
    <div class="logo-subtitle">ULTIMATE FIGHTING</div>
    <div class="title-buttons">
      <button class="btn-neon" onclick="startGame('pvp')">‚öî 2 JUGADORES</button>
      <button class="btn-neon" onclick="startGame('pve')">ü§ñ VS CPU</button>
      <button class="btn-neon" style="border-color:var(--neon-green);color:var(--neon-green)" onclick="showMultiplayer()">üåê MULTIJUGADOR</button>
      <button class="btn-neon" style="border-color:var(--neon-yellow);color:var(--neon-yellow)" onclick="showCompetitive()">üèÜ COMPETITIVO</button>
      <button class="btn-neon red" onclick="showControls()">üìã CONTROLES</button>
    </div>
    <div class="controls-hint">PRESIONA ENTER PARA COMENZAR</div>
  </div>

  <!-- CHARACTER SELECT SCREEN -->
  <div class="screen" id="selectScreen" style="display:none">
    <div class="select-title">SELECCIONA TU LUCHADOR</div>
    <div class="char-select-grid">
      <!-- P1 -->
      <div class="char-panel">
        <div class="char-panel-title">JUGADOR 1</div>
        <div class="char-cards" id="p1Cards"></div>
      </div>
      <!-- Preview -->
      <div style="display:flex; flex-direction:column; align-items:center; gap:15px">
        <div class="select-preview">
          <div class="preview-info">
            <div class="preview-name p1" id="previewP1Name">---</div>
            <canvas id="previewP1Canvas" width="80" height="120" style="margin-top:8px"></canvas>
            <div class="preview-stats" id="previewP1Stats"></div>
          </div>
          <div class="vs-divider">VS</div>
          <div class="preview-info">
            <div class="preview-name p2" id="previewP2Name">---</div>
            <canvas id="previewP2Canvas" width="80" height="120" style="margin-top:8px"></canvas>
            <div class="preview-stats" id="previewP2Stats"></div>
          </div>
        </div>
        <button class="btn-neon" id="startFightBtn" onclick="startFight()" style="opacity:0.4; pointer-events:none">
          ‚ñ∂ PELEA
        </button>
      </div>
      <!-- P2 -->
      <div class="char-panel">
        <div class="char-panel-title p2">JUGADOR 2 / CPU</div>
        <div class="char-cards" id="p2Cards"></div>
      </div>
    </div>
    <div style="margin-top:20px">
      <button class="btn-neon red" onclick="showTitle()" style="font-size:11px; padding:10px 30px">‚Üê VOLVER</button>
    </div>
  </div>

  <!-- RESULT SCREEN -->
  <div class="screen" id="resultScreen">
    <div class="result-title" id="resultTitle" style="color:var(--neon-yellow)">GAME OVER</div>
    <div class="result-winner-name" id="resultWinner"></div>
    <div class="result-buttons">
      <button class="btn-neon" onclick="restartGame()">‚Üª REVANCHA</button>
      <button class="btn-neon red" onclick="showTitle()">‚åÇ MEN√ö</button>
    </div>
  </div>

  <!-- PAUSE SCREEN -->
  <div class="screen" id="pauseScreen">
    <div class="pause-title">PAUSA</div>
    <div class="title-buttons" style="margin-top:30px">
      <button class="btn-neon" onclick="togglePause()">‚ñ∂ CONTINUAR</button>
      <button class="btn-neon red" onclick="showTitle()">‚åÇ MEN√ö</button>
    </div>
  </div>

</div>

<script>
// ============================================================
//  NEON CLASH - 2D FIGHTING GAME
//  Full game engine with characters, physics, AI, effects
// ============================================================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// ============================================================
//  GAME STATE
// ============================================================
const GAME = {
  state: 'title',   // title | select | fighting | result | pause
  mode: 'pve',      // pvp | pve
  round: 1,
  maxRounds: 3,
  p1Wins: 0,
  p2Wins: 0,
  timer: 99,
  timerInterval: null,
  animFrame: null,
  paused: false,
  roundOver: false,
  selectedP1: null,
  selectedP2: null,
  bgFrame: 0,
  stageIndex: 0,
  combo1: 0,
  combo2: 0,
  combo1Timer: 0,
  combo2Timer: 0,
  lastTime: 0,
  dt: 0,
};

const W = 900, H = 600;
const GROUND_Y = 480;
const GRAVITY = 0.75;
const JUMP_FORCE = -16;
const MAX_HP = 100;
const TIMER_SECONDS = 99;

// ============================================================
//  AUDIO ENGINE
// ============================================================
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playSound(type) {
  try {
    const ac = getAudioCtx();
    const osc = ac.createOscillator();
    const gain = ac.createGain();
    osc.connect(gain);
    gain.connect(ac.destination);

    const sounds = {
      punch:   { type:'square',   freq:180, decay:0.12, vol:0.3,  sweep: 80  },
      kick:    { type:'sawtooth', freq:120, decay:0.15, vol:0.3,  sweep: 60  },
      block:   { type:'square',   freq:300, decay:0.08, vol:0.2,  sweep: 0   },
      jump:    { type:'sine',     freq:400, decay:0.10, vol:0.2,  sweep: 200 },
      land:    { type:'square',   freq:80,  decay:0.08, vol:0.25, sweep: 0   },
      special: { type:'sawtooth', freq:220, decay:0.4,  vol:0.4,  sweep:-100 },
      ko:      { type:'sawtooth', freq:60,  decay:0.8,  vol:0.5,  sweep: 0   },
      hit:     { type:'square',   freq:200, decay:0.1,  vol:0.35, sweep: 50  },
      super_move: { type:'sawtooth', freq:300, decay:0.5, vol:0.5, sweep: 200 },
    };

    const s = sounds[type] || sounds.punch;
    osc.type = s.type;
    osc.frequency.setValueAtTime(s.freq, ac.currentTime);
    if (s.sweep !== 0) {
      osc.frequency.linearRampToValueAtTime(s.freq + s.sweep, ac.currentTime + s.decay);
    }
    gain.gain.setValueAtTime(s.vol, ac.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + s.decay);
    osc.start(ac.currentTime);
    osc.stop(ac.currentTime + s.decay + 0.05);
  } catch(e) {}
}

// ============================================================
//  PARTICLE SYSTEM
// ============================================================
const particles = [];

function spawnParticles(x, y, color, count, type) {
  for (let i = 0; i < count; i++) {
    const angle = (Math.PI * 2 / count) * i + Math.random() * 0.5;
    const speed = 2 + Math.random() * 5;
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - (type === 'hit' ? 2 : 0),
      life: 1.0,
      decay: 0.04 + Math.random() * 0.03,
      size: type === 'sparks' ? 2 + Math.random() * 3 : 4 + Math.random() * 6,
      color,
      type: type || 'circle',
      gravity: type === 'blood' ? 0.2 : 0.05,
    });
  }
}

function spawnHitSparks(x, y, color) {
  spawnParticles(x, y, color, 12, 'sparks');
  spawnParticles(x, y, '#ffffff', 4, 'sparks');
}

function spawnKOExplosion(x, y) {
  spawnParticles(x, y, '#ff003c', 20, 'hit');
  spawnParticles(x, y, '#ff7700', 15, 'hit');
  spawnParticles(x, y, '#ffe600', 10, 'sparks');
  spawnParticles(x, y, '#ffffff', 8, 'sparks');
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += p.gravity;
    p.vx *= 0.95;
    p.life -= p.decay;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function drawParticles() {
  particles.forEach(p => {
    ctx.save();
    ctx.globalAlpha = Math.max(0, p.life);
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 6;
    if (p.type === 'sparks') {
      ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
    } else {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();
  });
}

// ============================================================
//  CHARACTER DEFINITIONS
// ============================================================
const CHARACTERS = [
  {
    id: 0,
    name: 'KIRA',
    subtitle: 'Drag√≥n de Neon',
    color: '#00d4ff',
    color2: '#0055ff',
    accent: '#00ff88',
    stats: { speed: 8, power: 7, defense: 6, special: 9 },
    hp: 100,
    speed: 4.2,
    jumpForce: -17,
    description: 'Luchadora √°gil con ataques el√©ctricos',
    specialName: 'RAY BURST',
    superName: 'THUNDER STORM',
    attackPower: { light: 8, heavy: 15, kick: 12, special: 20, super: 35 },
    hitboxW: 50, hitboxH: 100,
  },
  {
    id: 1,
    name: 'VIPER',
    subtitle: 'Serpiente de Fuego',
    color: '#ff003c',
    color2: '#ff7700',
    accent: '#ffe600',
    stats: { speed: 6, power: 9, defense: 8, special: 7 },
    hp: 110,
    speed: 3.8,
    jumpForce: -16,
    description: 'Luchador poderoso con golpes de fuego',
    specialName: 'FIRE FANG',
    superName: 'INFERNO RAGE',
    attackPower: { light: 10, heavy: 18, kick: 14, special: 22, super: 38 },
    hitboxW: 55, hitboxH: 105,
  },
  {
    id: 2,
    name: 'SHADOW',
    subtitle: 'Espectro Oscuro',
    color: '#b400ff',
    color2: '#5500aa',
    accent: '#ff00aa',
    stats: { speed: 9, power: 7, defense: 5, special: 9 },
    hp: 90,
    speed: 4.8,
    jumpForce: -18,
    description: 'Ninja veloz con ataques de sombra',
    specialName: 'VOID DASH',
    superName: 'DARK ABYSS',
    attackPower: { light: 7, heavy: 13, kick: 11, special: 18, super: 32 },
    hitboxW: 45, hitboxH: 95,
  },
  {
    id: 3,
    name: 'TITAN',
    subtitle: 'Goliat de Acero',
    color: '#aaaaaa',
    color2: '#555555',
    accent: '#00d4ff',
    stats: { speed: 4, power: 10, defense: 10, special: 6 },
    hp: 130,
    speed: 2.8,
    jumpForce: -14,
    description: 'Tanque lento pero devastador',
    specialName: 'IRON SLAM',
    superName: 'EARTHQUAKE',
    attackPower: { light: 12, heavy: 22, kick: 18, special: 26, super: 45 },
    hitboxW: 65, hitboxH: 115,
  },
];

// ============================================================
//  STAGES
// ============================================================
const STAGES = [
  {
    name: 'NEON CITY',
    bgColor1: '#050518',
    bgColor2: '#0a0a30',
    floorColor: '#0a0a20',
    floorAccent: '#00d4ff',
    accent1: '#00d4ff',
    accent2: '#ff003c',
  },
  {
    name: 'FIRE TEMPLE',
    bgColor1: '#180505',
    bgColor2: '#301005',
    floorColor: '#200808',
    floorAccent: '#ff7700',
    accent1: '#ff003c',
    accent2: '#ff7700',
  },
  {
    name: 'VOID ARENA',
    bgColor1: '#0a0015',
    bgColor2: '#150025',
    floorColor: '#100020',
    floorAccent: '#b400ff',
    accent1: '#b400ff',
    accent2: '#ff00aa',
  },
];

// ============================================================
//  FIGHTER CLASS
// ============================================================
class Fighter {
  constructor(charData, x, facingRight, playerId) {
    this.char = charData;
    this.x = x;
    this.y = GROUND_Y;
    this.vx = 0;
    this.vy = 0;
    this.facingRight = facingRight;
    this.playerId = playerId;

    this.hp = charData.hp;
    this.maxHp = charData.hp;
    this.superMeter = 0;
    this.maxSuper = 100;

    // States
    this.state = 'idle'; // idle, walk, jump, crouch, attack, block, hurt, ko, special, super
    this.stateTimer = 0;
    this.attackType = null;
    this.isBlocking = false;
    this.onGround = true;
    this.isDead = false;

    // Hit detection
    this.hitbox = { x: 0, y: 0, w: charData.hitboxW, h: charData.hitboxH };
    this.attackHitbox = null;
    this.hitActive = false;
    this.hasHit = false;

    // Visuals
    this.animFrame = 0;
    this.animTimer = 0;
    this.flashTimer = 0;
    this.shakeX = 0;
    this.w = charData.hitboxW;
    this.h = charData.hitboxH;

    // Combo
    this.combo = 0;
    this.comboTimer = 0;

    // Input
    this.keys = {};

    // AI
    this.ai = null;
    this.aiTimer = 0;
    this.aiAction = null;
    this.aiActionTimer = 0;
  }

  get centerX() { return this.x; }
  get feet() { return this.y; }
  get top() { return this.y - this.h; }
  get left() { return this.x - this.w / 2; }
  get right() { return this.x + this.w / 2; }

  updateHitbox() {
    this.hitbox.x = this.x - this.w / 2;
    this.hitbox.y = this.y - this.h;
    this.hitbox.w = this.w;
    this.hitbox.h = this.h;

    if (this.hitActive && this.stateTimer > 3) {
      const attackRange = this.facingRight ? 80 : -80;
      const atkY = this.state === 'crouch_attack' ? this.y - this.h * 0.4 : this.y - this.h * 0.7;
      this.attackHitbox = {
        x: this.facingRight ? this.x + 10 : this.x - 90,
        y: atkY - 30,
        w: 80,
        h: 60,
      };
    } else {
      this.attackHitbox = null;
    }
  }

  applyGravity() {
    if (!this.onGround) {
      this.vy += GRAVITY;
      this.y += this.vy;
      if (this.y >= GROUND_Y) {
        this.y = GROUND_Y;
        this.vy = 0;
        this.onGround = true;
        if (this.state === 'jump') {
          this.state = 'idle';
          playSound('land');
        }
      }
    }
  }

  move(dx) {
    if (this.state === 'attack' || this.state === 'hurt' || this.state === 'ko' ||
        this.state === 'special' || this.state === 'super') return;
    this.x += dx;
    this.x = Math.max(60, Math.min(W - 60, this.x));
    if (dx !== 0 && this.onGround && this.state !== 'crouch') {
      this.state = 'walk';
    }
  }

  jump() {
    if (!this.onGround) return;
    if (this.state === 'attack' || this.state === 'hurt' || this.state === 'ko') return;
    this.vy = this.char.jumpForce;
    this.onGround = false;
    this.state = 'jump';
    playSound('jump');
    spawnParticles(this.x, this.y, this.char.color, 5, 'sparks');
  }

  crouch() {
    if (this.onGround && this.state !== 'attack' && this.state !== 'hurt' && this.state !== 'ko') {
      this.state = 'crouch';
      this.isBlocking = true; // Crouching also partially blocks
    }
  }

  block() {
    if (this.onGround && this.state !== 'attack' && this.state !== 'hurt' && this.state !== 'ko') {
      this.state = 'block';
      this.isBlocking = true;
    }
  }

  attack(type) {
    if (this.state === 'hurt' || this.state === 'ko' || this.state === 'attack' ||
        this.state === 'special' || this.state === 'super') return;

    if (type === 'special' && this.superMeter < 30) return;
    if (type === 'super' && this.superMeter < this.maxSuper) return;

    this.state = type === 'super' ? 'super' :
                 type === 'special' ? 'special' : 'attack';
    this.attackType = type;
    this.stateTimer = 0;
    this.hitActive = true;
    this.hasHit = false;
    this.isBlocking = false;

    if (type === 'special') {
      this.superMeter = Math.max(0, this.superMeter - 30);
      playSound('special');
      spawnParticles(this.x, this.y - this.h * 0.6, this.char.color, 15, 'hit');
    } else if (type === 'super') {
      this.superMeter = 0;
      playSound('super_move');
      spawnKOExplosion(this.x, this.y - this.h * 0.5);
      triggerScreenShake(15, 30);
      triggerScreenFlash(this.char.color, 0.5);
    } else {
      playSound(type === 'kick' ? 'kick' : 'punch');
    }
  }

  takeDamage(amount, attackerX) {
    if (this.isDead) return;

    let actualDamage = amount;
    if (this.isBlocking) {
      actualDamage = Math.floor(amount * 0.25);
      playSound('block');
      spawnParticles(this.hitbox.x + this.hitbox.w * 0.5, this.hitbox.y + this.hitbox.h * 0.3,
        '#ffffff', 6, 'sparks');
    } else {
      playSound('hit');
      triggerScreenShake(5, 8);
    }

    this.hp = Math.max(0, this.hp - actualDamage);

    if (!this.isBlocking) {
      this.flashTimer = 8;
      const pushDir = this.x > attackerX ? 1 : -1;
      this.x += pushDir * 12;
      this.x = Math.max(60, Math.min(W - 60, this.x));

      if (this.hp <= 0) {
        this.state = 'ko';
        this.isDead = true;
        this.stateTimer = 0;
        playSound('ko');
        spawnKOExplosion(this.x, this.y - this.h * 0.5);
        triggerScreenFlash('#ff0000', 0.7);
        triggerScreenShake(20, 40);
      } else {
        this.state = 'hurt';
        this.stateTimer = 0;
      }
    }

    this.superMeter = Math.min(this.maxSuper, this.superMeter + amount * 0.5);

    return actualDamage;
  }

  update() {
    this.stateTimer++;
    this.animTimer++;

    if (this.flashTimer > 0) this.flashTimer--;

    // Combo timer
    if (this.comboTimer > 0) {
      this.comboTimer--;
      if (this.comboTimer === 0) this.combo = 0;
    }

    // Resolve attack states
    if (this.state === 'attack') {
      const duration = this.attackType === 'heavy' ? 24 : this.attackType === 'kick' ? 22 : 18;
      if (this.stateTimer >= duration) {
        this.state = 'idle';
        this.hitActive = false;
        this.attackType = null;
      }
    }

    if (this.state === 'special') {
      if (this.stateTimer >= 30) {
        this.state = 'idle';
        this.hitActive = false;
        this.attackType = null;
      }
    }

    if (this.state === 'super') {
      if (this.stateTimer >= 50) {
        this.state = 'idle';
        this.hitActive = false;
        this.attackType = null;
      }
    }

    if (this.state === 'hurt') {
      if (this.stateTimer >= 16) {
        this.state = 'idle';
      }
    }

    if (this.state === 'idle' || this.state === 'walk') {
      this.isBlocking = false;
    }

    if (this.state === 'block' && !this.keys['block']) {
      this.state = 'idle';
      this.isBlocking = false;
    }

    // Friction
    if (this.onGround && this.state !== 'walk' && this.state !== 'run') {
      this.vx *= 0.85;
      if (Math.abs(this.vx) < 0.1) this.vx = 0;
    }

    // Walk reset
    if (this.state === 'walk') {
      this.state = 'idle';
    }

    // Crouch
    if (this.state === 'crouch' && !this.keys['down']) {
      this.state = 'idle';
      this.isBlocking = false;
    }

    this.applyGravity();
    this.updateHitbox();
  }

  // Draw the fighter using canvas shapes
  draw() {
    ctx.save();
    ctx.translate(this.x + this.shakeX, 0);

    const flip = this.facingRight ? 1 : -1;
    ctx.scale(flip, 1);

    const alpha = (this.flashTimer > 0 && this.flashTimer % 3 < 2) ? 0.4 : 1.0;
    ctx.globalAlpha = alpha;

    const col = this.char.color;
    const col2 = this.char.color2;
    const acc = this.char.accent;
    const s = this.state;

    // Animation bob
    const bob = (s === 'idle') ? Math.sin(this.animTimer * 0.08) * 2 : 0;
    const groundY = this.y;
    const crouchMod = (s === 'crouch' || s === 'crouch_attack') ? 0.75 : 1.0;
    const hurtMod = (s === 'hurt') ? 1 : 0;
    const jumpOffset = !this.onGround ? -5 : 0;

    const baseY = groundY + bob + jumpOffset;

    // Body proportions
    const bodyH = this.h * crouchMod;
    const headR = 16;
    const torsoH = 40 * crouchMod;
    const torsoW = 28;
    const legH = 35 * crouchMod;

    const torsoTop = baseY - bodyH + headR * 2;
    const torsoBottom = torsoTop + torsoH;
    const headCY = torsoTop - headR;

    // === SHADOW ===
    ctx.save();
    ctx.globalAlpha = 0.25 * alpha;
    ctx.fillStyle = '#000000';
    ctx.beginPath();
    ctx.ellipse(0, groundY + 3, 25, 6, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    // Glow aura
    if (s === 'special' || s === 'super') {
      ctx.save();
      ctx.globalAlpha = 0.3 * alpha;
      ctx.shadowColor = s === 'super' ? '#ffffff' : col;
      ctx.shadowBlur = 40;
      ctx.fillStyle = s === 'super' ? '#ffffff' : col;
      ctx.beginPath();
      ctx.ellipse(0, baseY - bodyH * 0.5, 35, bodyH * 0.6, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    // Block aura
    if (this.isBlocking) {
      ctx.save();
      ctx.globalAlpha = 0.2 * alpha;
      ctx.strokeStyle = '#00ffff';
      ctx.lineWidth = 3;
      ctx.shadowColor = '#00ffff';
      ctx.shadowBlur = 15;
      ctx.beginPath();
      ctx.ellipse(0, baseY - bodyH * 0.5, 35, bodyH * 0.55, 0, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();
    }

    // === LEGS ===
    const legOffsetL = s === 'walk' ? Math.sin(this.animTimer * 0.2) * 8 : 0;
    const legOffsetR = -legOffsetL;

    // Left leg
    this.drawLimb(ctx, -8, torsoBottom, -8 + legOffsetL, baseY, 8, col2, col);
    // Right leg
    this.drawLimb(ctx, 8, torsoBottom, 8 + legOffsetR, baseY, 8, col2, col);

    // Feet
    ctx.fillStyle = col2;
    ctx.shadowColor = col;
    ctx.shadowBlur = 5;
    ctx.fillRect(-12 + legOffsetL, baseY - 5, 24, 6);
    ctx.fillRect(-12 + legOffsetR + 8, baseY - 5, 24, 6);

    // === TORSO ===
    ctx.shadowColor = col;
    ctx.shadowBlur = 10;
    ctx.fillStyle = col2;

    // Torso main body
    const torsoPoints = [
      [-torsoW * 0.5, torsoTop],
      [torsoW * 0.5, torsoTop],
      [torsoW * 0.6, torsoBottom],
      [-torsoW * 0.6, torsoBottom],
    ];
    ctx.beginPath();
    ctx.moveTo(torsoPoints[0][0], torsoPoints[0][1]);
    torsoPoints.forEach(p => ctx.lineTo(p[0], p[1]));
    ctx.closePath();
    ctx.fill();

    // Torso highlight
    ctx.fillStyle = col;
    ctx.globalAlpha = 0.4 * alpha;
    ctx.beginPath();
    ctx.moveTo(-torsoW * 0.4, torsoTop + 2);
    ctx.lineTo(torsoW * 0.4, torsoTop + 2);
    ctx.lineTo(torsoW * 0.2, torsoTop + 14);
    ctx.lineTo(-torsoW * 0.2, torsoTop + 14);
    ctx.closePath();
    ctx.fill();
    ctx.globalAlpha = alpha;

    // Torso accent lines
    ctx.strokeStyle = col;
    ctx.lineWidth = 1.5;
    ctx.shadowBlur = 8;
    ctx.beginPath();
    ctx.moveTo(-torsoW * 0.2, torsoTop + 8);
    ctx.lineTo(-torsoW * 0.2, torsoTop + torsoH * 0.7);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(torsoW * 0.2, torsoTop + 8);
    ctx.lineTo(torsoW * 0.2, torsoTop + torsoH * 0.7);
    ctx.stroke();

    // === ARMS ===
    const attackMod = (s === 'attack' || s === 'special' || s === 'super') ? 1 : 0;
    const armLY = torsoTop + 10;

    // Attack arm extension
    let frontArmExtX = 20, frontArmExtY = armLY + 5;
    let backArmExtX = -30, backArmExtY = armLY + 15;

    if (attackMod) {
      const progress = Math.min(1, this.stateTimer / 10);
      const retract = this.stateTimer > 10 ? (this.stateTimer - 10) / 10 : 0;
      const reach = this.attackType === 'heavy' || this.attackType === 'super' ? 60 :
                    this.attackType === 'special' ? 55 : 45;
      frontArmExtX = 20 + reach * progress * (1 - retract);
      frontArmExtY = armLY - 5 + (this.attackType === 'kick' ? 20 : 0);
    }

    // Back arm
    this.drawLimb(ctx, -12, armLY, backArmExtX, backArmExtY, 7, col2, col);
    // Front arm / fist
    this.drawLimb(ctx, 12, armLY, frontArmExtX, frontArmExtY, 7, col2, col);

    // Fist
    ctx.fillStyle = col;
    ctx.shadowColor = col;
    ctx.shadowBlur = attackMod ? 20 : 8;
    ctx.beginPath();
    ctx.arc(frontArmExtX, frontArmExtY, attackMod ? 10 : 8, 0, Math.PI * 2);
    ctx.fill();

    if (attackMod && this.attackType === 'super') {
      ctx.globalAlpha = 0.6 * alpha;
      ctx.fillStyle = '#ffffff';
      ctx.shadowBlur = 30;
      ctx.beginPath();
      ctx.arc(frontArmExtX, frontArmExtY, 16, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = alpha;
    }

    // === HEAD ===
    const headHurtOffset = hurtMod ? 5 : 0;
    ctx.shadowColor = col;
    ctx.shadowBlur = 12;

    // Neck
    ctx.fillStyle = col2;
    ctx.fillRect(-5, headCY + headR - 2, 10, 8);

    // Head base
    ctx.fillStyle = col2;
    ctx.beginPath();
    ctx.arc(headHurtOffset, headCY, headR, 0, Math.PI * 2);
    ctx.fill();

    // Face highlight
    ctx.fillStyle = col;
    ctx.globalAlpha = 0.5 * alpha;
    ctx.beginPath();
    ctx.arc(headHurtOffset - 3, headCY - 4, headR * 0.55, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = alpha;

    // Eyes
    const eyeY = headCY - 3;
    const eyeGlow = (s === 'attack' || s === 'special' || s === 'super') ? acc : col;
    ctx.fillStyle = eyeGlow;
    ctx.shadowColor = eyeGlow;
    ctx.shadowBlur = 10;
    ctx.fillRect(headHurtOffset - 6, eyeY - 2, 5, 4);
    ctx.fillRect(headHurtOffset + 1, eyeY - 2, 5, 4);

    // KO state: X eyes
    if (s === 'ko' || this.isDead) {
      ctx.strokeStyle = '#ff003c';
      ctx.lineWidth = 2;
      ctx.shadowColor = '#ff003c';
      ctx.shadowBlur = 8;
      [-6, 2].forEach(ex => {
        ctx.beginPath();
        ctx.moveTo(headHurtOffset + ex, eyeY - 3);
        ctx.lineTo(headHurtOffset + ex + 4, eyeY + 3);
        ctx.moveTo(headHurtOffset + ex + 4, eyeY - 3);
        ctx.lineTo(headHurtOffset + ex, eyeY + 3);
        ctx.stroke();
      });
    }

    // Hurt state: sweat drop
    if (s === 'hurt') {
      ctx.fillStyle = '#88ccff';
      ctx.globalAlpha = 0.7 * alpha;
      ctx.beginPath();
      ctx.arc(headHurtOffset + headR * 0.7, headCY - headR * 0.3, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = alpha;
    }

    // Hat/hair detail
    ctx.fillStyle = col;
    ctx.shadowBlur = 5;
    const hairSpikes = this.char.id % 2 === 0 ? 3 : 2;
    for (let i = 0; i < hairSpikes; i++) {
      const sx = headHurtOffset - 10 + i * 10;
      ctx.beginPath();
      ctx.moveTo(sx, headCY - headR);
      ctx.lineTo(sx + 5, headCY - headR - 14 - i * 3);
      ctx.lineTo(sx + 10, headCY - headR);
      ctx.fill();
    }

    // Special effect particles on character
    if (s === 'special') {
      ctx.globalAlpha = 0.6 * alpha;
      for (let i = 0; i < 3; i++) {
        const ang = (this.animTimer * 0.1 + i * Math.PI * 2 / 3);
        const rx = Math.cos(ang) * 30, ry = Math.sin(ang) * 40;
        ctx.fillStyle = col;
        ctx.shadowColor = col;
        ctx.shadowBlur = 15;
        ctx.beginPath();
        ctx.arc(rx, baseY - bodyH * 0.5 + ry, 5, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = alpha;
    }

    ctx.restore();
  }

  drawLimb(ctx, x1, y1, x2, y2, width, fillColor, glowColor) {
    const dx = x2 - x1, dy = y2 - y1;
    const len = Math.sqrt(dx*dx + dy*dy);
    if (len < 1) return;

    ctx.save();
    ctx.shadowColor = glowColor;
    ctx.shadowBlur = 6;
    ctx.strokeStyle = fillColor;
    ctx.lineWidth = width;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    ctx.restore();
  }

  drawDebugHitbox() {
    if (!DEBUG_MODE) return;
    ctx.save();
    ctx.strokeStyle = 'rgba(0,255,0,0.5)';
    ctx.lineWidth = 1;
    ctx.strokeRect(this.hitbox.x, this.hitbox.y, this.hitbox.w, this.hitbox.h);
    if (this.attackHitbox) {
      ctx.strokeStyle = 'rgba(255,0,0,0.7)';
      ctx.strokeRect(this.attackHitbox.x, this.attackHitbox.y, this.attackHitbox.w, this.attackHitbox.h);
    }
    ctx.restore();
  }
}

const DEBUG_MODE = false;

// ============================================================
//  AI CONTROLLER
// ============================================================
class AIController {
  constructor(fighter, target, difficulty) {
    this.fighter = fighter;
    this.target = target;
    this.difficulty = difficulty; // easy | medium | hard
    this.timer = 0;
    this.action = 'idle';
    this.actionTimer = 0;
    this.reactionDelay = difficulty === 'hard' ? 8 : difficulty === 'medium' ? 18 : 30;
    this.actionChangeRate = difficulty === 'hard' ? 20 : difficulty === 'medium' ? 35 : 50;
    this.aggressionRate = difficulty === 'hard' ? 0.75 : difficulty === 'medium' ? 0.55 : 0.35;
    this.blockChance = difficulty === 'hard' ? 0.45 : difficulty === 'medium' ? 0.28 : 0.15;
    this.jumpChance = difficulty === 'hard' ? 0.15 : difficulty === 'medium' ? 0.10 : 0.05;
    this.specialChance = difficulty === 'hard' ? 0.25 : difficulty === 'medium' ? 0.15 : 0.08;
    this.decisionQueue = [];
  }

  update() {
    const f = this.fighter;
    const t = this.target;
    if (f.isDead || f.state === 'ko') return;

    this.timer++;

    const dist = Math.abs(f.x - t.x);
    const isLeft = f.x > t.x;

    // Face target
    f.facingRight = t.x > f.x;

    // Cooldown
    if (this.actionTimer > 0) {
      this.actionTimer--;
      this.executeAction();
      return;
    }

    // Choose new action
    if (this.timer % this.actionChangeRate === 0) {
      this.chooseAction(dist, isLeft);
    }

    this.executeAction();
  }

  chooseAction(dist, isLeft) {
    const f = this.fighter;
    const t = this.target;
    const roll = Math.random();

    // If target is attacking, maybe block
    if ((t.state === 'attack' || t.state === 'special') && Math.random() < this.blockChance) {
      this.action = 'block';
      this.actionTimer = 15;
      return;
    }

    // If super meter full and close, use super
    if (f.superMeter >= f.maxSuper && dist < 150 && Math.random() < 0.7) {
      this.action = 'super';
      this.actionTimer = 50;
      return;
    }

    // If special meter enough and close
    if (f.superMeter >= 30 && dist < 120 && Math.random() < this.specialChance) {
      this.action = 'special';
      this.actionTimer = 30;
      return;
    }

    if (dist > 200) {
      // Approach
      if (Math.random() < this.aggressionRate) {
        this.action = isLeft ? 'move_left' : 'move_right';
        this.actionTimer = 20 + Math.floor(Math.random() * 20);
      } else {
        this.action = 'idle';
        this.actionTimer = 15;
      }

      if (Math.random() < this.jumpChance) {
        this.action = 'jump';
        this.actionTimer = 5;
      }
    } else if (dist < 80) {
      // In close range - attack or back off
      if (Math.random() < this.aggressionRate) {
        const attacks = ['light', 'heavy', 'kick'];
        const weights = [0.4, 0.35, 0.25];
        let r = Math.random(), cum = 0;
        for (let i = 0; i < attacks.length; i++) {
          cum += weights[i];
          if (r < cum) { this.action = attacks[i]; break; }
        }
        this.actionTimer = 25;
      } else {
        this.action = isLeft ? 'move_right' : 'move_left';
        this.actionTimer = 12;
      }

      if (Math.random() < this.jumpChance * 1.5) {
        this.action = 'jump_kick';
        this.actionTimer = 30;
      }
    } else {
      // Medium range
      if (Math.random() < this.aggressionRate * 0.8) {
        this.action = isLeft ? 'move_left' : 'move_right';
        this.actionTimer = 10;
      } else if (roll < 0.3) {
        this.action = 'kick';
        this.actionTimer = 22;
      } else if (roll < 0.5) {
        this.action = 'jump';
        this.actionTimer = 8;
      } else {
        this.action = 'idle';
        this.actionTimer = 20;
      }
    }
  }

  executeAction() {
    const f = this.fighter;
    const t = this.target;
    const isLeft = f.x > t.x;

    switch (this.action) {
      case 'move_left':
        f.move(-f.char.speed);
        break;
      case 'move_right':
        f.move(f.char.speed);
        break;
      case 'jump':
        f.jump();
        break;
      case 'jump_kick':
        f.jump();
        setTimeout(() => { if (!f.isDead) f.attack('kick'); }, 300);
        break;
      case 'light':
        f.attack('light');
        break;
      case 'heavy':
        f.attack('heavy');
        break;
      case 'kick':
        f.attack('kick');
        break;
      case 'special':
        f.attack('special');
        break;
      case 'super':
        f.attack('super');
        break;
      case 'block':
        f.keys['down'] = true;
        f.crouch();
        break;
    }

    if (this.action === 'block' && this.actionTimer <= 0) {
      f.keys['down'] = false;
    }
  }
}

// ============================================================
//  INPUT MANAGER
// ============================================================
const keys = {};

document.addEventListener('keydown', e => {
  if (GAME.state !== 'fighting') {
    if (e.key === 'Enter' && GAME.state === 'title') { startGame('pve'); return; }
    return;
  }
  keys[e.code] = true;

  if (e.code === 'Escape') { togglePause(); return; }
  if (GAME.paused) return;

  // P1 attacks
  if (e.code === 'KeyF') { p1.attack('light'); }
  if (e.code === 'KeyG') { p1.attack('kick'); }
  if (e.code === 'KeyH') {
    if (p1.superMeter >= p1.maxSuper) p1.attack('super');
    else p1.attack('special');
  }
  if (e.code === 'KeyR') { p1.attack('heavy'); }

  // P2 attacks (keyboard)
  if (GAME.mode === 'pvp') {
    if (e.code === 'Numpad1' || e.code === 'Digit1') { p2.attack('light'); }
    if (e.code === 'Numpad2' || e.code === 'Digit2') { p2.attack('kick'); }
    if (e.code === 'Numpad3' || e.code === 'Digit3') {
      if (p2.superMeter >= p2.maxSuper) p2.attack('super');
      else p2.attack('special');
    }
    if (e.code === 'Numpad0' || e.code === 'Digit0') { p2.attack('heavy'); }
  }

  e.preventDefault();
});

document.addEventListener('keyup', e => {
  keys[e.code] = false;
});

function processInput() {
  if (!p1 || GAME.paused || GAME.roundOver) return;

  // P1
  if (keys['KeyA'] || keys['ArrowLeft'] && GAME.mode === 'pvp' && false) {
    p1.move(-p1.char.speed);
  }
  if (keys['KeyD']) {
    p1.move(p1.char.speed);
  }
  if (keys['KeyA']) {
    p1.move(-p1.char.speed);
  }
  if ((keys['KeyW'] || keys['Space']) && p1.onGround) {
    p1.jump();
  }
  if (keys['KeyS']) {
    p1.crouch();
    p1.keys['down'] = true;
  } else {
    p1.keys['down'] = false;
  }

  // P2 (PvP mode)
  if (GAME.mode === 'pvp' && p2) {
    if (keys['ArrowLeft']) p2.move(-p2.char.speed);
    if (keys['ArrowRight']) p2.move(p2.char.speed);
    if (keys['ArrowUp'] && p2.onGround) p2.jump();
    if (keys['ArrowDown']) {
      p2.crouch();
      p2.keys['down'] = true;
    } else {
      p2.keys['down'] = false;
    }
  }
}

// ============================================================
//  HIT DETECTION
// ============================================================
function checkHits() {
  checkFighterHit(p1, p2);
  checkFighterHit(p2, p1);
}

function checkFighterHit(attacker, defender) {
  if (!attacker.hitActive || attacker.hasHit || !attacker.attackHitbox) return;
  if (defender.isDead) return;

  const ab = attacker.attackHitbox;
  const db = defender.hitbox;

  if (ab.x < db.x + db.w &&
      ab.x + ab.w > db.x &&
      ab.y < db.y + db.h &&
      ab.y + ab.h > db.y) {

    attacker.hasHit = true;
    attacker.hitActive = false;

    const atkData = attacker.char.attackPower;
    let dmg = 0;
    switch (attacker.attackType) {
      case 'light':   dmg = atkData.light; break;
      case 'heavy':   dmg = atkData.heavy; break;
      case 'kick':    dmg = atkData.kick; break;
      case 'special': dmg = atkData.special; break;
      case 'super':   dmg = atkData.super; break;
    }

    // Crit chance
    let isCrit = Math.random() < 0.12;
    if (isCrit) dmg = Math.floor(dmg * 1.5);

    const actualDmg = defender.takeDamage(dmg, attacker.x);
    attacker.superMeter = Math.min(attacker.maxSuper, attacker.superMeter + dmg * 0.3);

    // Combo tracking
    if (!defender.isBlocking) {
      attacker.combo++;
      attacker.comboTimer = 120;

      if (attacker.playerId === 1) {
        GAME.combo1 = attacker.combo;
        updateComboDisplay(1, attacker.combo);
      } else {
        GAME.combo2 = attacker.combo;
        updateComboDisplay(2, attacker.combo);
      }
    }

    // Hit sparks
    const hitX = (ab.x + ab.w / 2);
    const hitY = (ab.y + ab.h / 2);
    const sparkColor = attacker.attackType === 'super' ? '#ffffff' :
                       attacker.attackType === 'special' ? attacker.char.color :
                       isCrit ? '#ffe600' : '#ffffff';
    spawnHitSparks(hitX, hitY, sparkColor);

    // Damage number
    showDamageNumber(hitX, hitY - 20, actualDmg,
      attacker.attackType === 'super' ? 'super' :
      isCrit ? 'crit' : 'normal');

    // Update HUD
    updateHUD();
  }
}

// ============================================================
//  SCREEN EFFECTS
// ============================================================
let screenShake = { active: false, intensity: 0, duration: 0, timer: 0 };

function triggerScreenShake(intensity, duration) {
  screenShake.active = true;
  screenShake.intensity = intensity;
  screenShake.duration = duration;
  screenShake.timer = 0;
}

let screenFlashActive = false;
let screenFlashColor = '#ffffff';
let screenFlashAlpha = 0;

function triggerScreenFlash(color, alpha) {
  screenFlashActive = true;
  screenFlashColor = color;
  screenFlashAlpha = alpha;
}

function updateScreenEffects() {
  if (screenShake.active) {
    screenShake.timer++;
    if (screenShake.timer >= screenShake.duration) {
      screenShake.active = false;
      canvas.style.transform = '';
    } else {
      const decay = 1 - (screenShake.timer / screenShake.duration);
      const sx = (Math.random() - 0.5) * screenShake.intensity * decay;
      const sy = (Math.random() - 0.5) * screenShake.intensity * decay * 0.5;
      canvas.style.transform = `translate(${sx}px, ${sy}px)`;
    }
  }

  const flashEl = document.getElementById('screenFlash');
  if (screenFlashActive) {
    flashEl.style.background = screenFlashColor;
    flashEl.style.opacity = screenFlashAlpha;
    screenFlashAlpha -= 0.05;
    if (screenFlashAlpha <= 0) {
      screenFlashActive = false;
      flashEl.style.opacity = 0;
    }
  }
}

// ============================================================
//  DAMAGE NUMBERS
// ============================================================
function showDamageNumber(x, y, dmg, type) {
  const el = document.createElement('div');
  el.className = `damage-number ${type}`;
  el.textContent = dmg;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.getElementById('gameContainer').appendChild(el);
  setTimeout(() => el.remove(), 800);
}

// ============================================================
//  COMBO DISPLAY
// ============================================================
function updateComboDisplay(player, count) {
  const el = document.getElementById(`combo${player}`);
  const numEl = document.getElementById(`combo${player}Num`);

  if (count >= 2) {
    el.classList.add('active');
    numEl.textContent = count;
    el.style.fontSize = count >= 5 ? '70px' : '60px';
  } else {
    el.classList.remove('active');
  }
}

// ============================================================
//  HUD UPDATE
// ============================================================
function updateHUD() {
  if (!p1 || !p2) return;

  const p1Pct = (p1.hp / p1.maxHp) * 100;
  const p2Pct = (p2.hp / p2.maxHp) * 100;
  const p1SuperPct = (p1.superMeter / p1.maxSuper) * 100;
  const p2SuperPct = (p2.superMeter / p2.maxSuper) * 100;

  document.getElementById('p1HealthBar').style.width = p1Pct + '%';
  document.getElementById('p2HealthBar').style.width = p2Pct + '%';
  document.getElementById('p1HealthText').textContent = Math.ceil(p1.hp);
  document.getElementById('p2HealthText').textContent = Math.ceil(p2.hp);
  document.getElementById('p1SuperBar').style.width = p1SuperPct + '%';
  document.getElementById('p2SuperBar').style.width = p2SuperPct + '%';

  // Health bar color changes
  const p1Bar = document.getElementById('p1HealthBar');
  const p2Bar = document.getElementById('p2HealthBar');

  if (p1Pct < 25) {
    p1Bar.style.background = 'linear-gradient(90deg, #ff0000, #ff5500)';
    p1Bar.style.boxShadow = 'var(--glow-red)';
  } else if (p1Pct < 50) {
    p1Bar.style.background = 'linear-gradient(90deg, #ff9900, #ffcc00)';
    p1Bar.style.boxShadow = '0 0 8px rgba(255,150,0,0.8)';
  }

  if (p2Pct < 25) {
    p2Bar.style.background = 'linear-gradient(270deg, #ff0000, #ff5500)';
  } else if (p2Pct < 50) {
    p2Bar.style.background = 'linear-gradient(270deg, #ff9900, #ffcc00)';
  }
}

// ============================================================
//  ANNOUNCER
// ============================================================
function announce(text, style, duration) {
  const el = document.getElementById('announcer');
  el.className = `show ${style}`;
  el.innerHTML = text;
  clearTimeout(el._timeout);
  el._timeout = setTimeout(() => {
    el.className = '';
    el.innerHTML = '';
  }, duration || 1800);
}

// ============================================================
//  TIMER
// ============================================================
function startTimer() {
  GAME.timer = TIMER_SECONDS;
  clearInterval(GAME.timerInterval);
  GAME.timerInterval = setInterval(() => {
    if (GAME.paused || GAME.roundOver) return;
    GAME.timer--;
    const el = document.getElementById('timerDisplay');
    el.textContent = GAME.timer;
    el.className = 'timer-display' + (GAME.timer <= 10 ? ' urgent' : '');

    if (GAME.timer <= 0) {
      clearInterval(GAME.timerInterval);
      endRoundByTime();
    }
  }, 1000);
}

function endRoundByTime() {
  GAME.roundOver = true;
  // Winner is who has more HP
  if (p1.hp > p2.hp) {
    announce('TIME UP!<br>JUGADOR 1 WINS', 'ko winner', 2500);
    GAME.p1Wins++;
    updateWinDots();
  } else if (p2.hp > p1.hp) {
    announce('TIME UP!<br>JUGADOR 2 WINS', 'ko winner', 2500);
    GAME.p2Wins++;
    updateWinDots();
  } else {
    announce('DRAW!', 'fight', 2000);
  }
  setTimeout(checkGameOver, 2500);
}

// ============================================================
//  ROUND MANAGEMENT
// ============================================================
function checkRoundOver() {
  if (GAME.roundOver) return;
  if (p1.isDead || p2.isDead) {
    GAME.roundOver = true;
    clearInterval(GAME.timerInterval);

    setTimeout(() => {
      if (p1.isDead && p2.isDead) {
        announce('DOUBLE KO!', 'ko', 2000);
        setTimeout(checkGameOver, 2200);
      } else if (p1.isDead) {
        const name = p2.char.name;
        announce(`KO!`, 'ko', 1000);
        GAME.p2Wins++;
        updateWinDots();
        setTimeout(() => announce(`${name}<br><span style="font-size:18px;letter-spacing:6px">WINS!</span>`, 'winner', 2000), 1000);
        setTimeout(checkGameOver, 3000);
      } else {
        const name = p1.char.name;
        announce(`KO!`, 'ko', 1000);
        GAME.p1Wins++;
        updateWinDots();
        setTimeout(() => announce(`${name}<br><span style="font-size:18px;letter-spacing:6px">WINS!</span>`, 'winner', 2000), 1000);
        setTimeout(checkGameOver, 3000);
      }
    }, 400);
  }
}

function updateWinDots() {
  ['p1', 'p2'].forEach(p => {
    const wins = p === 'p1' ? GAME.p1Wins : GAME.p2Wins;
    for (let i = 1; i <= 2; i++) {
      const dot = document.getElementById(`${p}d${i}`);
      if (i <= wins) {
        dot.className = `win-dot filled ${p}`;
      } else {
        dot.className = 'win-dot';
      }
    }
  });
}

function checkGameOver() {
  const winsNeeded = Math.ceil(GAME.maxRounds / 2);

  if (GAME.p1Wins >= winsNeeded || GAME.p2Wins >= winsNeeded) {
    showResult();
  } else {
    GAME.round++;
    setTimeout(startRound, 500);
  }
}

function startRound() {
  // Reset fighters
  const charP1 = GAME.selectedP1;
  const charP2 = GAME.selectedP2;

  p1 = new Fighter(charP1, 200, true, 1);
  p2 = new Fighter(charP2, 700, false, 2);

  if (GAME.mode === 'pve') {
    p2.ai = new AIController(p2, p1, 'medium');
  }

  GAME.roundOver = false;
  particles.length = 0;

  document.getElementById('roundDisplay').textContent = `ROUND ${GAME.round}`;
  updateHUD();

  // Reset combo displays
  document.getElementById('combo1').classList.remove('active');
  document.getElementById('combo2').classList.remove('active');

  announce(`ROUND ${GAME.round}`, 'round', 1400);
  setTimeout(() => {
    announce('FIGHT!', 'fight', 1200);
    startTimer();
  }, 1500);
}

function showResult() {
  GAME.state = 'result';
  cancelAnimationFrame(GAME.animFrame);
  clearInterval(GAME.timerInterval);

  document.getElementById('resultScreen').style.display = 'flex';
  document.getElementById('hud').style.display = 'none';
  document.getElementById('moveList').style.display = 'none';
  document.getElementById('modeDisplay').style.display = 'none';

  const winsNeeded = Math.ceil(GAME.maxRounds / 2);
  let winnerName = '';
  let winnerColor = '';

  if (GAME.p1Wins >= winsNeeded) {
    winnerName = GAME.selectedP1.name;
    winnerColor = GAME.selectedP1.color;
  } else if (GAME.p2Wins >= winsNeeded) {
    winnerName = GAME.selectedP2.name;
    winnerColor = GAME.selectedP2.color;
  } else {
    winnerName = 'EMPATE';
    winnerColor = '#ffe600';
  }

  const titleEl = document.getElementById('resultTitle');
  titleEl.textContent = 'VICTORIA!';
  titleEl.style.color = winnerColor;
  titleEl.style.textShadow = `0 0 20px ${winnerColor}, 0 0 40px ${winnerColor}`;

  const winnerEl = document.getElementById('resultWinner');
  winnerEl.textContent = winnerName;
  winnerEl.style.color = winnerColor;
}

// ============================================================
//  STAGE BACKGROUNDS
// ============================================================
function drawStage() {
  const stage = STAGES[GAME.stageIndex];
  GAME.bgFrame++;

  // Sky gradient
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, stage.bgColor1);
  grad.addColorStop(0.6, stage.bgColor2);
  grad.addColorStop(1, '#000000');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  // Animated star field
  ctx.save();
  const starCount = 60;
  for (let i = 0; i < starCount; i++) {
    const seed = i * 137.508;
    const sx = (seed * 7.3) % W;
    const sy = (seed * 3.7) % (H * 0.7);
    const brightness = 0.3 + (Math.sin(GAME.bgFrame * 0.02 + seed) * 0.5 + 0.5) * 0.7;
    const size = (i % 3 === 0) ? 2 : 1;
    ctx.globalAlpha = brightness;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(sx, sy, size, size);
  }
  ctx.restore();

  // Cityscape silhouette
  drawCitySilhouette(stage);

  // Floor
  const floorGrad = ctx.createLinearGradient(0, GROUND_Y - 10, 0, H);
  floorGrad.addColorStop(0, stage.floorColor);
  floorGrad.addColorStop(1, '#000000');
  ctx.fillStyle = floorGrad;
  ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);

  // Floor glow line
  ctx.save();
  ctx.shadowColor = stage.floorAccent;
  ctx.shadowBlur = 15;
  ctx.strokeStyle = stage.floorAccent;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, GROUND_Y);
  ctx.lineTo(W, GROUND_Y);
  ctx.stroke();
  ctx.restore();

  // Floor grid lines
  ctx.save();
  ctx.globalAlpha = 0.12;
  ctx.strokeStyle = stage.floorAccent;
  ctx.lineWidth = 1;
  const gridSpacing = 60;
  const gridOffset = (GAME.bgFrame * 0.5) % gridSpacing;
  for (let gx = -gridSpacing + gridOffset; gx < W + gridSpacing; gx += gridSpacing) {
    const perspective = (gx - W / 2) * 2;
    ctx.beginPath();
    ctx.moveTo(gx, GROUND_Y);
    ctx.lineTo(W / 2 + perspective * 0.1, H);
    ctx.stroke();
  }
  for (let i = 0; i < 8; i++) {
    const gy = GROUND_Y + i * 18;
    const perspW = W * (1 + i * 0.1);
    ctx.beginPath();
    ctx.moveTo((W - perspW) / 2, gy);
    ctx.lineTo((W + perspW) / 2, gy);
    ctx.stroke();
  }
  ctx.restore();

  // Stage name
  ctx.save();
  ctx.globalAlpha = 0.15;
  ctx.font = '900 120px Orbitron, monospace';
  ctx.fillStyle = stage.accent1;
  ctx.textAlign = 'center';
  ctx.fillText(stage.name, W / 2, GROUND_Y - 20);
  ctx.restore();

  // Corner frame decorations
  drawStageCorners(stage);
}

function drawCitySilhouette(stage) {
  ctx.save();
  ctx.globalAlpha = 0.4;
  ctx.fillStyle = '#020208';

  const buildings = [
    { x: 0,   w: 80,  h: 180 },
    { x: 70,  w: 50,  h: 120 },
    { x: 110, w: 70,  h: 200 },
    { x: 170, w: 40,  h: 140 },
    { x: 200, w: 90,  h: 170 },
    { x: 280, w: 50,  h: 100 },
    { x: 320, w: 60,  h: 220 },
    { x: 370, w: 45,  h: 150 },
    { x: 405, w: 55,  h: 180 },
    { x: 450, w: 80,  h: 130 },
    { x: 520, w: 60,  h: 200 },
    { x: 570, w: 50,  h: 160 },
    { x: 610, w: 70,  h: 210 },
    { x: 670, w: 45,  h: 130 },
    { x: 705, w: 85,  h: 175 },
    { x: 780, w: 50,  h: 150 },
    { x: 820, w: 80,  h: 190 },
    { x: 870, w: 30,  h: 120 },
  ];

  buildings.forEach(b => {
    const bY = GROUND_Y - b.h;
    ctx.fillRect(b.x, bY, b.w, b.h);

    // Windows
    ctx.save();
    ctx.globalAlpha = 0.3;
    const wCols = Math.floor(b.w / 16);
    const wRows = Math.floor(b.h / 20);
    for (let r = 1; r < wRows; r++) {
      for (let c = 0; c < wCols; c++) {
        if (Math.sin(b.x + c * 7 + r * 11) > 0.1) {
          const wx = b.x + c * 16 + 4;
          const wy = bY + r * 20 + 4;
          ctx.fillStyle = stage.accent1;
          ctx.shadowColor = stage.accent1;
          ctx.shadowBlur = 4;
          ctx.fillRect(wx, wy, 6, 8);
        }
      }
    }
    ctx.restore();
  });

  ctx.restore();

  // Animated scrolling lights
  ctx.save();
  ctx.globalAlpha = 0.6;
  for (let i = 0; i < 5; i++) {
    const lx = ((GAME.bgFrame * (0.3 + i * 0.1) + i * 200) % W);
    const ly = 80 + i * 40;
    ctx.fillStyle = i % 2 === 0 ? stage.accent1 : stage.accent2;
    ctx.shadowColor = ctx.fillStyle;
    ctx.shadowBlur = 8;
    ctx.fillRect(lx - 2, ly, 4, 2);
  }
  ctx.restore();
}

function drawStageCorners(stage) {
  const corners = [
    { x: 15, y: 95 }, { x: W - 15, y: 95 },
    { x: 15, y: H - 15 }, { x: W - 15, y: H - 15 },
  ];

  ctx.save();
  ctx.strokeStyle = stage.accent1;
  ctx.shadowColor = stage.accent1;
  ctx.shadowBlur = 8;
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.5;

  const len = 15;
  [[1,1],[-1,1],[1,-1],[-1,-1]].forEach((dir, i) => {
    const c = corners[i];
    ctx.beginPath();
    ctx.moveTo(c.x, c.y + dir[1] * len);
    ctx.lineTo(c.x, c.y);
    ctx.lineTo(c.x + dir[0] * len, c.y);
    ctx.stroke();
  });
  ctx.restore();
}

// ============================================================
//  MAIN GAME LOOP
// ============================================================
let p1 = null, p2 = null;

function gameLoop(timestamp) {
  if (GAME.state !== 'fighting') return;

  GAME.dt = Math.min((timestamp - GAME.lastTime) / 16.67, 3);
  GAME.lastTime = timestamp;

  ctx.clearRect(0, 0, W, H);

  if (!GAME.paused) {
    // Update
    processInput();

    if (!GAME.roundOver) {
      // Face each other
      if (p1) p1.facingRight = p2 ? p1.x < p2.x : true;
      if (p2) p2.facingRight = p1 ? p2.x < p1.x : false;

      if (p1) p1.update();
      if (p2) {
        if (p2.ai && !GAME.roundOver) p2.ai.update();
        p2.update();
      }

      checkHits();
      checkRoundOver();
      updateParticles();
      updateScreenEffects();
    } else {
      if (p1) p1.update();
      if (p2) p2.update();
      updateParticles();
      updateScreenEffects();
    }
  }

  // Draw
  drawStage();
  if (p1) { p1.draw(); p1.drawDebugHitbox(); }
  if (p2) { p2.draw(); p2.drawDebugHitbox(); }
  drawParticles();

  GAME.animFrame = requestAnimationFrame(gameLoop);
}

// ============================================================
//  GAME FLOW
// ============================================================
let currentGameMode = 'pve';

function startGame(mode) {
  currentGameMode = mode;
  GAME.mode = mode;
  showSelectScreen(mode);
}

function showSelectScreen(mode) {
  GAME.state = 'select';
  document.getElementById('titleScreen').style.display = 'none';
  document.getElementById('selectScreen').style.display = 'flex';

  buildCharCards();
}

function buildCharCards() {
  const p1Container = document.getElementById('p1Cards');
  const p2Container = document.getElementById('p2Cards');
  p1Container.innerHTML = '';
  p2Container.innerHTML = '';

  CHARACTERS.forEach(char => {
    [1, 2].forEach(player => {
      const card = document.createElement('div');
      card.className = 'char-card';
      card.onclick = () => selectCharacter(player, char.id);

      const cardCanvas = document.createElement('canvas');
      cardCanvas.width = 110;
      cardCanvas.height = 140;
      drawCharPreviewOnCanvas(cardCanvas, char);

      const nameEl = document.createElement('div');
      nameEl.className = 'char-card-name';
      nameEl.textContent = char.name;

      const typeEl = document.createElement('div');
      typeEl.className = 'char-card-type';
      typeEl.textContent = char.subtitle;

      card.appendChild(cardCanvas);
      card.appendChild(nameEl);
      card.appendChild(typeEl);
      card.id = `charCard_p${player}_${char.id}`;

      if (player === 1) p1Container.appendChild(card);
      else p2Container.appendChild(card);
    });
  });
}

function drawCharPreviewOnCanvas(cvs, char) {
  const c = cvs.getContext('2d');
  const w = cvs.width, h = cvs.height;

  // BG
  const grad = c.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, 'rgba(5,5,20,0.9)');
  grad.addColorStop(1, `${char.color}22`);
  c.fillStyle = grad;
  c.fillRect(0, 0, w, h);

  // Character silhouette preview
  c.save();
  c.translate(w / 2, h - 20);

  const scale = 0.7;
  c.scale(scale, scale);

  const col = char.color;
  const col2 = char.color2;
  const headR = 14;
  const bodyH = 80;
  const torsoH = 32;
  const groundY = 0;

  // Shadow
  c.globalAlpha = 0.3;
  c.fillStyle = '#000';
  c.beginPath();
  c.ellipse(0, groundY + 2, 20, 5, 0, 0, Math.PI * 2);
  c.fill();
  c.globalAlpha = 1;

  // Legs
  c.strokeStyle = col2;
  c.shadowColor = col;
  c.shadowBlur = 6;
  c.lineWidth = 7;
  c.lineCap = 'round';
  c.beginPath(); c.moveTo(-6, groundY - torsoH); c.lineTo(-6, groundY); c.stroke();
  c.beginPath(); c.moveTo(6, groundY - torsoH); c.lineTo(6, groundY); c.stroke();

  // Feet
  c.fillStyle = col2;
  c.fillRect(-14, groundY - 5, 28, 5);

  // Torso
  c.fillStyle = col2;
  c.shadowBlur = 8;
  c.fillRect(-14, groundY - bodyH + headR * 2, 28, torsoH);

  // Arms
  c.lineWidth = 6;
  c.beginPath(); c.moveTo(-14, groundY - bodyH + headR * 2 + 10); c.lineTo(-30, groundY - bodyH + headR * 2 + 25); c.stroke();
  c.beginPath(); c.moveTo(14, groundY - bodyH + headR * 2 + 10); c.lineTo(22, groundY - bodyH + headR * 2 + 15); c.stroke();

  // Fist
  c.fillStyle = col;
  c.shadowBlur = 10;
  c.beginPath(); c.arc(22, groundY - bodyH + headR * 2 + 15, 8, 0, Math.PI * 2); c.fill();

  // Head
  const headY = groundY - bodyH + headR;
  c.fillStyle = col2;
  c.shadowBlur = 12;
  c.beginPath(); c.arc(0, headY, headR, 0, Math.PI * 2); c.fill();

  // Eyes
  c.fillStyle = col;
  c.shadowColor = col;
  c.shadowBlur = 8;
  c.fillRect(-5, headY - 3, 4, 4);
  c.fillRect(1, headY - 3, 4, 4);

  // Hair
  c.fillStyle = col;
  for (let i = 0; i < 2; i++) {
    c.beginPath();
    c.moveTo(-6 + i * 8, headY - headR);
    c.lineTo(-2 + i * 8, headY - headR - 12);
    c.lineTo(2 + i * 8, headY - headR);
    c.fill();
  }

  c.restore();

  // Name overlay
  c.globalAlpha = 0.7;
  c.fillStyle = char.color;
  c.shadowColor = char.color;
  c.shadowBlur = 10;
  c.font = '700 9px Orbitron, monospace';
  c.textAlign = 'center';
  c.fillText(char.specialName, w / 2, 16);
  c.globalAlpha = 1;
}

function selectCharacter(player, charId) {
  const char = CHARACTERS[charId];

  if (player === 1) {
    GAME.selectedP1 = char;
    // Update card highlight
    CHARACTERS.forEach(c => {
      const card = document.getElementById(`charCard_p1_${c.id}`);
      if (card) card.className = 'char-card' + (c.id === charId ? ' selected-p1' : '');
    });
    document.getElementById('previewP1Name').textContent = char.name;
    buildStatsBars('previewP1Stats', char, 'p1');
  } else {
    GAME.selectedP2 = char;
    CHARACTERS.forEach(c => {
      const card = document.getElementById(`charCard_p2_${c.id}`);
      if (card) card.className = 'char-card' + (c.id === charId ? ' selected-p2' : '');
    });
    document.getElementById('previewP2Name').textContent = char.name;
    buildStatsBars('previewP2Stats', char, 'p2');
  }

  // Draw preview canvases
  if (GAME.selectedP1) drawCharPreviewOnCanvas(document.getElementById('previewP1Canvas'), GAME.selectedP1);
  if (GAME.selectedP2) drawCharPreviewOnCanvas(document.getElementById('previewP2Canvas'), GAME.selectedP2);

  // Enable start button
  const btn = document.getElementById('startFightBtn');
  if (GAME.selectedP1 && GAME.selectedP2) {
    btn.style.opacity = '1';
    btn.style.pointerEvents = 'auto';
  }

  playSound('jump');
}

function buildStatsBars(containerId, char, player) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  const stats = [
    { name: 'POW', val: char.stats.power },
    { name: 'SPD', val: char.stats.speed },
    { name: 'DEF', val: char.stats.defense },
    { name: 'SPL', val: char.stats.special },
  ];

  stats.forEach(stat => {
    const row = document.createElement('div');
    row.className = 'stat-bar-row';
    row.innerHTML = `
      <span style="width:28px">${stat.name}</span>
      <div class="stat-bar-bg" style="flex:1">
        <div class="stat-bar-fill" style="width:${stat.val * 10}%"></div>
      </div>
    `;
    container.appendChild(row);
  });
}

function startFight() {
  if (!GAME.selectedP1 || !GAME.selectedP2) return;

  GAME.state = 'fighting';
  GAME.round = 1;
  GAME.p1Wins = 0;
  GAME.p2Wins = 0;
  GAME.stageIndex = Math.floor(Math.random() * STAGES.length);

  document.getElementById('selectScreen').style.display = 'none';
  document.getElementById('hud').style.display = 'flex';
  document.getElementById('moveList').style.display = 'flex';
  document.getElementById('modeDisplay').style.display = 'block';
  document.getElementById('modeDisplay').textContent = GAME.mode === 'pvp' ? '2 JUGADORES' : 'VS CPU';
  document.getElementById('p1Name').textContent = GAME.selectedP1.name;
  document.getElementById('p2Name').textContent = GAME.selectedP2.name;
  document.getElementById('roundDisplay').textContent = `ROUND ${GAME.round}`;

  particles.length = 0;
  updateWinDots();

  p1 = new Fighter(GAME.selectedP1, 200, true, 1);
  p2 = new Fighter(GAME.selectedP2, 700, false, 2);

  if (GAME.mode === 'pve') {
    p2.ai = new AIController(p2, p1, 'medium');
  }

  updateHUD();

  announce(`ROUND ${GAME.round}`, 'round', 1400);
  setTimeout(() => {
    announce('FIGHT!', 'fight', 1200);
    startTimer();
  }, 1500);

  GAME.lastTime = performance.now();
  GAME.animFrame = requestAnimationFrame(gameLoop);
}

function restartGame() {
  document.getElementById('resultScreen').style.display = 'none';
  GAME.state = 'select';
  GAME.round = 1;
  GAME.p1Wins = 0;
  GAME.p2Wins = 0;

  document.getElementById('selectScreen').style.display = 'flex';
  document.getElementById('hud').style.display = 'none';
  document.getElementById('moveList').style.display = 'none';
  document.getElementById('modeDisplay').style.display = 'none';

  clearInterval(GAME.timerInterval);
  cancelAnimationFrame(GAME.animFrame);
}

function showTitle() {
  clearInterval(GAME.timerInterval);
  cancelAnimationFrame(GAME.animFrame);
  GAME.state = 'title';
  GAME.paused = false;

  document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
  document.getElementById('resultScreen').style.display = 'none';
  document.getElementById('pauseScreen').style.display = 'none';
  document.getElementById('hud').style.display = 'none';
  document.getElementById('moveList').style.display = 'none';
  document.getElementById('modeDisplay').style.display = 'none';
  document.getElementById('announcer').className = '';
  document.getElementById('announcer').innerHTML = '';
  document.getElementById('combo1').classList.remove('active');
  document.getElementById('combo2').classList.remove('active');

  document.getElementById('titleScreen').style.display = 'flex';
  canvas.style.transform = '';

  ctx.clearRect(0, 0, W, H);
}

function togglePause() {
  if (GAME.state !== 'fighting') return;
  GAME.paused = !GAME.paused;
  document.getElementById('pauseScreen').style.display = GAME.paused ? 'flex' : 'none';
}

function showControls() {
  alert(
    'CONTROLES\n\n' +
    'JUGADOR 1:\n' +
    '  A/D - Moverse\n' +
    '  W o ESPACIO - Saltar\n' +
    '  S - Agacharse / Bloquear\n' +
    '  F - Golpe r√°pido\n' +
    '  R - Golpe pesado\n' +
    '  G - Patada\n' +
    '  H - Especial / Super (cuando est√° llena)\n\n' +
    'JUGADOR 2 (solo modo 2P):\n' +
    '  ‚Üê/‚Üí - Moverse\n' +
    '  ‚Üë - Saltar\n' +
    '  ‚Üì - Agacharse\n' +
    '  1 - Golpe r√°pido\n' +
    '  2 - Patada\n' +
    '  3 - Especial / Super\n\n' +
    'ESC - Pausa'
  );
}

// ============================================================
//  TITLE SCREEN ANIMATION
// ============================================================
(function titleAnimation() {
  if (GAME.state !== 'title') return;
  GAME.bgFrame++;

  ctx.clearRect(0, 0, W, H);

  // Draw animated background
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#020210');
  grad.addColorStop(1, '#000000');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  // Stars
  for (let i = 0; i < 80; i++) {
    const seed = i * 137.508;
    const sx = (seed * 7.3) % W;
    const sy = (seed * 3.7) % H;
    const b = 0.3 + (Math.sin(GAME.bgFrame * 0.02 + seed) * 0.5 + 0.5) * 0.7;
    ctx.globalAlpha = b;
    ctx.fillStyle = '#fff';
    ctx.fillRect(sx, sy, 1, 1);
  }
  ctx.globalAlpha = 1;

  // Draw preview fighters
  const t = GAME.bgFrame;
  const previewP1 = CHARACTERS[0];
  const previewP2 = CHARACTERS[1];

  // Fighter silhouettes on title
  ctx.save();
  ctx.globalAlpha = 0.3;

  // P1 silhouette
  ctx.translate(260, GROUND_Y + 30);
  ctx.scale(1.3, 1.3);
  drawSimpleSilhouette(ctx, previewP1, true, t);
  ctx.restore();

  ctx.save();
  ctx.globalAlpha = 0.3;
  ctx.translate(640, GROUND_Y + 30);
  ctx.scale(1.3, 1.3);
  drawSimpleSilhouette(ctx, previewP2, false, t);
  ctx.restore();

  requestAnimationFrame(titleAnimation);
})();

function drawSimpleSilhouette(c, char, facingRight, t) {
  const flip = facingRight ? 1 : -1;
  c.scale(flip, 1);

  const bob = Math.sin(t * 0.06) * 4;
  const col = char.color;

  c.shadowColor = col;
  c.shadowBlur = 20;
  c.strokeStyle = col;
  c.lineWidth = 8;
  c.lineCap = 'round';

  const bY = bob - 10;

  // Body lines
  c.beginPath(); c.moveTo(-6, bY - 35); c.lineTo(-6, bY); c.stroke();
  c.beginPath(); c.moveTo(6, bY - 35); c.lineTo(6, bY); c.stroke();
  c.beginPath(); c.moveTo(-12, bY - 70); c.lineTo(12, bY - 70); c.stroke();
  c.beginPath(); c.moveTo(-14, bY - 62); c.lineTo(-28, bY - 45); c.stroke();
  c.beginPath(); c.moveTo(14, bY - 62); c.lineTo(20, bY - 55); c.stroke();

  // Head
  c.beginPath(); c.arc(0, bY - 82, 14, 0, Math.PI * 2); c.stroke();

  // Eyes glow
  c.fillStyle = col;
  c.fillRect(-5, bY - 85, 4, 4);
  c.fillRect(1, bY - 85, 4, 4);
}

// ============================================================
//  KEYBOARD SHORTCUT HELP
// ============================================================
document.addEventListener('keydown', e => {
  if (e.code === 'Escape' && GAME.state === 'select') {
    showTitle();
  }
});

// ============================================================
//  TOUCH/MOBILE SUPPORT (basic)
// ============================================================
let touchStartX = 0;
let touchStartY = 0;

canvas.addEventListener('touchstart', e => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
}, { passive: true });

canvas.addEventListener('touchmove', e => {
  if (!p1 || GAME.state !== 'fighting' || GAME.paused) return;
  const dx = e.touches[0].clientX - touchStartX;
  const dy = e.touches[0].clientY - touchStartY;

  if (Math.abs(dx) > 20) {
    p1.move(dx > 0 ? p1.char.speed : -p1.char.speed);
  }
  if (dy < -30 && p1.onGround) {
    p1.jump();
    touchStartY = e.touches[0].clientY;
  }
  e.preventDefault();
}, { passive: false });

canvas.addEventListener('touchend', e => {
  if (!p1 || GAME.state !== 'fighting' || GAME.paused) return;
  const touch = e.changedTouches[0];
  const rect = canvas.getBoundingClientRect();
  const tx = touch.clientX - rect.left;
  const ty = touch.clientY - rect.top;

  // Right side of screen = attack
  if (tx > W * 0.6) {
    if (ty < H * 0.4) p1.attack('special');
    else if (ty < H * 0.7) p1.attack('kick');
    else p1.attack('light');
  }
}, { passive: true });

// ============================================================
//  INTRO CANVAS ANIMATION LOOP
// ============================================================
// The title animation runs automatically above.
// When in select mode, draw char previews on the previewCanvas elements.

setInterval(() => {
  if (GAME.state === 'select') {
    if (GAME.selectedP1) drawCharPreviewOnCanvas(document.getElementById('previewP1Canvas'), GAME.selectedP1);
    if (GAME.selectedP2) drawCharPreviewOnCanvas(document.getElementById('previewP2Canvas'), GAME.selectedP2);
  }
}, 100);

// ============================================================
//  INITIALIZATION
// ============================================================
console.log('%cNEON CLASH Loaded! üéÆ', 'color: #00d4ff; font-size: 18px; font-weight: bold;');
console.log('Controls: A/D move, W jump, S crouch, F light, R heavy, G kick, H special/super');

// ================================================================
//  NEON CLASH v2 ‚Äî MULTIPLAYER & COMPETITIVE ENGINE
// ================================================================

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Auto-detect server URL: same host, WebSocket protocol
const WS_URL = (() => {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  return `${proto}://${location.host}`;
})();

const RANKS_CONFIG = [
  { name:'BRONCE',   min:0,    color:'#cd7f32', icon:'ü•â' },
  { name:'PLATA',    min:800,  color:'#aaaaaa', icon:'ü•à' },
  { name:'ORO',      min:1000, color:'#ffe600', icon:'ü•á' },
  { name:'PLATINO',  min:1200, color:'#00ffcc', icon:'üíé' },
  { name:'DIAMANTE', min:1500, color:'#00d4ff', icon:'üí†' },
  { name:'MAESTRO',  min:1800, color:'#b400ff', icon:'üëë' },
  { name:'LEYENDA',  min:2100, color:'#ff003c', icon:'üî•' },
];

function getRankByElo(elo) {
  let r = RANKS_CONFIG[0];
  for (const rank of RANKS_CONFIG) { if (elo >= rank.min) r = rank; }
  return r;
}

// ‚îÄ‚îÄ WEBSOCKET STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let WS = null;
let wsConnected = false;
let wsMyId = null;
let wsUsername = '';
let wsMode = null;       // 'multiplayer' | 'competitive'
let wsRoomId = null;
let wsPlayerId = null;   // 1 or 2 in current room
let wsIsSpectator = false;
let wsPingStart = 0;
let wsPing = 0;
let wsPingInterval = null;

// Local ELO state
let myElo = 800;
let myWins = 0;
let myLosses = 0;
let myRank = RANKS_CONFIG[0];
let prevRank = RANKS_CONFIG[0];

// Input buffering for network
let pendingInputs = [];
let inputSeq = 0;

// ‚îÄ‚îÄ CONNECT / DISCONNECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wsConnect(username, mode) {
  if (WS && WS.readyState === WebSocket.OPEN) {
    wsIdentify(username);
    return;
  }
  wsUsername = username;
  wsMode = mode;

  WS = new WebSocket(WS_URL);

  WS.onopen = () => {
    wsConnected = true;
    console.log('[WS] Connected');
    wsIdentify(username);
    startPing();
    updateWsStatus(true);
  };

  WS.onmessage = (e) => {
    try { handleWsMsg(JSON.parse(e.data)); } catch(err) { console.error('[WS] Parse error', err); }
  };

  WS.onclose = () => {
    wsConnected = false;
    clearInterval(wsPingInterval);
    updateWsStatus(false);
    console.log('[WS] Disconnected');
    if (GAME.state === 'fighting' && wsPlayerId) {
      handleOpponentDisconnect();
    }
  };

  WS.onerror = (e) => {
    console.error('[WS] Error', e);
    updateWsStatus(false);
    addChat('‚ö† Error de conexi√≥n con el servidor', 'sys');
  };
}

function wsDisconnect() {
  if (WS) { WS.close(); WS = null; }
  wsConnected = false;
  wsRoomId = null;
  wsPlayerId = null;
  clearInterval(wsPingInterval);
  updateWsStatus(false);
}

function wsSend(obj) {
  if (WS && WS.readyState === WebSocket.OPEN) {
    WS.send(JSON.stringify(obj));
  }
}

function wsIdentify(username) {
  wsSend({ type: 'identify', username });
}

// ‚îÄ‚îÄ PING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startPing() {
  clearInterval(wsPingInterval);
  wsPingInterval = setInterval(() => {
    wsPingStart = Date.now();
    wsSend({ type: 'ping', t: wsPingStart });
  }, 3000);
}

// ‚îÄ‚îÄ STATUS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateWsStatus(connected) {
  const dot  = document.getElementById('wsDot');
  const label = document.getElementById('wsLabel');
  const mpDot = document.getElementById('mpDot');
  const mpSt  = document.getElementById('mpConnStatus');
  const compDot = document.getElementById('compDot');
  const compSt  = document.getElementById('compConnStatus');
  const wsBar = document.getElementById('wsStatus');

  if (dot)   dot.className   = `online-dot ${connected ? '' : 'offline'}`;
  if (label) label.textContent = connected ? `${wsUsername} ‚óè EN L√çNEA` : 'DESCONECTADO';
  if (mpDot) mpDot.className  = `online-dot ${connected ? '' : 'offline'}`;
  if (mpSt)  mpSt.textContent = connected ? `Conectado como ${wsUsername}` : 'Sin conexi√≥n';
  if (compDot) compDot.className = `online-dot ${connected ? '' : 'offline'}`;
  if (compSt)  compSt.textContent = connected ? `Conectado como ${wsUsername}` : 'Sin conexi√≥n';
  if (wsBar)   wsBar.style.display = 'flex';
}

// ‚îÄ‚îÄ MESSAGE HANDLER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleWsMsg(msg) {
  switch (msg.type) {

    case 'connected':
      wsMyId = msg.clientId;
      break;

    case 'identified':
      wsUsername = msg.username;
      myElo   = msg.elo   || 800;
      myWins  = msg.wins  || 0;
      myLosses= msg.losses|| 0;
      myRank  = msg.rank  || RANKS_CONFIG[0];
      updateWsStatus(true);
      updateCompUI();
      addChat(`‚úì Conectado como ${wsUsername}`, 'sys');
      if (wsMode === 'multiplayer') {
        document.getElementById('mpCreateBtn').disabled = false;
        document.getElementById('mpJoinBtn').disabled   = false;
        mpRefreshRooms();
      }
      if (wsMode === 'competitive') {
        document.getElementById('compSearchBtn').disabled = false;
        compLoadLeaderboard();
      }
      break;

    case 'pong':
      wsPing = Date.now() - wsPingStart;
      updatePingDisplay();
      break;

    case 'lobby_update':
      if (document.getElementById('multiplayerScreen').style.display !== 'none') {
        updateRoomListUI(msg.rooms || []);
      }
      const onlineCount = document.getElementById('mpOnlineCount');
      if (onlineCount) onlineCount.textContent = `${msg.online || 0} en l√≠nea | ${msg.queue || 0} en cola`;
      break;

    case 'room_list':
      updateRoomListUI(msg.rooms || []);
      break;

    case 'room_created':
      wsRoomId   = msg.roomId;
      wsPlayerId = msg.playerId;
      showRoomStatus(msg.roomId, true);
      addChat(`‚úì Sala ${msg.roomId} creada. Esperando rival...`, 'sys');
      break;

    case 'room_joined':
      wsRoomId   = msg.roomId;
      wsPlayerId = msg.playerId;
      showRoomStatus(msg.roomId, false);
      addChat(`‚úì Te uniste a la sala ${msg.roomId}`, 'sys');
      break;

    case 'opponent_joined':
      document.getElementById('mpOpponentName').textContent = msg.username;
      document.getElementById('mpOpponentName').style.color = 'var(--neon-red)';
      document.getElementById('mpReadyBtn').disabled = false;
      addChat(`‚öî ${msg.username} se uni√≥ a la sala (ELO: ${msg.elo})`, 'sys');
      break;

    case 'both_connected':
      document.getElementById('mpP1Name').textContent = msg.p1.username;
      document.getElementById('mpP2Name').textContent = msg.p2.username;
      document.getElementById('mpOpponentName').textContent = wsPlayerId === 1 ? msg.p2.username : msg.p1.username;
      document.getElementById('mpReadyBtn').disabled = false;
      addChat(`‚úì Ambos jugadores conectados. ¬°Pulsa LISTO!`, 'sys');
      break;

    case 'player_ready':
      addChat(`‚úì Jugador ${msg.playerId} est√° listo`, 'sys');
      break;

    case 'match_found':
      // Competitive match found
      wsRoomId   = msg.roomId;
      wsPlayerId = msg.yourId;
      showMatchFound(msg);
      break;

    case 'game_start':
      startOnlineGame(msg);
      break;

    case 'input':
      // Apply remote player input
      if (msg.playerId !== wsPlayerId) {
        applyRemoteInput(msg);
      }
      break;

    case 'state_sync':
      applyStateSync(msg.state);
      break;

    case 'round_result':
      addChat(`üèÜ Ronda: ${msg.winner} gana`, 'sys');
      break;

    case 'match_over':
      handleOnlineMatchOver(msg);
      break;

    case 'elo_update':
      handleEloUpdate(msg);
      break;

    case 'opponent_disconnected':
      handleOpponentDisconnect();
      addChat(`‚ö† Tu rival se desconect√≥`, 'sys');
      break;

    case 'queue_joined':
      showQueueStatus(true, msg.position, msg.estimated);
      break;

    case 'queue_left':
      showQueueStatus(false);
      break;

    case 'leaderboard':
      renderLeaderboard(msg.data);
      break;

    case 'chat':
      addChat(msg.text, 'other', msg.username);
      break;

    case 'error':
      addChat(`‚ö† ${msg.msg}`, 'sys');
      alert(`Error: ${msg.msg}`);
      break;
  }
}

// ‚îÄ‚îÄ MULTIPLAYER UI FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showMultiplayer() {
  hideAllScreens();
  document.getElementById('multiplayerScreen').style.display = 'flex';
  wsMode = 'multiplayer';
  // Prefill username from title or local storage
  const savedName = localStorage.getItem('nc_username') || '';
  document.getElementById('mpUsername').value = savedName;
  // Build rank tiers list
  buildRankTiersList();
}

function showCompetitive() {
  hideAllScreens();
  document.getElementById('competitiveScreen').style.display = 'flex';
  wsMode = 'competitive';
  buildRankTiersList();
  const savedName = localStorage.getItem('nc_username') || '';
  document.getElementById('compUsername').value = savedName;
  updateCompUI();
}

function hideAllScreens() {
  ['titleScreen','selectScreen','resultScreen','pauseScreen','multiplayerScreen','competitiveScreen'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  document.getElementById('hud').style.display = 'none';
  document.getElementById('moveList').style.display = 'none';
  document.getElementById('modeDisplay').style.display = 'none';
}

function mpIdentify() {
  const name = document.getElementById('mpUsername').value.trim() || 'Luchador';
  localStorage.setItem('nc_username', name);
  wsConnect(name, 'multiplayer');
}

function compIdentify() {
  const name = document.getElementById('compUsername').value.trim() || 'Luchador';
  localStorage.setItem('nc_username', name);
  wsConnect(name, 'competitive');
}

function mpCreateRoom() {
  if (!wsConnected) { alert('Con√©ctate primero'); return; }
  const pass = document.getElementById('mpRoomPass').value.trim();
  wsSend({ type: 'create_room', mode: 'casual', password: pass || null });
  document.getElementById('mpRoomCode').style.display = 'block';
}

function mpJoinRoom() {
  if (!wsConnected) { alert('Con√©ctate primero'); return; }
  const code = document.getElementById('mpJoinCode').value.trim().toUpperCase();
  const pass = document.getElementById('mpJoinPass').value.trim();
  if (!code) { alert('Introduce un c√≥digo de sala'); return; }
  wsSend({ type: 'join_room', roomId: code, password: pass || undefined });
}

function mpRefreshRooms() {
  if (wsConnected) wsSend({ type: 'get_rooms' });
}

function mpCopyCode() {
  const code = document.getElementById('mpRoomCodeVal').textContent;
  navigator.clipboard.writeText(code).catch(() => {});
  showNotification('C√≥digo copiado: ' + code);
}

function mpReady() {
  if (!wsRoomId) return;
  const charId = GAME.selectedP1 ? GAME.selectedP1.id : 0;
  wsSend({ type: 'ready', charId, stageId: GAME.stageIndex || 0 });
  document.getElementById('mpReadyBtn').disabled = true;
  document.getElementById('mpReadyBtn').textContent = '‚è≥ ESPERANDO...';
  addChat('‚úì Marcado como listo', 'sys');
}

function mpLeaveRoom() {
  wsRoomId = null; wsPlayerId = null;
  document.getElementById('mpRoomStatus').style.display = 'none';
  document.getElementById('mpReadyBtn').disabled = true;
  addChat('Saliste de la sala', 'sys');
}

function mpSendChat() {
  const inp = document.getElementById('mpChatInput');
  const text = inp.value.trim();
  if (!text || !wsConnected) return;
  wsSend({ type: 'chat', text });
  addChat(text, 'me', wsUsername);
  inp.value = '';
}

function addChat(text, type, name) {
  const box = document.getElementById('mpChatBox');
  if (!box) return;
  const msg = document.createElement('div');
  msg.className = 'chat-msg';
  if (type === 'sys') {
    msg.innerHTML = `<span class="chat-sys">${text}</span>`;
  } else {
    const nameClass = type === 'me' ? 'you' : '';
    msg.innerHTML = `<span class="chat-name ${nameClass}">${name||'?'}:</span>${text}`;
  }
  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
}

function showRoomStatus(roomId, isHost) {
  document.getElementById('mpRoomStatus').style.display = 'block';
  document.getElementById('mpMyName').textContent = wsUsername;
  document.getElementById('mpRoomCodeVal').textContent = roomId;
  if (isHost) {
    document.getElementById('mpOpponentName').textContent = 'Esperando...';
    document.getElementById('mpReadyBtn').disabled = true;
  }
}

function updateRoomListUI(rooms) {
  const list = document.getElementById('mpRoomList');
  if (!list) return;
  if (!rooms.length) {
    list.innerHTML = '<div class="room-empty">Sin salas disponibles. ¬°Crea una!</div>';
    return;
  }
  list.innerHTML = '';
  rooms.forEach(r => {
    const item = document.createElement('div');
    item.className = 'room-item';
    item.innerHTML = `
      <div class="room-item-info">
        <div class="room-item-id">${r.id}</div>
        <div class="room-item-players">${r.p1name || '???'} vs ${r.p2name || 'Esperando...'} ‚Äî ${r.players}/2 jugadores</div>
      </div>
      <div class="room-item-badge ${r.hasPass ? 'locked' : 'open'}">${r.hasPass ? 'üîí PRIVADA' : 'ABIERTA'}</div>
    `;
    item.onclick = () => {
      document.getElementById('mpJoinCode').value = r.id;
      if (r.hasPass) document.getElementById('mpJoinPass').focus();
      else mpJoinRoom();
    };
    list.appendChild(item);
  });
}

// ‚îÄ‚îÄ COMPETITIVE UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCompUI() {
  const rank = getRankByElo(myElo);
  const nextRankIdx = RANKS_CONFIG.findIndex(r => r.name === rank.name) + 1;
  const nextRank = RANKS_CONFIG[nextRankIdx];

  document.getElementById('compRankIcon').textContent  = rank.icon;
  document.getElementById('compRankName').textContent  = rank.name;
  document.getElementById('compRankBadge').style.color = rank.color;
  document.getElementById('compRankBadge').style.borderColor = rank.color;
  document.getElementById('compEloNum').textContent    = myElo;
  document.getElementById('compWins').textContent      = myWins;
  document.getElementById('compLosses').textContent    = myLosses;

  const total = myWins + myLosses;
  document.getElementById('compWinRate').textContent   = total ? Math.round(myWins/total*100)+'%' : '--';
  document.getElementById('compStreak').textContent    = '0'; // streaks managed server-side

  const rankMin = rank.min;
  const rankMax = nextRank ? nextRank.min : rankMin + 500;
  const pct = Math.min(100, ((myElo - rankMin) / (rankMax - rankMin)) * 100);
  document.getElementById('compRankProgress').style.width = pct + '%';
  document.getElementById('compRankProgress').style.background = rank.color;
  document.getElementById('compRankProgress').style.boxShadow = `0 0 5px ${rank.color}`;
  document.getElementById('compRankMin').textContent  = `${rankMin} ELO`;
  document.getElementById('compRankNext').textContent = nextRank ? `Pr√≥ximo: ${nextRank.name} (${nextRank.min})` : '‚≠ê RANGO M√ÅXIMO';
}

function buildRankTiersList() {
  const container = document.getElementById('rankTiersList');
  if (!container) return;
  container.innerHTML = '';
  RANKS_CONFIG.forEach(r => {
    const row = document.createElement('div');
    row.style.cssText = `display:flex;align-items:center;gap:8px;padding:4px 8px;border:1px solid ${r.color}22;`;
    if (r.name === myRank.name) row.style.background = `${r.color}11`;
    row.innerHTML = `
      <span style="font-size:14px">${r.icon}</span>
      <span style="font-size:10px;font-weight:700;color:${r.color};letter-spacing:2px;flex:1">${r.name}</span>
      <span style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,.4)">${r.min}+ ELO</span>
      ${r.name === myRank.name ? '<span style="font-family:Rajdhani;font-size:8px;color:'+r.color+'">‚óÄ T√ö</span>' : ''}
    `;
    container.appendChild(row);
  });
}

function compSearch() {
  if (!wsConnected) { alert('Con√©ctate primero'); return; }
  const charId = GAME.selectedP1 ? GAME.selectedP1.id : 0;
  wsSend({ type: 'queue_join', charId });
}

function compCancelSearch() {
  wsSend({ type: 'queue_leave' });
  showQueueStatus(false);
}

function compSearchAgain() {
  document.getElementById('eloResultOverlay').classList.remove('active');
  showCompetitive();
}

function showQueueStatus(active, pos, eta) {
  const sec   = document.getElementById('compQueueSection');
  const status= document.getElementById('compQueueStatus');
  if (active) {
    sec.style.display    = 'none';
    status.style.display = 'block';
    if (pos)  document.getElementById('compQueueCount').textContent = pos;
    if (eta)  document.getElementById('compQueueEta').textContent   = `~${eta}s`;
  } else {
    sec.style.display    = 'block';
    status.style.display = 'none';
  }
}

function compLoadLeaderboard() {
  if (wsConnected) wsSend({ type: 'get_leaderboard' });
}

function renderLeaderboard(data) {
  const list = document.getElementById('compLeaderboard');
  if (!list) return;
  list.innerHTML = '';
  if (!data.length) { list.innerHTML = '<div class="room-empty">Sin datos</div>'; return; }
  data.forEach((p, i) => {
    const rank = p.rank || getRankByElo(p.elo);
    const row = document.createElement('div');
    row.className = 'lb-row' + (p.username === wsUsername ? ' me' : '');
    row.innerHTML = `
      <div class="lb-pos">${i+1}</div>
      <div class="lb-name" style="color:${rank.color}">${p.username}</div>
      <div class="lb-elo">${p.elo}</div>
      <div class="lb-rank" style="color:${rank.color}">${rank.icon} ${rank.name}</div>
    `;
    list.appendChild(row);
  });
}

function updatePingDisplay() {
  const el = document.getElementById('pingDisplay');
  if (!el) return;
  el.textContent = `PING: ${wsPing}ms`;
  el.className = `ping-display ${wsPing < 60 ? 'good' : wsPing < 120 ? 'medium' : 'bad'}`;
  const lbl = document.getElementById('pingLabel');
  if (lbl) lbl.textContent = `${wsPing}ms`;
}

// ‚îÄ‚îÄ MATCH FOUND OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mfTimerInterval = null;

function showMatchFound(msg) {
  hideAllScreens();
  document.getElementById('matchFoundOverlay').classList.add('active');
  document.getElementById('mfP1Name').textContent  = msg.p1.username;
  document.getElementById('mfP2Name').textContent  = msg.p2.username;
  document.getElementById('mfP1Elo').textContent   = msg.p1.elo;
  document.getElementById('mfP2Elo').textContent   = msg.p2.elo;

  const r1 = msg.p1.rank || getRankByElo(msg.p1.elo);
  const r2 = msg.p2.rank || getRankByElo(msg.p2.elo);
  const rb1 = document.getElementById('mfP1Rank');
  const rb2 = document.getElementById('mfP2Rank');
  rb1.textContent = `${r1.icon} ${r1.name}`;
  rb1.style.color = rb1.style.borderColor = r1.color;
  rb2.textContent = `${r2.icon} ${r2.name}`;
  rb2.style.color = rb2.style.borderColor = r2.color;

  // 8 second countdown
  let timeLeft = 8;
  const fill = document.getElementById('mfTimerFill');
  const cnt  = document.getElementById('mfCountdown');
  clearInterval(mfTimerInterval);
  mfTimerInterval = setInterval(() => {
    timeLeft--;
    fill.style.width = (timeLeft / 8 * 100) + '%';
    cnt.textContent  = timeLeft;
    cnt.style.animation = 'none';
    cnt.offsetHeight; // reflow
    cnt.style.animation = 'cntAnim .8s ease-out';
    if (timeLeft <= 0) { clearInterval(mfTimerInterval); }
  }, 1000);
}

// ‚îÄ‚îÄ ONLINE GAME START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startOnlineGame(msg) {
  clearInterval(mfTimerInterval);
  document.getElementById('matchFoundOverlay').classList.remove('active');
  document.getElementById('eloResultOverlay').classList.remove('active');

  // Map charIds to local character data
  const charP1 = CHARACTERS[msg.p1.charId] || CHARACTERS[0];
  const charP2 = CHARACTERS[msg.p2.charId] || CHARACTERS[1];

  GAME.selectedP1 = charP1;
  GAME.selectedP2 = charP2;
  GAME.stageIndex = msg.stageId || 0;
  GAME.mode = wsRoomId && wsRoomId.startsWith('COMP') ? 'competitive_online' : 'multiplayer';
  GAME.round = 1;
  GAME.p1Wins = 0;
  GAME.p2Wins = 0;
  GAME.roundOver = false;

  // Init fighters
  p1 = new Fighter(charP1, 200, true, 1);
  p2 = new Fighter(charP2, 700, false, 2);

  // In multiplayer: P1 is always local, P2 is remote (or vice versa based on wsPlayerId)
  // wsPlayerId === 1 means we ARE player 1
  // wsPlayerId === 2 means we ARE player 2 (p2 is local, p1 is remote)

  document.getElementById('hud').style.display = 'flex';
  document.getElementById('moveList').style.display = 'flex';
  document.getElementById('modeDisplay').style.display = 'block';
  document.getElementById('modeDisplay').textContent = GAME.mode === 'competitive_online' ? '‚öî COMPETITIVO' : 'üåê MULTIJUGADOR';
  document.getElementById('p1Name').textContent = msg.p1.username;
  document.getElementById('p2Name').textContent = msg.p2.username;
  document.getElementById('roundDisplay').textContent = 'ROUND 1';
  document.getElementById('pingDisplay').style.display = 'block';

  // Spectator mode if applicable
  if (wsIsSpectator) {
    document.getElementById('spectatorBar').style.display = 'block';
  }

  GAME.state = 'fighting';
  particles.length = 0;
  updateWinDots();
  updateHUD();
  particles.length = 0;

  announce('ROUND 1', 'round', 1400);
  setTimeout(() => {
    announce('FIGHT!', 'fight', 1200);
    startTimer();
  }, 1500);

  GAME.lastTime = performance.now();
  cancelAnimationFrame(GAME.animFrame);
  GAME.animFrame = requestAnimationFrame(onlineGameLoop);
}

// ‚îÄ‚îÄ ONLINE GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onlineGameLoop(timestamp) {
  if (GAME.state !== 'fighting') return;

  GAME.dt = Math.min((timestamp - GAME.lastTime) / 16.67, 3);
  GAME.lastTime = timestamp;

  ctx.clearRect(0, 0, W, H);

  if (!GAME.paused) {
    // Process LOCAL player input
    processOnlineInput();

    // Update both fighters (physics + state)
    if (!GAME.roundOver) {
      if (p1) p1.facingRight = p2 ? p1.x < p2.x : true;
      if (p2) p2.facingRight = p1 ? p2.x < p1.x : false;
      if (p1) p1.update();
      if (p2) p2.update();

      // Only authoritative player (P1 host) checks hits and syncs state
      if (wsPlayerId === 1) {
        checkHits();
        checkRoundOver();
        // Sync state every 3 frames
        if (Math.round(timestamp) % 3 === 0) {
          syncGameState();
        }
      }
      updateParticles();
      updateScreenEffects();
    } else {
      if (p1) p1.update();
      if (p2) p2.update();
      updateParticles();
      updateScreenEffects();
    }
  }

  // Draw
  drawStage();
  if (p1) p1.draw();
  if (p2) p2.draw();
  drawParticles();

  GAME.animFrame = requestAnimationFrame(onlineGameLoop);
}

function processOnlineInput() {
  if (!p1 || GAME.roundOver) return;

  // Determine which fighter WE control
  const myFighter = wsPlayerId === 1 ? p1 : p2;
  if (!myFighter) return;

  let inputChanged = false;
  const input = {
    left:    keys['KeyA']  || false,
    right:   keys['KeyD']  || false,
    up:      keys['KeyW']  || keys['Space'] || false,
    down:    keys['KeyS']  || false,
    light:   false, heavy: false, kick: false, special: false, super: false,
  };

  // Apply movement
  if (input.left)  { myFighter.move(-myFighter.char.speed); inputChanged = true; }
  if (input.right) { myFighter.move(myFighter.char.speed);  inputChanged = true; }
  if (input.up && myFighter.onGround) myFighter.jump();
  if (input.down)  myFighter.crouch();

  // Send input to server (sends every frame for smooth experience)
  wsSend({ type: 'input', ...input, x: myFighter.x, y: myFighter.y, state: myFighter.state, seq: ++inputSeq });
}

function applyRemoteInput(msg) {
  // Apply remote player's position + state
  const remoteFighter = wsPlayerId === 1 ? p2 : p1;
  if (!remoteFighter) return;

  // Reconcile position
  if (msg.x !== undefined) {
    remoteFighter.x = remoteFighter.x * 0.7 + msg.x * 0.3; // smooth interpolation
  }
  if (msg.state && !['hurt','ko','dead'].includes(remoteFighter.state)) {
    if (msg.left)  remoteFighter.move(-remoteFighter.char.speed);
    if (msg.right) remoteFighter.move(remoteFighter.char.speed);
    if (msg.up && remoteFighter.onGround) remoteFighter.jump();
    if (msg.down)  remoteFighter.crouch();
  }
}

function syncGameState() {
  if (wsPlayerId !== 1) return;
  wsSend({
    type: 'state_sync',
    state: {
      p1: { x: p1.x, y: p1.y, hp: p1.hp, sp: p1.sp, state: p1.state, vx: p1.vx, vy: p1.vy },
      p2: { x: p2.x, y: p2.y, hp: p2.hp, sp: p2.sp, state: p2.state, vx: p2.vx, vy: p2.vy },
    }
  });
}

function applyStateSync(state) {
  if (wsPlayerId === 1) return; // P1 doesn't apply its own sync
  if (!state) return;
  if (p1 && state.p1) {
    p1.x  = p1.x * 0.6 + state.p1.x * 0.4;
    p1.hp = state.p1.hp;
    p1.sp = state.p1.sp;
    if (!['hurt','ko'].includes(p1.state)) p1.state = state.p1.state;
  }
  if (p2 && state.p2) {
    p2.x  = p2.x * 0.6 + state.p2.x * 0.4;
    p2.hp = state.p2.hp;
    p2.sp = state.p2.sp;
    if (!['hurt','ko'].includes(p2.state)) p2.state = state.p2.state;
  }
  updateHUD();
}

// ‚îÄ‚îÄ ONLINE ROUND OVER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleOnlineMatchOver(msg) {
  GAME.state = 'result';
  cancelAnimationFrame(GAME.animFrame);
  clearInterval(GAME.timerInterval);
  document.getElementById('pingDisplay').style.display = 'none';

  if (wsRoomId && wsRoomId.startsWith('COMP')) {
    // Show competitive result (wait for elo_update)
    setTimeout(() => {
      if (!document.getElementById('eloResultOverlay').classList.contains('active')) {
        showCompResult(msg.winner, 0, myElo, null);
      }
    }, 3000);
  } else {
    // Casual multiplayer ‚Äî show normal result screen
    document.getElementById('resultScreen').style.display = 'flex';
    document.getElementById('resultTitle').textContent = msg.winner === wsUsername ? '¬°VICTORIA!' : 'DERROTA';
    document.getElementById('resultTitle').style.color = msg.winner === wsUsername ? 'var(--neon-yellow)' : 'var(--neon-red)';
    document.getElementById('resultWinner').textContent = msg.winner;
  }
}

function handleEloUpdate(msg) {
  const isWinner = msg.winner === wsUsername;
  const eloChange = isWinner ? msg.winnerGain : -msg.loserLoss;
  const newElo    = isWinner ? msg.winnerElo  : msg.loserElo;
  const newRank   = isWinner ? msg.winnerRank : msg.loserRank;

  prevRank = myRank;
  myElo    = newElo;
  myRank   = newRank;
  if (isWinner) myWins++; else myLosses++;

  showCompResult(msg.winner, eloChange, newElo, newRank);
}

function showCompResult(winner, eloChange, newElo, newRank) {
  document.getElementById('eloResultOverlay').classList.add('active');

  const isMe = winner === wsUsername;
  document.getElementById('eloResWinner').textContent = isMe ? '¬°VICTORIA!' : 'DERROTA';
  document.getElementById('eloResWinner').style.color = isMe ? 'var(--neon-yellow)' : 'var(--neon-red)';

  const changeEl = document.getElementById('eloResChange');
  changeEl.textContent  = (eloChange >= 0 ? '+' : '') + eloChange + ' ELO';
  changeEl.className    = `elo-change ${eloChange >= 0 ? 'gain' : 'loss'}`;

  document.getElementById('eloResNewElo').textContent = `ELO: ${newElo}`;

  if (newRank) {
    const rb = document.getElementById('eloResRank');
    rb.textContent    = `${newRank.icon} ${newRank.name}`;
    rb.style.color    = newRank.color;
    rb.style.borderColor = newRank.color;
  }

  // Rank up?
  if (newRank && prevRank && newRank.name !== prevRank.name && eloChange > 0) {
    document.getElementById('eloRankUp').style.display = 'block';
    showNotification(`‚¨Ü ¬°SUBISTE A ${newRank.name}!`);
    playSound('ko'); // reuse as celebration sound
  } else {
    document.getElementById('eloRankUp').style.display = 'none';
  }
}

function handleOpponentDisconnect() {
  if (GAME.state !== 'fighting') return;
  GAME.roundOver = true;
  GAME.state = 'result';
  cancelAnimationFrame(GAME.animFrame);
  clearInterval(GAME.timerInterval);
  announce('RIVAL<br>DESCONECTADO', 'fight', 2500);
  setTimeout(() => {
    document.getElementById('resultScreen').style.display = 'flex';
    document.getElementById('resultTitle').textContent = 'VICTORIA!';
    document.getElementById('resultTitle').style.color = 'var(--neon-yellow)';
    document.getElementById('resultWinner').textContent = wsUsername + ' (rival desconectado)';
  }, 2600);
}

// ‚îÄ‚îÄ NOTIFICATION HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _notifTO = null;
function showNotification(msg) {
  // Reuse existing announcer for brief notifications
  const el = document.getElementById('announcer');
  if (el) { announce(msg, 'fight', 1600); }
}

// ‚îÄ‚îÄ KEY HANDLER ADDITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Patch attack handler to also send inputs to server
const _origKeydown = document.onkeydown;
document.addEventListener('keydown', (e) => {
  if (GAME.state !== 'fighting' || GAME.paused || !wsPlayerId) return;
  const myFighter = wsPlayerId === 1 ? p1 : p2;
  if (!myFighter) return;

  let attackType = null;
  if (e.code === 'KeyF') attackType = 'light';
  if (e.code === 'KeyR') attackType = 'heavy';
  if (e.code === 'KeyG') attackType = 'kick';
  if (e.code === 'KeyH') attackType = myFighter.superMeter >= myFighter.maxSuper ? 'super' : 'special';

  if (attackType) {
    myFighter.attack(attackType);
    wsSend({ type: 'input', attack: attackType, seq: ++inputSeq });
  }
});

// Override applyRemoteInput for attacks
const _origApplyRemote = applyRemoteInput;
function applyRemoteInput(msg) {
  const remoteFighter = wsPlayerId === 1 ? p2 : p1;
  if (!remoteFighter) return;

  if (msg.attack) {
    remoteFighter.attack(msg.attack);
    return;
  }

  if (msg.x !== undefined) remoteFighter.x = remoteFighter.x * 0.7 + msg.x * 0.3;
  if (msg.left)  remoteFighter.move(-remoteFighter.char.speed);
  if (msg.right) remoteFighter.move(remoteFighter.char.speed);
  if (msg.up && remoteFighter.onGround) remoteFighter.jump();
  if (msg.down)  remoteFighter.crouch();
}

// Wire up match_over reporting from existing checkRoundOver
const _origShowResult = showResult;
function showResult() {
  _origShowResult();
  if (wsPlayerId && wsRoomId) {
    const winsNeeded = Math.ceil(GAME.maxRounds / 2);
    let winner = '';
    if (GAME.p1Wins >= winsNeeded) winner = document.getElementById('p1Name').textContent;
    else if (GAME.p2Wins >= winsNeeded) winner = document.getElementById('p2Name').textContent;
    wsSend({
      type: 'match_over',
      winner,
      stats: { p1Wins: GAME.p1Wins, p2Wins: GAME.p2Wins }
    });
  }
}
</script>
</body>
</html>
