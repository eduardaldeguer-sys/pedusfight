<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEON CLASH v2 - Ultimate Fighting</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&family=Share+Tech+Mono&display=swap');
:root {
  --c-red:#ff003c; --c-blue:#00d4ff; --c-yellow:#ffe600; --c-green:#00ff88;
  --c-purple:#b400ff; --c-orange:#ff7700; --c-pink:#ff00aa; --c-cyan:#00ffee;
  --dark:#050510; --dark2:#08081a; --panel:rgba(5,5,20,0.96);
  --gr:#0a0a22; --border:rgba(0,212,255,0.3);
  --glow-r:0 0 10px #ff003c,0 0 25px #ff003c;
  --glow-b:0 0 10px #00d4ff,0 0 25px #00d4ff;
  --glow-y:0 0 10px #ffe600,0 0 20px #ffe600;
  --glow-g:0 0 10px #00ff88,0 0 20px #00ff88;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;font-family:'Orbitron',monospace;overflow:hidden;width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;}
#gc{position:relative;width:960px;height:620px;background:var(--dark);border:1px solid var(--c-blue);box-shadow:var(--glow-b),inset 0 0 80px rgba(0,212,255,0.03);overflow:hidden;}
canvas#gC{position:absolute;top:0;left:0;width:100%;height:100%;}

/* â”€â”€ SCANLINES & VIGNETTE â”€â”€ */
.sl{position:absolute;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.07) 2px,rgba(0,0,0,0.07) 4px);pointer-events:none;z-index:998;}
.vg{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at center,transparent 55%,rgba(0,0,0,0.75) 100%);pointer-events:none;z-index:997;}
#sf{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:996;opacity:0;}

/* â”€â”€ SCREENS â”€â”€ */
.scr{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;}

/* â•â• TITLE â•â• */
#scrTitle{background:radial-gradient(ellipse at 50% 60%,#0a0a30 0%,#000 70%);}
.bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(0,212,255,0.06) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.06) 1px,transparent 1px);background-size:45px 45px;animation:gridMove 10s linear infinite;}
@keyframes gridMove{0%{transform:translateY(0)}100%{transform:translateY(45px)}}
.logo{font-size:78px;font-weight:900;letter-spacing:6px;line-height:1;text-shadow:var(--glow-b),0 0 80px rgba(0,212,255,0.4);z-index:1;}
.logo span{color:var(--c-red);text-shadow:var(--glow-r),0 0 80px rgba(255,0,60,0.4);}
.logo-sub{font-family:'Rajdhani',sans-serif;font-size:13px;letter-spacing:14px;color:var(--c-yellow);text-shadow:var(--glow-y);margin-top:6px;z-index:1;}
.logo-ver{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,0.3);margin-top:3px;z-index:1;}
.title-menu{display:flex;gap:10px;margin-top:40px;z-index:1;flex-wrap:wrap;justify-content:center;max-width:500px;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:12px 28px;background:transparent;border:1px solid var(--c-blue);color:var(--c-blue);font-family:'Orbitron',monospace;font-size:11px;font-weight:700;letter-spacing:3px;cursor:pointer;text-transform:uppercase;transition:all .18s;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);position:relative;overflow:hidden;}
.btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,212,255,0.15),transparent);transition:left .35s;}
.btn:hover::after{left:100%}
.btn:hover{background:rgba(0,212,255,0.12);box-shadow:var(--glow-b);color:#fff;transform:translateY(-1px);}
.btn.red{border-color:var(--c-red);color:var(--c-red);}
.btn.red:hover{background:rgba(255,0,60,0.12);box-shadow:var(--glow-r);}
.btn.yellow{border-color:var(--c-yellow);color:var(--c-yellow);}
.btn.yellow:hover{background:rgba(255,230,0,0.12);box-shadow:var(--glow-y);}
.btn.green{border-color:var(--c-green);color:var(--c-green);}
.btn.green:hover{background:rgba(0,255,136,0.12);box-shadow:var(--glow-g);}
.btn.big{font-size:14px;padding:16px 40px;letter-spacing:5px;}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none;}

/* â•â• CHARACTER SELECT â•â• */
#scrSelect{background:linear-gradient(160deg,#050514,#0a0522);display:none;}
.sel-header{font-size:18px;letter-spacing:8px;color:var(--c-yellow);text-shadow:var(--glow-y);margin-bottom:16px;}
.sel-layout{display:grid;grid-template-columns:1fr 220px 1fr;gap:16px;width:100%;padding:0 20px;}
.sel-side{display:flex;flex-direction:column;gap:10px;}
.sel-side-title{font-size:9px;letter-spacing:5px;text-align:center;padding:4px;}
.sel-side-title.p1c{color:var(--c-blue);text-shadow:var(--glow-b);}
.sel-side-title.p2c{color:var(--c-red);text-shadow:var(--glow-r);}
.char-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.ccard{width:100%;aspect-ratio:3/4;border:1px solid rgba(255,255,255,0.12);cursor:pointer;position:relative;overflow:hidden;transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:6px;}
.ccard canvas{position:absolute;top:0;left:0;width:100%;height:100%;}
.ccard-name{font-size:8px;font-weight:700;letter-spacing:1px;z-index:1;text-shadow:0 0 8px #000,0 0 4px #000;}
.ccard-type{font-family:'Rajdhani';font-size:7px;color:rgba(255,255,255,0.5);z-index:1;}
.ccard:hover{transform:translateY(-3px);border-color:var(--c-yellow);box-shadow:0 0 12px rgba(255,230,0,0.4);}
.ccard.sp1{border-color:var(--c-blue);box-shadow:var(--glow-b);}
.ccard.sp2{border-color:var(--c-red);box-shadow:var(--glow-r);}
.ccard.locked{opacity:.4;cursor:not-allowed;}
.ccard.locked::after{content:'ğŸ”’';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;z-index:2;}
.sel-center{display:flex;flex-direction:column;align-items:center;gap:12px;}
.vs-text{font-size:42px;font-weight:900;color:var(--c-yellow);text-shadow:var(--glow-y);animation:vsPulse 1s ease-in-out infinite alternate;}
@keyframes vsPulse{from{transform:scale(1)}to{transform:scale(1.08)}}
.preview-box{display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;}
.prev-name{font-size:14px;font-weight:900;letter-spacing:3px;}
.prev-name.p1c{color:var(--c-blue);text-shadow:var(--glow-b);}
.prev-name.p2c{color:var(--c-red);text-shadow:var(--glow-r);}
.stat-row{display:flex;align-items:center;gap:5px;width:100%;}
.stat-lbl{font-family:'Share Tech Mono';font-size:8px;color:rgba(255,255,255,0.5);width:28px;}
.stat-bg{flex:1;height:4px;background:rgba(255,255,255,0.08);}
.stat-fill{height:100%;background:var(--c-yellow);box-shadow:0 0 4px var(--c-yellow);transition:width .3s;}
.prev-ability{font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.4);text-align:center;letter-spacing:1px;margin-top:2px;}

/* â•â• HUD â•â• */
#hud{position:absolute;top:0;left:0;width:100%;height:86px;display:flex;align-items:flex-start;justify-content:space-between;padding:10px 12px 0;z-index:50;pointer-events:none;display:none;}
.phud{display:flex;flex-direction:column;gap:4px;width:300px;}
.phud.r{align-items:flex-end;}
.pname{font-size:10px;font-weight:700;letter-spacing:3px;}
.pname.p1c{color:var(--c-blue);text-shadow:var(--glow-b);}
.pname.p2c{color:var(--c-red);text-shadow:var(--glow-r);}
.hpbar{width:100%;height:16px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.1);position:relative;overflow:hidden;}
.hpfill{height:100%;transition:width .12s ease-out;position:absolute;top:0;}
.hpfill.p1c{left:0;background:linear-gradient(90deg,#00ff88,#00d4ff);box-shadow:0 0 8px rgba(0,212,255,0.7);}
.hpfill.p2c{right:0;background:linear-gradient(270deg,#ff003c,#ff7700);box-shadow:0 0 8px rgba(255,0,60,0.7);}
.hptxt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8px;font-weight:700;color:rgba(255,255,255,0.9);z-index:2;}
.sbar{width:100%;height:6px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.08);position:relative;overflow:hidden;}
.sfill{height:100%;transition:width .2s;}
.sfill.p1c{background:linear-gradient(90deg,var(--c-yellow),var(--c-green));box-shadow:0 0 5px var(--c-yellow);}
.sfill.p2c{float:right;background:linear-gradient(270deg,var(--c-yellow),var(--c-purple));box-shadow:0 0 5px var(--c-yellow);}
.xpbar{width:100%;height:3px;background:rgba(255,255,255,0.05);}
.xpfill{height:100%;background:var(--c-cyan);box-shadow:0 0 4px var(--c-cyan);transition:width .4s;}
.wdots{display:flex;gap:4px;}
.wd{width:10px;height:10px;border-radius:50%;border:1px solid rgba(255,255,255,0.25);}
.wd.f1{background:var(--c-blue);box-shadow:var(--glow-b);border-color:var(--c-blue);}
.wd.f2{background:var(--c-red);box-shadow:var(--glow-r);border-color:var(--c-red);}
.lv-badge{font-family:'Share Tech Mono';font-size:8px;color:var(--c-yellow);text-shadow:var(--glow-y);}
.timer-box{display:flex;flex-direction:column;align-items:center;}
.rnd-lbl{font-size:9px;letter-spacing:4px;color:var(--c-yellow);text-shadow:var(--glow-y);}
.timer-num{font-size:34px;font-weight:900;color:#fff;text-shadow:0 0 12px rgba(255,255,255,0.8);min-width:60px;text-align:center;line-height:1;}
.timer-num.urg{color:var(--c-red);text-shadow:var(--glow-r);animation:tUrg .5s ease-in-out infinite alternate;}
@keyframes tUrg{from{transform:scale(1)}to{transform:scale(1.06)}}

/* â•â• ANNOUNCER â•â• */
#ann{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:54px;font-weight:900;text-align:center;letter-spacing:5px;pointer-events:none;z-index:200;opacity:0;}
#ann.show{animation:annAnim 1.8s ease-out forwards;}
@keyframes annAnim{0%{opacity:0;transform:translate(-50%,-50%) scale(2.2)}15%{opacity:1;transform:translate(-50%,-50%) scale(1)}70%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(0.85)}}
#ann.fight{color:var(--c-yellow);text-shadow:var(--glow-y),0 0 80px rgba(255,230,0,0.5);}
#ann.ko{color:var(--c-red);text-shadow:var(--glow-r),0 0 80px rgba(255,0,60,0.5);}
#ann.rnd{color:#fff;text-shadow:0 0 20px #fff;font-size:34px;}
#ann.win{font-size:26px;line-height:1.5;}

/* â•â• COMBO â•â• */
.combo{position:absolute;bottom:100px;font-weight:900;pointer-events:none;z-index:80;opacity:0;transition:opacity .25s;}
.combo.p1c{left:16px;color:var(--c-blue);text-shadow:var(--glow-b);}
.combo.p2c{right:16px;color:var(--c-red);text-shadow:var(--glow-r);text-align:right;}
.combo.on{opacity:1;}
.c-num{font-size:58px;line-height:1;}
.c-txt{font-size:12px;letter-spacing:4px;}

/* â•â• DAMAGE NUMBERS â•â• */
.dmg{position:absolute;font-weight:900;pointer-events:none;z-index:90;animation:floatUp .85s ease-out forwards;font-family:'Orbitron',monospace;}
.dmg.n{color:var(--c-yellow);text-shadow:var(--glow-y);font-size:20px;}
.dmg.c{color:var(--c-red);text-shadow:var(--glow-r);font-size:28px;}
.dmg.s{color:var(--c-purple);text-shadow:0 0 10px var(--c-purple),0 0 25px var(--c-purple);font-size:34px;}
.dmg.h{color:var(--c-green);text-shadow:var(--glow-g);font-size:22px;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}50%{opacity:1;transform:translateY(-40px) scale(1.1)}100%{opacity:0;transform:translateY(-85px) scale(0.8)}}

/* â•â• ABILITY NOTIFICATION â•â• */
#abilNotif{position:absolute;top:100px;left:50%;transform:translateX(-50%);font-family:'Rajdhani';font-size:13px;letter-spacing:4px;color:var(--c-green);text-shadow:var(--glow-g);border:1px solid var(--c-green);padding:8px 20px;background:rgba(0,255,136,0.1);z-index:300;opacity:0;transition:opacity .3s;pointer-events:none;}

/* â•â• MODE MENU â•â• */
#scrModes{background:linear-gradient(135deg,#050510,#0a0518);display:none;}
.mode-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:20px;width:100%;}
.mode-card{border:1px solid rgba(255,255,255,0.12);padding:18px 12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .2s;position:relative;overflow:hidden;}
.mode-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity .2s;}
.mode-card:hover{transform:translateY(-3px);}
.mode-icon{font-size:32px;}
.mode-name{font-size:12px;font-weight:700;letter-spacing:3px;}
.mode-desc{font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.5);text-align:center;line-height:1.4;}
.mode-card.vs .mode-name{color:var(--c-blue);}
.mode-card.vs{border-color:rgba(0,212,255,0.3);}
.mode-card.vs:hover{border-color:var(--c-blue);box-shadow:0 0 20px rgba(0,212,255,0.2);}
.mode-card.ai .mode-name{color:var(--c-red);}
.mode-card.ai{border-color:rgba(255,0,60,0.3);}
.mode-card.ai:hover{border-color:var(--c-red);box-shadow:0 0 20px rgba(255,0,60,0.2);}
.mode-card.arcade .mode-name{color:var(--c-yellow);}
.mode-card.arcade{border-color:rgba(255,230,0,0.3);}
.mode-card.arcade:hover{border-color:var(--c-yellow);box-shadow:0 0 20px rgba(255,230,0,0.2);}
.mode-card.survival .mode-name{color:var(--c-green);}
.mode-card.survival{border-color:rgba(0,255,136,0.3);}
.mode-card.survival:hover{border-color:var(--c-green);box-shadow:0 0 20px rgba(0,255,136,0.2);}
.mode-card.training .mode-name{color:var(--c-purple);}
.mode-card.training{border-color:rgba(180,0,255,0.3);}
.mode-card.training:hover{border-color:var(--c-purple);box-shadow:0 0 20px rgba(180,0,255,0.2);}
.mode-card.tourn .mode-name{color:var(--c-orange);}
.mode-card.tourn{border-color:rgba(255,119,0,0.3);}
.mode-card.tourn:hover{border-color:var(--c-orange);box-shadow:0 0 20px rgba(255,119,0,0.2);}

/* â•â• AI DIFFICULTY â•â• */
#scrDiff{background:linear-gradient(135deg,#050510,#0a0518);display:none;}
.diff-cards{display:flex;gap:14px;margin-top:20px;}
.diff-card{width:140px;padding:20px 14px;border:1px solid rgba(255,255,255,0.12);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .2s;}
.diff-card:hover{transform:translateY(-3px);}
.diff-card.easy{border-color:rgba(0,255,136,0.3);}
.diff-card.easy:hover{border-color:var(--c-green);box-shadow:0 0 18px rgba(0,255,136,0.25);}
.diff-card.med{border-color:rgba(255,230,0,0.3);}
.diff-card.med:hover{border-color:var(--c-yellow);box-shadow:0 0 18px rgba(255,230,0,0.25);}
.diff-card.hard{border-color:rgba(255,119,0,0.3);}
.diff-card.hard:hover{border-color:var(--c-orange);box-shadow:0 0 18px rgba(255,119,0,0.25);}
.diff-card.god{border-color:rgba(180,0,255,0.3);}
.diff-card.god:hover{border-color:var(--c-purple);box-shadow:0 0 18px rgba(180,0,255,0.25);}
.diff-icon{font-size:28px;}
.diff-name{font-size:12px;font-weight:700;letter-spacing:3px;}
.diff-desc{font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.45);text-align:center;line-height:1.4;}

/* â•â• PROFILE / SETTINGS PANEL â•â• */
#scrProfile{background:linear-gradient(135deg,#050510,#080520);display:none;}
.profile-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;width:100%;padding:10px 30px;max-height:500px;overflow-y:auto;}
.profile-layout::-webkit-scrollbar{width:4px;}
.profile-layout::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);}
.profile-layout::-webkit-scrollbar-thumb{background:var(--c-blue);}
.panel-box{border:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:12px;}
.panel-title{font-size:11px;letter-spacing:4px;color:var(--c-yellow);text-shadow:var(--glow-y);border-bottom:1px solid rgba(255,230,0,0.2);padding-bottom:6px;}
.input-row{display:flex;flex-direction:column;gap:4px;}
.input-lbl{font-family:'Rajdhani';font-size:10px;letter-spacing:2px;color:rgba(255,255,255,0.5);}
.input-field{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#fff;font-family:'Orbitron',monospace;font-size:11px;padding:8px 10px;outline:none;width:100%;transition:border-color .2s;}
.input-field:focus{border-color:var(--c-blue);box-shadow:0 0 8px rgba(0,212,255,0.3);}
.xp-section{display:flex;flex-direction:column;gap:6px;}
.xp-header{display:flex;justify-content:space-between;align-items:center;}
.xp-lvl{font-size:20px;font-weight:900;color:var(--c-yellow);text-shadow:var(--glow-y);}
.xp-prog{font-family:'Share Tech Mono';font-size:9px;color:rgba(255,255,255,0.4);}
.xp-bar-bg{width:100%;height:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--c-yellow),var(--c-green));box-shadow:0 0 8px var(--c-yellow);transition:width .6s ease-out;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.stat-item{display:flex;flex-direction:column;gap:2px;}
.stat-item-lbl{font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:1px;}
.stat-item-val{font-family:'Share Tech Mono';font-size:13px;color:var(--c-cyan);}
.abilities-list{display:flex;flex-direction:column;gap:5px;max-height:160px;overflow-y:auto;}
.ability-item{padding:6px 8px;border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;gap:8px;}
.ability-item.unlocked{border-color:rgba(0,255,136,0.3);background:rgba(0,255,136,0.05);}
.ability-item.locked{opacity:.4;}
.ability-icon{font-size:14px;}
.ability-info{flex:1;}
.ability-name{font-size:9px;font-weight:700;letter-spacing:1px;color:var(--c-green);}
.ability-name.locked{color:rgba(255,255,255,0.3);}
.ability-desc{font-family:'Rajdhani';font-size:8px;color:rgba(255,255,255,0.4);}
.ability-lvl{font-family:'Share Tech Mono';font-size:8px;color:rgba(255,255,255,0.3);}

/* â•â• CONTROLS SETTINGS â•â• */
.controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.ctrl-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.ctrl-action{font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.6);letter-spacing:1px;}
.ctrl-key{padding:4px 10px;border:1px solid rgba(255,255,255,0.2);font-family:'Share Tech Mono';font-size:9px;color:#fff;background:rgba(255,255,255,0.05);cursor:pointer;min-width:60px;text-align:center;transition:all .2s;}
.ctrl-key:hover{border-color:var(--c-yellow);color:var(--c-yellow);}
.ctrl-key.listening{border-color:var(--c-blue);color:var(--c-blue);box-shadow:var(--glow-b);animation:blink .5s ease-in-out infinite alternate;}
@keyframes blink{from{opacity:.5}to{opacity:1}}

/* â•â• STAGE SELECT â•â• */
#scrStage{background:linear-gradient(135deg,#050510,#0a0820);display:none;}
.stage-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:0 20px;width:100%;}
.stcard{border:1px solid rgba(255,255,255,0.1);cursor:pointer;transition:all .2s;position:relative;overflow:hidden;aspect-ratio:16/9;}
.stcard canvas{width:100%;height:100%;display:block;}
.stcard-name{position:absolute;bottom:0;left:0;right:0;padding:6px;font-size:9px;font-weight:700;letter-spacing:2px;text-align:center;background:rgba(0,0,0,0.7);}
.stcard:hover{transform:scale(1.03);border-color:var(--c-yellow);box-shadow:0 0 15px rgba(255,230,0,0.3);}
.stcard.sel{border-color:var(--c-yellow);box-shadow:var(--glow-y);}
.stcard.locked::after{content:'ğŸ”’';position:absolute;top:50%;left:50%;transform:translate(-50%,-70%);font-size:22px;z-index:2;}
.stcard.locked{opacity:.5;cursor:not-allowed;}

/* â•â• RESULT â•â• */
#scrResult{background:rgba(5,5,16,.97);display:none;z-index:300;}
.result-title{font-size:52px;font-weight:900;letter-spacing:6px;animation:rPulse 1.5s ease-in-out infinite alternate;}
@keyframes rPulse{from{text-shadow:0 0 20px currentColor}to{text-shadow:0 0 50px currentColor,0 0 100px currentColor}}
.result-sub{font-family:'Rajdhani';font-size:22px;letter-spacing:6px;color:rgba(255,255,255,0.7);margin-top:6px;}
.result-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:20px;padding:16px;border:1px solid rgba(255,255,255,0.1);}
.rs-item{display:flex;flex-direction:column;align-items:center;gap:4px;}
.rs-lbl{font-family:'Rajdhani';font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.4);}
.rs-val{font-size:20px;font-weight:700;color:var(--c-yellow);text-shadow:var(--glow-y);}
.xp-gained{font-size:13px;color:var(--c-green);text-shadow:var(--glow-g);margin-top:10px;letter-spacing:3px;animation:xpGlow 1s ease-in-out infinite alternate;}
@keyframes xpGlow{from{opacity:.7}to{opacity:1}}
.lvl-up-banner{font-size:22px;color:var(--c-yellow);text-shadow:var(--glow-y);letter-spacing:4px;animation:rPulse 1s infinite alternate;margin-top:8px;}

/* â•â• PAUSE â•â• */
#scrPause{background:rgba(5,5,16,.92);display:none;z-index:250;}
.pause-title{font-size:46px;font-weight:900;letter-spacing:8px;color:#fff;text-shadow:0 0 20px rgba(255,255,255,0.5);}

/* â•â• SURVIVAL HUD â•â• */
#survivalHud{position:absolute;top:94px;left:50%;transform:translateX(-50%);font-family:'Share Tech Mono';font-size:11px;color:var(--c-cyan);letter-spacing:3px;z-index:50;pointer-events:none;display:none;}

/* â•â• TRAINING HUD â•â• */
#trainingHud{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.3);letter-spacing:3px;z-index:50;pointer-events:none;display:none;text-align:center;}

/* â•â• MOVE HINTS â•â• */
#moveHints{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:28px;z-index:50;pointer-events:none;opacity:.6;display:none;}
.mhint{font-family:'Rajdhani';font-size:8px;letter-spacing:1px;color:rgba(255,255,255,0.5);text-align:center;}
.mkey{display:inline-block;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);padding:0 3px;font-size:7px;border-radius:1px;}

/* â•â• TOURN BRACKET â•â• */
#scrTourn{background:linear-gradient(135deg,#050510,#0a0818);display:none;}
.bracket{display:flex;gap:30px;padding:10px 30px;overflow-x:auto;}
.bracket-col{display:flex;flex-direction:column;justify-content:space-around;gap:10px;}
.bracket-col-title{font-size:9px;letter-spacing:3px;color:var(--c-yellow);text-align:center;margin-bottom:8px;}
.bracket-match{border:1px solid rgba(255,255,255,0.12);padding:8px 12px;min-width:130px;display:flex;flex-direction:column;gap:4px;}
.bracket-fighter{font-size:9px;font-weight:700;letter-spacing:1px;padding:3px 5px;}
.bracket-fighter.winner{color:var(--c-green);text-shadow:var(--glow-g);background:rgba(0,255,136,0.08);}
.bracket-fighter.loser{color:rgba(255,255,255,0.25);text-decoration:line-through;}
.bracket-fighter.tbd{color:rgba(255,255,255,0.3);}

/* â•â• COMBO NOTIF â•â• */
.big-combo{position:absolute;font-size:80px;font-weight:900;pointer-events:none;z-index:150;animation:bigCombo .6s ease-out forwards;}
@keyframes bigCombo{0%{opacity:0;transform:scale(.3)}40%{opacity:1;transform:scale(1.1)}70%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.8) translateY(-30px)}}

/* â•â• MISC â•â• */
.sep{width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:4px 0;}
.tag{font-family:'Share Tech Mono';font-size:8px;padding:2px 6px;border:1px solid;letter-spacing:1px;}
.tag.new{color:var(--c-green);border-color:var(--c-green);}
.tag.hot{color:var(--c-red);border-color:var(--c-red);}
.scroll-panel{max-height:180px;overflow-y:auto;padding-right:4px;}
.scroll-panel::-webkit-scrollbar{width:3px;}
.scroll-panel::-webkit-scrollbar-thumb{background:var(--c-blue);}
.notification{position:absolute;top:96px;right:14px;padding:6px 12px;border:1px solid var(--c-yellow);background:rgba(255,230,0,0.08);font-size:9px;letter-spacing:2px;color:var(--c-yellow);z-index:400;opacity:0;pointer-events:none;transition:opacity .3s;font-family:'Share Tech Mono';}
</style>
</head>
<body>
<div id="gc">
  <canvas id="gC" width="960" height="620"></canvas>
  <div class="sl"></div><div class="vg"></div>
  <div id="sf"></div>
  <div id="ann"></div>
  <div class="combo p1c" id="cb1"><div class="c-num" id="cb1n">0</div><div class="c-txt">COMBO</div></div>
  <div class="combo p2c" id="cb2"><div class="c-num" id="cb2n">0</div><div class="c-txt">COMBO</div></div>
  <div id="abilNotif"></div>
  <div class="notification" id="notif"></div>

  <!-- HUD -->
  <div id="hud">
    <div class="phud p1">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="pname p1c" id="p1nm">KIRA</span>
        <div style="display:flex;align-items:center;gap:6px">
          <span class="lv-badge" id="p1lvbdg">LV.1</span>
          <div class="wdots" id="p1wd"><div class="wd" id="p1w1"></div><div class="wd" id="p1w2"></div></div>
        </div>
      </div>
      <div class="hpbar"><div class="hpfill p1c" id="p1hp" style="width:100%"></div><span class="hptxt" id="p1hpt">100</span></div>
      <div class="sbar"><div class="sfill p1c" id="p1sp" style="width:0%"></div></div>
      <div class="xpbar"><div class="xpfill" id="p1xp" style="width:0%"></div></div>
    </div>
    <div class="timer-box">
      <div class="rnd-lbl" id="rndLbl">ROUND 1</div>
      <div class="timer-num" id="tmr">99</div>
    </div>
    <div class="phud r p2">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <div class="wdots" id="p2wd"><div class="wd" id="p2w1"></div><div class="wd" id="p2w2"></div></div>
          <span class="lv-badge" id="p2lvbdg">LV.1</span>
        </div>
        <span class="pname p2c" id="p2nm">VIPER</span>
      </div>
      <div class="hpbar"><div class="hpfill p2c" id="p2hp" style="width:100%"></div><span class="hptxt" id="p2hpt">100</span></div>
      <div class="sbar"><div class="sfill p2c" id="p2sp" style="width:0%"></div></div>
      <div class="xpbar"><div class="xpfill" id="p2xp" style="width:0%"></div></div>
    </div>
  </div>

  <div id="survivalHud">RONDA SURVIVAL: <span id="srvRnd">1</span> &nbsp;|&nbsp; VICTORIAS: <span id="srvWins">0</span></div>
  <div id="trainingHud">MODO ENTRENAMIENTO â€” HP ilimitado &nbsp;|&nbsp; P: reiniciar posiciÃ³n</div>
  <div id="moveHints">
    <div class="mhint">P1: <span class="mkey">A/D</span>mover <span class="mkey">W</span>saltar <span class="mkey">S</span>agachar <span class="mkey">F</span>golpe <span class="mkey">R</span>pesado <span class="mkey">G</span>patada <span class="mkey">H</span>especial <span class="mkey">T</span>super</div>
    <div class="mhint" id="p2hints">P2: <span class="mkey">â†â†’</span>mover <span class="mkey">â†‘</span>saltar <span class="mkey">â†“</span>agachar <span class="mkey">1</span>golpe <span class="mkey">2</span>pesado <span class="mkey">3</span>patada <span class="mkey">4</span>especial <span class="mkey">5</span>super</div>
  </div>

  <!-- TITLE -->
  <div class="scr" id="scrTitle">
    <div class="bg-grid"></div>
    <div class="logo" style="z-index:1">NEON<span>CLASH</span></div>
    <div class="logo-sub">ULTIMATE FIGHTING CHAMPIONSHIP</div>
    <div class="logo-ver" style="z-index:1">v2.0 â€” DEFINITIVE EDITION</div>
    <div class="title-menu">
      <button class="btn big" onclick="goModes()">âš” JUGAR</button>
      <button class="btn yellow" onclick="goProfile()">ğŸ‘¤ PERFIL</button>
      <button class="btn" onclick="goStageSelect()">ğŸ—º ESCENARIOS</button>
      <button class="btn green" onclick="goControls()">ğŸ® CONTROLES</button>
      <button class="btn red" onclick="goCredits()">â˜… CRÃ‰DITOS</button>
    </div>
    <div style="position:absolute;bottom:14px;font-family:'Rajdhani';font-size:10px;color:rgba(255,255,255,0.3);letter-spacing:4px;z-index:1">PRESIONA ENTER PARA JUGAR &nbsp;|&nbsp; ESC: MENÃš</div>
  </div>

  <!-- MODES -->
  <div class="scr" id="scrModes">
    <div style="font-size:16px;letter-spacing:8px;color:var(--c-yellow);text-shadow:var(--glow-y);margin-bottom:8px">MODO DE JUEGO</div>
    <div class="mode-grid">
      <div class="mode-card vs" onclick="selectMode('pvp')"><div class="mode-icon">âš”</div><div class="mode-name">2 JUGADORES</div><div class="mode-desc">Batalla local contra un amigo. Mismo teclado.</div></div>
      <div class="mode-card ai" onclick="goDifficulty()"><div class="mode-icon">ğŸ¤–</div><div class="mode-name">VS CPU</div><div class="mode-desc">Lucha contra la inteligencia artificial.</div></div>
      <div class="mode-card arcade" onclick="selectMode('arcade')"><div class="mode-icon">ğŸ†</div><div class="mode-name">ARCADE</div><div class="mode-desc">Derrota a 8 rivales para ser el campeÃ³n.</div></div>
      <div class="mode-card survival" onclick="selectMode('survival')"><div class="mode-icon">ğŸ’€</div><div class="mode-name">SUPERVIVENCIA</div><div class="mode-desc">Aguanta tantas rondas como puedas.</div></div>
      <div class="mode-card training" onclick="selectMode('training')"><div class="mode-icon">ğŸ¥Š</div><div class="mode-name">ENTRENAMIENTO</div><div class="mode-desc">Practica tus movimientos. HP infinito.</div></div>
      <div class="mode-card tourn" onclick="selectMode('tournament')"><div class="mode-icon">ğŸ–</div><div class="mode-name">TORNEO</div><div class="mode-desc">Bracket de 8 luchadores. Doble eliminaciÃ³n.</div></div>
    </div>
    <button class="btn red" style="margin-top:10px" onclick="showTitle()">â† VOLVER</button>
  </div>

  <!-- DIFFICULTY -->
  <div class="scr" id="scrDiff">
    <div style="font-size:16px;letter-spacing:8px;color:var(--c-red);text-shadow:var(--glow-r);margin-bottom:6px">DIFICULTAD IA</div>
    <div style="font-family:'Rajdhani';font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:3px;margin-bottom:16px">ELIGE TU DESAFÃO</div>
    <div class="diff-cards">
      <div class="diff-card easy" onclick="selectDiff('easy')"><div class="diff-icon">ğŸ˜Š</div><div class="diff-name" style="color:var(--c-green)">NOVATO</div><div class="diff-desc">La IA comete errores frecuentes. Ideal para aprender.</div></div>
      <div class="diff-card med" onclick="selectDiff('medium')"><div class="diff-icon">ğŸ˜¤</div><div class="diff-name" style="color:var(--c-yellow)">GUERRERO</div><div class="diff-desc">Comportamiento equilibrado. Retador pero justo.</div></div>
      <div class="diff-card hard" onclick="selectDiff('hard')"><div class="diff-icon">ğŸ˜ˆ</div><div class="diff-name" style="color:var(--c-orange)">MAESTRO</div><div class="diff-desc">Reacciona rÃ¡pido y usa combos agresivos.</div></div>
      <div class="diff-card god" onclick="selectDiff('god')"><div class="diff-icon">ğŸ’€</div><div class="diff-name" style="color:var(--c-purple)">DIOS</div><div class="diff-desc">PrÃ¡cticamente imposible. Lee tus inputs.</div></div>
    </div>
    <button class="btn red" style="margin-top:20px" onclick="goModes()">â† VOLVER</button>
  </div>

  <!-- CHARACTER SELECT -->
  <div class="scr" id="scrSelect">
    <div class="sel-header">SELECCIONA TU LUCHADOR</div>
    <div class="sel-layout">
      <div class="sel-side">
        <div class="sel-side-title p1c">â—€ JUGADOR 1</div>
        <div class="char-grid" id="p1cg"></div>
        <div style="display:flex;flex-direction:column;gap:4px;margin-top:6px;">
          <div class="prev-name p1c" id="prevP1n" style="font-size:13px;text-align:center">---</div>
          <canvas id="prevP1c" width="80" height="110" style="align-self:center"></canvas>
          <div id="prevP1stats"></div>
          <div class="prev-ability" id="prevP1ab"></div>
        </div>
      </div>
      <div class="sel-center">
        <div class="vs-text">VS</div>
        <button class="btn big yellow" id="fightBtn" onclick="goStageSelect(true)" disabled style="margin-top:10px">â–¶ PELEA</button>
        <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.3);text-align:center;margin-top:8px;letter-spacing:2px" id="modeLabel">MODO: ---</div>
        <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.3);margin-top:4px" id="diffLabel"></div>
      </div>
      <div class="sel-side">
        <div class="sel-side-title p2c">JUGADOR 2 / CPU â–¶</div>
        <div class="char-grid" id="p2cg"></div>
        <div style="display:flex;flex-direction:column;gap:4px;margin-top:6px;">
          <div class="prev-name p2c" id="prevP2n" style="font-size:13px;text-align:center">---</div>
          <canvas id="prevP2c" width="80" height="110" style="align-self:center"></canvas>
          <div id="prevP2stats"></div>
          <div class="prev-ability" id="prevP2ab"></div>
        </div>
      </div>
    </div>
    <button class="btn red" style="margin-top:8px;font-size:10px" onclick="backFromSelect()">â† VOLVER</button>
  </div>

  <!-- STAGE SELECT -->
  <div class="scr" id="scrStage">
    <div style="font-size:16px;letter-spacing:8px;color:var(--c-blue);text-shadow:var(--glow-b);margin-bottom:12px">SELECCIONA ESCENARIO</div>
    <div class="stage-grid" id="stageGrid"></div>
    <div style="display:flex;gap:12px;margin-top:14px">
      <button class="btn yellow" id="stgConfirm" onclick="confirmStage()" disabled>âœ“ CONFIRMAR</button>
      <button class="btn" onclick="selectRandomStage()">ğŸ² ALEATORIO</button>
      <button class="btn red" onclick="backFromStage()">â† VOLVER</button>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="scr" id="scrProfile">
    <div style="font-size:16px;letter-spacing:8px;color:var(--c-yellow);text-shadow:var(--glow-y);margin-bottom:10px">PERFIL DE JUGADOR</div>
    <div class="profile-layout" id="profileLayout"></div>
    <button class="btn red" style="margin-top:10px" onclick="saveProfile();showTitle()">ğŸ’¾ GUARDAR Y SALIR</button>
  </div>

  <!-- CONTROLS -->
  <div class="scr" id="scrControls" style="display:none">
    <div style="font-size:16px;letter-spacing:8px;color:var(--c-green);text-shadow:var(--glow-g);margin-bottom:10px">CONFIGURAR CONTROLES</div>
    <div class="controls-grid" id="ctrlGrid"></div>
    <div style="display:flex;gap:12px;margin-top:14px">
      <button class="btn green" onclick="saveControls()">ğŸ’¾ GUARDAR</button>
      <button class="btn" onclick="resetControls()">â†º RESETEAR</button>
      <button class="btn red" onclick="showTitle()">â† VOLVER</button>
    </div>
    <div style="font-family:'Rajdhani';font-size:9px;color:rgba(255,255,255,0.3);margin-top:8px;letter-spacing:2px">Haz clic en una tecla y luego presiona la nueva tecla</div>
  </div>

  <!-- TOURNAMENT BRACKET -->
  <div class="scr" id="scrTourn">
    <div style="font-size:14px;letter-spacing:8px;color:var(--c-orange);margin-bottom:10px">TORNEO â€” BRACKET</div>
    <div class="bracket" id="tournBracket"></div>
    <div style="display:flex;gap:12px;margin-top:12px">
      <button class="btn yellow" id="tournNextBtn" onclick="tournNext()">â–¶ SIGUIENTE PELEA</button>
      <button class="btn red" onclick="showTitle()">â† MENÃš</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="scr" id="scrResult">
    <div class="result-title" id="resTit" style="color:var(--c-yellow)">VICTORIA!</div>
    <div class="result-sub" id="resWin"></div>
    <div class="result-stats" id="resStats"></div>
    <div class="xp-gained" id="resXp"></div>
    <div class="lvl-up-banner" id="resLvl" style="display:none">â¬† SUBISTE DE NIVEL! â¬†</div>
    <div style="display:flex;gap:12px;margin-top:16px">
      <button class="btn big yellow" onclick="restartGame()">â†» REVANCHA</button>
      <button class="btn big" onclick="continueFlow()">â–¶ CONTINUAR</button>
      <button class="btn red" onclick="showTitle()">âŒ‚ MENÃš</button>
    </div>
  </div>

  <!-- PAUSE -->
  <div class="scr" id="scrPause">
    <div class="pause-title">PAUSA</div>
    <div class="title-menu" style="margin-top:24px">
      <button class="btn big" onclick="togglePause()">â–¶ CONTINUAR</button>
      <button class="btn yellow" onclick="goProfile()">ğŸ‘¤ PERFIL</button>
      <button class="btn red" onclick="showTitle()">âŒ‚ MENÃš</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEON CLASH v2.0 â€” DEFINITIVE EDITION
//  Full Fighting Game Engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const canvas = document.getElementById('gC');
const ctx = canvas.getContext('2d');
const W = 960, H = 620, GY = 490; // ground Y

// â”€â”€ SAVE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SAVE_KEY = 'neonclash_v2_save';

function loadSave() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return null;
}

function writeSave(data) {
  try { localStorage.setItem(SAVE_KEY, JSON.stringify(data)); } catch(e) {}
}

function defaultProfile() {
  return {
    name: 'LUCHADOR',
    level: 1,
    xp: 0,
    xpToNext: 200,
    totalXp: 0,
    wins: 0,
    losses: 0,
    totalFights: 0,
    highestCombo: 0,
    totalDamage: 0,
    unlockedChars: [0,1,2,3],
    unlockedStages: [0,1,2,3],
    unlockedAbilities: ['combo_x2','quick_dash'],
    controls: { ...DEFAULT_CONTROLS },
  };
}

// â”€â”€ DEFAULT CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_CONTROLS = {
  p1_left:'KeyA', p1_right:'KeyD', p1_up:'KeyW', p1_down:'KeyS',
  p1_light:'KeyF', p1_heavy:'KeyR', p1_kick:'KeyG', p1_special:'KeyH', p1_super:'KeyT',
  p2_left:'ArrowLeft', p2_right:'ArrowRight', p2_up:'ArrowUp', p2_down:'ArrowDown',
  p2_light:'Digit1', p2_heavy:'Digit2', p2_kick:'Digit3', p2_special:'Digit4', p2_super:'Digit5',
};

// â”€â”€ ABILITIES CATALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ABILITIES_CATALOG = [
  { id:'combo_x2',     icon:'âš¡', name:'COMBO VELOZ',      desc:'Ventana de combo +20%',        lvl:1,  effect:'comboWindow' },
  { id:'quick_dash',   icon:'ğŸ’¨', name:'DASH RÃPIDO',       desc:'Dash al moverse 2x',           lvl:1,  effect:'quickDash'   },
  { id:'iron_fist',    icon:'ğŸ¥Š', name:'PUÃ‘O DE HIERRO',    desc:'Golpes +10% daÃ±o',             lvl:3,  effect:'ironFist'    },
  { id:'barrier',      icon:'ğŸ›¡', name:'BARRERA',           desc:'Bloqueo 50% â†’ 30% daÃ±o',       lvl:4,  effect:'barrier'     },
  { id:'vampiric',     icon:'ğŸ©¸', name:'VAMPÃRICO',         desc:'Recupera 5HP por golpe',       lvl:5,  effect:'vampiric'    },
  { id:'super_meter',  icon:'â­', name:'MEDIDOR EXTRA',      desc:'Super se carga 30% mÃ¡s rÃ¡pido',lvl:6,  effect:'superMeter'  },
  { id:'air_combo',    icon:'ğŸŒ€', name:'COMBO AÃ‰REO',       desc:'Puedes atacar en el aire',     lvl:7,  effect:'airCombo'    },
  { id:'counter',      icon:'ğŸ”„', name:'CONTRAATAQUE',       desc:'10% chance de contrarrestar', lvl:8,  effect:'counter'     },
  { id:'rage',         icon:'ğŸ’¢', name:'FURIA',              desc:'Con <25% HP, daÃ±o +25%',      lvl:9,  effect:'rage'        },
  { id:'critical',     icon:'ğŸ’¥', name:'CRÃTICO LETAL',     desc:'Crit chance +15%',             lvl:10, effect:'critical'    },
  { id:'phoenix',      icon:'ğŸ”¥', name:'FÃ‰NIX',              desc:'Una vez por ronda, sobrevive con 1HP',lvl:12,effect:'phoenix'},
  { id:'mega_combo',   icon:'ğŸŒŸ', name:'MEGA COMBO',        desc:'Combos >5 hits generan +50% sÃºper',lvl:15,effect:'megaCombo'},
];

// â”€â”€ GLOBAL GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const G = {
  state: 'title',
  mode: 'pve',
  aiDiff: 'medium',
  round: 1, maxRounds: 3,
  p1Wins: 0, p2Wins: 0,
  timer: 99, timerInt: null,
  animFrame: null,
  paused: false,
  roundOver: false,
  selP1: null, selP2: null,
  stageIdx: 0,
  bgFrame: 0,
  fromSelect: false,
  // Survival
  survivalRound: 1, survivalWins: 0,
  // Arcade
  arcadeIdx: 0, arcadeOpponents: [],
  // Tournament
  tournPlayers: [], tournBracket: [], tournRound: 0, tournMatchIdx: 0,
  // Session stats
  sessionHits: 0, sessionDmg: 0, sessionMaxCombo: 0,
  profile: null,
  controls: { ...DEFAULT_CONTROLS },
};

// Load or init profile
G.profile = loadSave() || defaultProfile();
G.controls = { ...(G.profile.controls || DEFAULT_CONTROLS) };

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let AC = null;
function ac() { if(!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); return AC; }
function snd(type) {
  try {
    const a = ac(), o = a.createOscillator(), g = a.createGain();
    o.connect(g); g.connect(a.destination);
    const S = {
      punch:  {t:'square',  f:190,d:.12,v:.28,sw:90},
      kick:   {t:'sawtooth',f:130,d:.14,v:.28,sw:70},
      block:  {t:'square',  f:320,d:.08,v:.2, sw:0},
      jump:   {t:'sine',    f:420,d:.10,v:.2, sw:200},
      land:   {t:'square',  f:85, d:.07,v:.22,sw:0},
      special:{t:'sawtooth',f:230,d:.4, v:.38,sw:-110},
      ko:     {t:'sawtooth',f:65, d:.9, v:.48,sw:0},
      hit:    {t:'square',  f:210,d:.1, v:.32,sw:55},
      superM: {t:'sawtooth',f:310,d:.5, v:.5, sw:210},
      select: {t:'sine',    f:600,d:.08,v:.15,sw:100},
      lvlup:  {t:'sine',    f:500,d:.6, v:.3, sw:300},
      dash:   {t:'sine',    f:350,d:.08,v:.18,sw:100},
    };
    const s = S[type]||S.punch;
    o.type = s.t;
    o.frequency.setValueAtTime(s.f, a.currentTime);
    if(s.sw) o.frequency.linearRampToValueAtTime(s.f+s.sw, a.currentTime+s.d);
    g.gain.setValueAtTime(s.v, a.currentTime);
    g.gain.exponentialRampToValueAtTime(.001, a.currentTime+s.d+.02);
    o.start(a.currentTime); o.stop(a.currentTime+s.d+.05);
  } catch(e){}
}

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PARTS = [];
function spawnParts(x,y,col,n,type,opts={}) {
  for(let i=0;i<n;i++){
    const ang=(Math.PI*2/n)*i+Math.random()*.6;
    const sp=2+Math.random()*5;
    PARTS.push({
      x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp-(type==='hit'?2.5:0),
      life:1,decay:.04+Math.random()*.035,
      sz:type==='sparks'?2+Math.random()*3:4+Math.random()*7,
      col:col,type:type||'circle',grav:type==='blood'?.22:.06,
      ...(opts||{})
    });
  }
}
function spawnHit(x,y,col){spawnParts(x,y,col,14,'sparks');spawnParts(x,y,'#fff',5,'sparks');}
function spawnKO(x,y){
  spawnParts(x,y,'#ff003c',22,'hit');spawnParts(x,y,'#ff7700',16,'hit');
  spawnParts(x,y,'#ffe600',10,'sparks');spawnParts(x,y,'#fff',8,'sparks');
}
function updParts(){
  for(let i=PARTS.length-1;i>=0;i--){
    const p=PARTS[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=p.grav; p.vx*=.94; p.life-=p.decay;
    if(p.life<=0) PARTS.splice(i,1);
  }
}
function drawParts(){
  PARTS.forEach(p=>{
    ctx.save(); ctx.globalAlpha=Math.max(0,p.life);
    ctx.fillStyle=p.col; ctx.shadowColor=p.col; ctx.shadowBlur=6;
    if(p.type==='sparks') ctx.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz);
    else{ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fill();}
    ctx.restore();
  });
}

// â”€â”€ SCREEN EFFECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shake={on:false,i:0,d:0,t:0}, flashA=0, flashC='#fff';
function doShake(i,d){shake={on:true,i,d,t:0};}
function doFlash(c,a){flashA=a;flashC=c;}
function updFX(){
  if(shake.on){
    shake.t++;
    const decay=1-(shake.t/shake.d);
    if(shake.t>=shake.d){shake.on=false;canvas.style.transform='';}
    else canvas.style.transform=`translate(${(Math.random()-.5)*shake.i*decay}px,${(Math.random()-.5)*shake.i*decay*.5}px)`;
  }
  const sf=document.getElementById('sf');
  if(flashA>0){sf.style.background=flashC;sf.style.opacity=flashA;flashA-=.05;}
  else sf.style.opacity=0;
}

// â”€â”€ DAMAGE NUMBERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDmg(x,y,v,type){
  const el=document.createElement('div');
  el.className=`dmg ${type}`;el.textContent=v;
  el.style.left=x+'px';el.style.top=y+'px';
  document.getElementById('gc').appendChild(el);
  setTimeout(()=>el.remove(),860);
}

// â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notifTO=null;
function showNotif(msg,col='var(--c-yellow)'){
  const el=document.getElementById('notif');
  el.textContent=msg; el.style.color=col; el.style.borderColor=col;
  el.style.background=`${col.replace('var(','').replace(')','').trim()}11`;
  el.style.opacity='1';
  clearTimeout(notifTO);
  notifTO=setTimeout(()=>el.style.opacity='0',2000);
}

// â”€â”€ ANNOUNCER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let annTO=null;
function announce(txt,cls,dur=1800){
  const el=document.getElementById('ann');
  el.className=`show ${cls}`; el.innerHTML=txt;
  clearTimeout(annTO);
  annTO=setTimeout(()=>{el.className='';el.innerHTML='';},dur);
}

// â”€â”€ ABILITY NOTIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let abilTO=null;
function showAbilNotif(txt){
  const el=document.getElementById('abilNotif');
  el.textContent=txt; el.style.opacity='1';
  clearTimeout(abilTO);
  abilTO=setTimeout(()=>el.style.opacity='0',2200);
}

// â”€â”€ CHARACTERS DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHARS = [
  {id:0,name:'KIRA',sub:'DragÃ³n Neon',col:'#00d4ff',col2:'#003a66',acc:'#00ff88',
   stats:{spd:8,pow:7,def:6,sp:9},hp:100,speed:4.2,jf:-17.5,
   sName:'RAY BURST',suName:'THUNDER STORM',
   ap:{light:8,heavy:16,kick:12,special:21,super:36},
   hw:50,hh:100,style:'electric',desc:'Ãgil y electrizante'},
  {id:1,name:'VIPER',sub:'Serpiente Fuego',col:'#ff4422',col2:'#661100',acc:'#ff9900',
   stats:{spd:6,pow:9,def:8,sp:7},hp:112,speed:3.8,jf:-16,
   sName:'FIRE FANG',suName:'INFERNO RAGE',
   ap:{light:11,heavy:19,kick:15,special:23,super:40},
   hw:56,hh:106,style:'fire',desc:'Poderoso y ardiente'},
  {id:2,name:'SHADOW',sub:'Espectro Oscuro',col:'#b400ff',col2:'#330066',acc:'#ff00cc',
   stats:{spd:10,pow:7,def:5,sp:9},hp:88,speed:5.0,jf:-18.5,
   sName:'VOID DASH',suName:'DARK ABYSS',
   ap:{light:7,heavy:14,kick:12,special:19,super:33},
   hw:44,hh:94,style:'shadow',desc:'Ninja veloz e impredecible'},
  {id:3,name:'TITAN',sub:'Goliat Acero',col:'#aaaaaa',col2:'#333344',acc:'#00d4ff',
   stats:{spd:3,pow:10,def:10,sp:6},hp:132,speed:2.7,jf:-14,
   sName:'IRON SLAM',suName:'EARTHQUAKE',
   ap:{light:13,heavy:24,kick:19,special:28,super:48},
   hw:66,hh:116,style:'metal',desc:'Tanque lento y devastador'},
  {id:4,name:'ZARA',sub:'Bruja Cristal',col:'#00ffcc',col2:'#003333',acc:'#fffb00',
   stats:{spd:7,pow:8,def:7,sp:10},hp:95,speed:4.0,jf:-17,
   sName:'CRYSTAL WAVE',suName:'PRISM BLAST',
   ap:{light:9,heavy:17,kick:13,special:25,super:38},
   hw:48,hh:98,style:'crystal',desc:'Controladora con poderes mÃ¡gicos'},
  {id:5,name:'RYKER',sub:'Cyborg Mutante',col:'#ff6600',col2:'#441100',acc:'#ffff00',
   stats:{spd:7,pow:9,def:7,sp:7},hp:108,speed:4.1,jf:-16.5,
   sName:'PLASMA FIST',suName:'OVERDRIVE',
   ap:{light:10,heavy:18,kick:14,special:22,super:39},
   hw:54,hh:108,style:'cyber',desc:'Combina fuerza y tecnologÃ­a'},
  {id:6,name:'LUNA',sub:'Cazadora Lunar',col:'#ccccff',col2:'#222244',acc:'#ffaaff',
   stats:{spd:9,pow:6,def:6,sp:9},hp:90,speed:4.6,jf:-18,
   sName:'MOON SLICE',suName:'ECLIPSE',
   ap:{light:8,heavy:14,kick:13,special:20,super:34},
   hw:46,hh:96,style:'lunar',desc:'Veloz con ataques de luna'},
  {id:7,name:'BRUTUS',sub:'Bestia Primitiva',col:'#996633',col2:'#331100',acc:'#ff4400',
   stats:{spd:4,pow:10,def:9,sp:5},hp:128,speed:3.0,jf:-14.5,
   sName:'SAVAGE BLOW',suName:'BERSERKER',
   ap:{light:12,heavy:22,kick:17,special:26,super:44},
   hw:62,hh:112,style:'beast',desc:'Pura fuerza animal'},
  {id:8,name:'NOVA',sub:'Astro Guerrera',col:'#ff00ff',col2:'#330033',acc:'#00ffff',
   stats:{spd:8,pow:8,def:6,sp:9},hp:96,speed:4.3,jf:-17.5,
   sName:'STAR PULSE',suName:'SUPERNOVA',
   ap:{light:9,heavy:16,kick:13,special:22,super:37},
   hw:49,hh:99,style:'cosmic',desc:'Poder cÃ³smico desatado'},
  {id:9,name:'DREV',sub:'Maestro Sombras',col:'#334466',col2:'#111122',acc:'#6688ff',
   stats:{spd:6,pow:8,def:9,sp:7},hp:116,speed:3.6,jf:-15.5,
   sName:'SHADOW SPIKE',suName:'ABYSS GATE',
   ap:{light:10,heavy:18,kick:14,special:22,super:38},
   hw:54,hh:104,style:'dark',desc:'Defensa sÃ³lida y contraataques'},
  {id:10,name:'SERAPH',sub:'Ãngel CaÃ­do',col:'#ffffff',col2:'#334466',acc:'#aaddff',
   stats:{spd:8,pow:7,def:7,sp:10},hp:100,speed:4.2,jf:-17,
   sName:'HOLY LANCE',suName:'DIVINE WRATH',
   ap:{light:9,heavy:16,kick:12,special:22,super:38},
   hw:50,hh:100,style:'divine',desc:'Gracia divina y poder angelical'},
  {id:11,name:'KRAKEN',sub:'Monstruo Abismo',col:'#006699',col2:'#001122',acc:'#00ffaa',
   stats:{spd:3,pow:10,def:10,sp:6},hp:138,speed:2.5,jf:-13.5,
   sName:'TENTACLE SLAM',suName:'DEEP TERROR',
   ap:{light:14,heavy:25,kick:20,special:30,super:50},
   hw:70,hh:118,style:'aqua',desc:'El mÃ¡s poderoso de las profundidades'},
];

// â”€â”€ STAGES DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAGES = [
  {name:'NEON CITY',bg1:'#050518',bg2:'#0a0a30',fl:'#080820',flAcc:'#00d4ff',a1:'#00d4ff',a2:'#ff003c',type:'city'},
  {name:'FIRE TEMPLE',bg1:'#180505',bg2:'#301005',fl:'#1a0606',flAcc:'#ff7700',a1:'#ff003c',a2:'#ff9900',type:'fire'},
  {name:'VOID ARENA',bg1:'#080010',bg2:'#150022',fl:'#0c0018',flAcc:'#b400ff',a1:'#b400ff',a2:'#ff00cc',type:'void'},
  {name:'ICE FORTRESS',bg1:'#050e18',bg2:'#0a1a2a',fl:'#0a1520',flAcc:'#aaddff',a1:'#aaddff',a2:'#00d4ff',type:'ice'},
  {name:'JUNGLE RUINS',bg1:'#061008',bg2:'#0c1e0c',fl:'#081008',flAcc:'#00ff66',a1:'#00aa44',a2:'#aaff44',type:'jungle'},
  {name:'SPACE STATION',bg1:'#000005',bg2:'#050518',fl:'#050508',flAcc:'#ffffff',a1:'#ffffff',a2:'#ff00ff',type:'space'},
  {name:'DESERT STORM',bg1:'#1a1005',bg2:'#2a1a08',fl:'#1a1008',flAcc:'#ffaa00',a1:'#ffaa00',a2:'#ff6600',type:'desert'},
  {name:'CYBER DOJO',bg1:'#050a0a',bg2:'#0a1515',fl:'#060e0e',flAcc:'#00ffee',a1:'#00ffee',a2:'#ff00aa',type:'cyber'},
  {name:'THUNDER PEAK',bg1:'#0a0510',bg2:'#150a20',fl:'#0a0810',flAcc:'#ffe600',a1:'#ffe600',a2:'#aa00ff',type:'thunder'},
  {name:'OCEAN DEPTHS',bg1:'#030815',bg2:'#050e22',fl:'#030a18',flAcc:'#00aaff',a1:'#0044aa',a2:'#00ffcc',type:'ocean'},
  {name:'BLOOD COLISEUM',bg1:'#100305',bg2:'#1a0508',fl:'#0e0404',flAcc:'#cc0022',a1:'#cc0022',a2:'#ff6600',type:'blood'},
  {name:'SACRED TEMPLE',bg1:'#0a0805',bg2:'#181208',fl:'#0e0a04',flAcc:'#ffdd88',a1:'#ffdd88',a2:'#ff8800',type:'temple'},
];

// â”€â”€ FIGHTER CLASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Fighter {
  constructor(ch, x, fr, pid) {
    this.ch = ch; this.x = x; this.y = GY; this.pid = pid;
    this.vx = 0; this.vy = 0; this.fr = fr;
    this.hp = ch.hp; this.maxHp = ch.hp;
    this.sp = 0; this.maxSp = 100;
    this.state = 'idle'; this.stT = 0; this.atkType = null;
    this.blocking = false; this.onGnd = true; this.dead = false;
    this.hbx = {x:0,y:0,w:ch.hw,h:ch.hh};
    this.atkHbx = null; this.hitOn = false; this.hasHit = false;
    this.aFr = 0; this.aT = 0; this.flashT = 0; this.shk = 0;
    this.w = ch.hw; this.h = ch.hh;
    this.combo = 0; this.comboT = 0;
    this.keys = {};
    this.ai = null;
    this.dashCooldown = 0;
    this.lastDir = 0; this.lastDirT = 0;
    this.phoenixUsed = false;
    // Abilities derived from profile
    this.abilities = G.profile ? [...G.profile.unlockedAbilities] : [];
    this.hasAbil = (id) => this.pid === 1 && this.abilities.includes(id);
  }
  get cx(){return this.x;}
  get left(){return this.x-this.w/2;}
  get right(){return this.x+this.w/2;}
  updHbx(){
    this.hbx={x:this.x-this.w/2,y:this.y-this.h,w:this.w,h:this.h};
    if(this.hitOn && this.stT>3){
      const atkOff=this.state==='crouch_atk'?this.h*.4:this.h*.72;
      const bx=this.fr?this.x+8:this.x-88;
      this.atkHbx={x:bx,y:this.y-atkOff-30,w:82,h:64};
    } else this.atkHbx=null;
  }
  gravity(){
    if(!this.onGnd){
      this.vy+=0.78; this.y+=this.vy;
      if(this.y>=GY){
        this.y=GY; this.vy=0; this.onGnd=true;
        if(this.state==='jump'){this.state='idle';snd('land');}
      }
    }
  }
  move(dx){
    if(['attack','hurt','ko','special','super'].includes(this.state)) return;
    // Dash detection
    const now=performance.now();
    const dirNow=dx>0?1:-1;
    if(dirNow===this.lastDir && (now-this.lastDirT)<200 && this.dashCooldown<=0 && this.hasAbil('quick_dash')){
      this.vx=dx*2.5; this.dashCooldown=45;
      snd('dash'); spawnParts(this.x,this.y,this.ch.col,6,'sparks');
    }
    if(dirNow!==this.lastDir){this.lastDir=dirNow;this.lastDirT=now;}
    this.x+=dx; this.x=Math.max(55,Math.min(W-55,this.x));
    if(dx!==0&&this.onGnd&&this.state!=='crouch') this.state='walk';
  }
  jump(){
    if(!this.onGnd) return;
    if(['attack','hurt','ko'].includes(this.state)) return;
    this.vy=this.ch.jf; this.onGnd=false; this.state='jump';
    snd('jump'); spawnParts(this.x,this.y,this.ch.col,4,'sparks');
  }
  crouch(){
    if(this.onGnd&&!['attack','hurt','ko'].includes(this.state)){
      this.state='crouch'; this.blocking=true; this.keys['down']=true;
    }
  }
  atk(type){
    if(['hurt','ko','attack','special','super'].includes(this.state)) return;
    if(!this.onGnd && !this.hasAbil('airCombo') && type!=='kick') return;
    if(type==='special'&&this.sp<30) return;
    if(type==='super'&&this.sp<this.maxSp) return;
    const prev=this.state;
    this.state=type==='super'?'super':type==='special'?'special':'attack';
    this.atkType=type; this.stT=0; this.hitOn=true; this.hasHit=false; this.blocking=false;
    if(type==='special'){this.sp=Math.max(0,this.sp-30);snd('special');spawnParts(this.x,this.y-this.h*.6,this.ch.col,14,'hit');}
    else if(type==='super'){this.sp=0;snd('superM');spawnKO(this.x,this.y-this.h*.5);doShake(14,28);doFlash(this.ch.col,.5);}
    else snd(type==='kick'?'kick':'punch');
  }
  takeDmg(amt,ax){
    if(this.dead) return 0;
    // Counter ability
    if(this.hasAbil('counter')&&Math.random()<.10&&!this.blocking){
      showAbilNotif('âš¡ CONTRAATAQUE!'); doShake(4,6); spawnHit(this.x,this.y-this.h*.6,'#00ff88');
      return 0;
    }
    let d=amt;
    if(this.blocking){
      const pct=this.hasAbil('barrier')?.3:.25;
      d=Math.floor(amt*pct); snd('block');
      spawnParts(this.hbx.x+this.hbx.w*.5,this.hbx.y+this.hbx.h*.3,'#fff',5,'sparks');
    } else snd('hit');
    // Rage ability
    if(!this.blocking && this.hasAbil('rage') && (this.hp/this.maxHp)<.25) d=Math.floor(d*.75);
    this.hp=Math.max(0,this.hp-d);
    // Phoenix ability
    if(this.hp<=0 && !this.phoenixUsed && this.hasAbil('phoenix')){
      this.hp=1; this.phoenixUsed=true;
      showAbilNotif('ğŸ”¥ FÃ‰NIX ACTIVADO!'); doFlash('#ff9900',.8); doShake(10,20);
      spawnParts(this.x,this.y-this.h*.5,'#ff9900',20,'hit');
    }
    if(!this.blocking){
      this.flashT=9; doShake(4,7);
      const pd=this.x>ax?1:-1; this.x+=pd*13; this.x=Math.max(55,Math.min(W-55,this.x));
      if(this.hp<=0){
        this.state='ko';this.dead=true;this.stT=0;snd('ko');spawnKO(this.x,this.y-this.h*.5);
        doFlash('#ff0000',.75);doShake(20,40);
      } else {this.state='hurt';this.stT=0;}
    }
    this.sp=Math.min(this.maxSp,this.sp+amt*.5);
    return d;
  }
  update(){
    this.stT++; this.aT++;
    if(this.flashT>0) this.flashT--;
    if(this.dashCooldown>0) this.dashCooldown--;
    if(this.comboT>0){this.comboT--;if(this.comboT===0){this.combo=0;document.getElementById(`cb${this.pid}`).classList.remove('on');}}
    const atts={attack:this.atkType==='heavy'?26:this.atkType==='kick'?23:19,special:32,super:52};
    if(['attack','special','super'].includes(this.state)&&this.stT>=(atts[this.state]||20)){
      this.state='idle';this.hitOn=false;this.atkType=null;
    }
    if(this.state==='hurt'&&this.stT>=18){this.state='idle';}
    if(['idle','walk'].includes(this.state)) this.blocking=false;
    if(this.state==='crouch'&&!this.keys['down']){this.state='idle';this.blocking=false;}
    if(this.state==='walk') this.state='idle';
    this.gravity(); this.updHbx();
  }

  // â”€â”€ DRAW FIGHTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  draw(){
    ctx.save();
    ctx.translate(this.x,0);
    ctx.scale(this.fr?1:-1,1);
    const alpha=(this.flashT>0&&this.flashT%3<2)?.35:1;
    ctx.globalAlpha=alpha;
    const c=this.ch, s=this.state;
    const bob=s==='idle'?Math.sin(this.aT*.08)*2.5:0;
    const crM=(s==='crouch')?0.72:1;
    const gY=this.y, bY=gY+bob;
    const style=c.style;

    // Shadow
    ctx.save();ctx.globalAlpha=.22*alpha;ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(0,gY+4,26,6,0,0,Math.PI*2);ctx.fill();ctx.restore();

    // Aura
    if(s==='special'||s==='super'||s==='attack'){
      ctx.save();ctx.globalAlpha=s==='super'?.45:.2;
      ctx.shadowColor=s==='super'?'#fff':c.col;ctx.shadowBlur=45;
      ctx.fillStyle=s==='super'?'#fff':c.col;
      ctx.beginPath();ctx.ellipse(0,bY-this.h*crM*.5,36,this.h*crM*.55,0,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }
    // Block aura
    if(this.blocking){
      ctx.save();ctx.globalAlpha=.22;ctx.strokeStyle='#00ffff';ctx.lineWidth=3;
      ctx.shadowColor='#00ffff';ctx.shadowBlur=15;
      ctx.beginPath();ctx.ellipse(0,bY-this.h*crM*.5,34,this.h*crM*.52,0,0,Math.PI*2);ctx.stroke();ctx.restore();
    }

    const bodyH=this.h*crM;
    const tTop=bY-bodyH+28, tBot=tTop+36*crM;
    const hCY=tTop-14;

    // Legs
    const legSwing=(s==='walk')?Math.sin(this.aT*.22)*10:0;
    drawLimb(ctx,-7,tBot,-7+legSwing,gY,9,c.col2,c.col);
    drawLimb(ctx,7,tBot,7-legSwing,gY,9,c.col2,c.col);
    ctx.fillStyle=c.col2;ctx.shadowColor=c.col;ctx.shadowBlur=4;
    ctx.fillRect(-13+legSwing,gY-5,26,6);
    ctx.fillRect(-5-legSwing,gY-5,26,6);

    // Torso
    ctx.shadowColor=c.col;ctx.shadowBlur=10;ctx.fillStyle=c.col2;
    ctx.beginPath();
    ctx.moveTo(-15,tTop);ctx.lineTo(15,tTop);ctx.lineTo(18,tBot);ctx.lineTo(-18,tBot);
    ctx.closePath();ctx.fill();

    // Style-specific chest decoration
    ctx.save();ctx.globalAlpha=.5*alpha;ctx.fillStyle=c.col;ctx.shadowBlur=8;
    if(style==='electric'){
      ctx.beginPath();ctx.moveTo(-4,tTop+4);ctx.lineTo(4,tTop+12);ctx.lineTo(-2,tTop+12);ctx.lineTo(4,tTop+22);ctx.lineTo(-6,tTop+10);ctx.lineTo(2,tTop+10);ctx.closePath();ctx.fill();
    } else if(style==='fire'){
      for(let fi=0;fi<3;fi++){ctx.beginPath();ctx.arc(-6+fi*6,tTop+8+fi*3,3,0,Math.PI*2);ctx.fill();}
    } else if(style==='shadow'||style==='dark'){
      ctx.strokeStyle=c.col;ctx.lineWidth=1.5;
      for(let li=0;li<3;li++){ctx.beginPath();ctx.moveTo(-12,tTop+8+li*8);ctx.lineTo(12,tTop+8+li*8);ctx.stroke();}
    } else if(style==='metal'){
      ctx.fillRect(-12,tTop+4,24,4);ctx.fillRect(-8,tTop+12,16,4);ctx.fillRect(-12,tTop+20,24,4);
    } else if(style==='crystal'){
      ctx.beginPath();ctx.moveTo(0,tTop+2);ctx.lineTo(8,tTop+14);ctx.lineTo(0,tTop+22);ctx.lineTo(-8,tTop+14);ctx.closePath();ctx.fill();
    } else if(style==='cyber'){
      ctx.strokeStyle=c.acc;ctx.lineWidth=1.5;
      ctx.strokeRect(-10,tTop+4,20,16);ctx.fillRect(-2,tTop+8,4,8);
    } else if(style==='cosmic'||style==='divine'){
      const orb=Math.sin(this.aT*.1)*5;
      ctx.beginPath();ctx.arc(0,tTop+12+orb,6,0,Math.PI*2);ctx.fill();
    } else if(style==='beast'){
      ctx.strokeStyle=c.col;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(-12,tTop+6);ctx.lineTo(-4,tTop+14);ctx.lineTo(0,tTop+8);ctx.lineTo(4,tTop+14);ctx.lineTo(12,tTop+6);ctx.stroke();
    } else if(style==='aqua'){
      for(let ai=0;ai<2;ai++){ctx.beginPath();ctx.arc(-8+ai*16,tTop+12,4,0,Math.PI*2);ctx.fill();}
    } else if(style==='lunar'){
      ctx.save();ctx.strokeStyle=c.col;ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(0,tTop+12,8,Math.PI*.2,Math.PI*.8);ctx.stroke();ctx.restore();
    }
    ctx.restore();

    // Arms
    const atkP=(['attack','special','super'].includes(s));
    let faX=20,faY=tTop+8;
    if(atkP){
      const prog=Math.min(1,this.stT/9);const ret=this.stT>9?(this.stT-9)/10:0;
      const reach=this.atkType==='heavy'||this.atkType==='super'?64:this.atkType==='special'?58:46;
      faX=20+reach*prog*(1-ret); faY=tTop+(this.atkType==='kick'?22:-4);
    }
    drawLimb(ctx,-12,tTop+8,-28,tTop+20,8,c.col2,c.col);
    drawLimb(ctx,12,tTop+8,faX,faY,8,c.col2,c.col);
    ctx.fillStyle=atkP?c.acc:c.col;ctx.shadowColor=atkP?c.acc:c.col;ctx.shadowBlur=atkP?20:8;
    ctx.beginPath();ctx.arc(faX,faY,atkP?11:8,0,Math.PI*2);ctx.fill();
    if(atkP&&this.atkType==='super'){
      ctx.save();ctx.globalAlpha=.65*alpha;ctx.fillStyle='#fff';ctx.shadowBlur=35;
      ctx.beginPath();ctx.arc(faX,faY,18,0,Math.PI*2);ctx.fill();ctx.restore();
    }

    // Head
    const hHurtX=(s==='hurt')?6:0;
    ctx.fillStyle=c.col2;ctx.shadowColor=c.col;ctx.shadowBlur=12;
    ctx.fillRect(-4,hCY+12,8,7);
    ctx.beginPath();ctx.arc(hHurtX,hCY,14,0,Math.PI*2);ctx.fill();

    // Face highlight
    ctx.save();ctx.globalAlpha=.45*alpha;ctx.fillStyle=c.col;
    ctx.beginPath();ctx.arc(hHurtX-3,hCY-4,7,0,Math.PI*2);ctx.fill();ctx.restore();

    // Eyes
    const eCol=atkP?c.acc:c.col;
    ctx.fillStyle=eCol;ctx.shadowColor=eCol;ctx.shadowBlur=10;
    if(this.dead||s==='ko'){
      ctx.strokeStyle='#ff003c';ctx.lineWidth=2;ctx.shadowColor='#ff003c';
      [-6,2].forEach(ex=>{ctx.beginPath();ctx.moveTo(hHurtX+ex,hCY-4);ctx.lineTo(hHurtX+ex+4,hCY+2);ctx.moveTo(hHurtX+ex+4,hCY-4);ctx.lineTo(hHurtX+ex,hCY+2);ctx.stroke();});
    } else {
      ctx.fillRect(hHurtX-6,hCY-4,5,4);ctx.fillRect(hHurtX+1,hCY-4,5,4);
    }

    // Style-specific head decoration
    ctx.save();ctx.fillStyle=c.col;ctx.shadowBlur=5;
    if(style==='metal'||style==='cyber'){
      ctx.fillRect(hHurtX-14,hCY-12,28,4);
    } else if(style==='divine'||style==='lunar'){
      ctx.beginPath();ctx.arc(hHurtX,hCY-20,4,0,Math.PI*2);ctx.fill();
    } else if(style==='aqua'){
      ctx.fillRect(hHurtX-14,hCY-12,5,10);ctx.fillRect(hHurtX+9,hCY-12,5,10);
    } else {
      const spk=c.id%3+2;
      for(let si=0;si<spk;si++){
        ctx.beginPath();ctx.moveTo(hHurtX-8+si*8,hCY-13);
        ctx.lineTo(hHurtX-4+si*8,hCY-13-12-si*2);ctx.lineTo(hHurtX+si*8,hCY-13);ctx.fill();
      }
    }
    ctx.restore();

    // Special orbit particles
    if(s==='special'){
      ctx.save();ctx.globalAlpha=.65*alpha;
      for(let oi=0;oi<3;oi++){
        const a=this.aT*.1+oi*Math.PI*2/3;
        ctx.fillStyle=c.col;ctx.shadowColor=c.col;ctx.shadowBlur=14;
        ctx.beginPath();ctx.arc(Math.cos(a)*32,bY-bodyH*.5+Math.sin(a)*42,5,0,Math.PI*2);ctx.fill();
      }
      ctx.restore();
    }

    ctx.restore();
  }
}

function drawLimb(ctx,x1,y1,x2,y2,w,col,glow){
  ctx.save();ctx.shadowColor=glow;ctx.shadowBlur=6;ctx.strokeStyle=col;
  ctx.lineWidth=w;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.restore();
}

// â”€â”€ AI CONTROLLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class AI {
  constructor(f,t,diff){
    this.f=f;this.t=t;this.d=diff;this.aT=0;this.act='idle';this.aAT=0;
    const D={easy:{react:35,aggr:.3,block:.12,jump:.04,sp:.05,rate:55},
              medium:{react:18,aggr:.55,block:.28,jump:.1,sp:.15,rate:35},
              hard:{react:8,aggr:.75,block:.45,jump:.18,sp:.26,rate:20},
              god:{react:3,aggr:.9,block:.65,jump:.25,sp:.4,rate:10}};
    this.cfg=D[diff]||D.medium;
  }
  update(){
    const f=this.f,t=this.t;
    if(f.dead||f.state==='ko') return;
    this.aT++;
    f.fr=t.x>f.x;
    if(this.aAT>0){this.aAT--;this.exec();return;}
    if(this.aT%this.cfg.rate===0) this.choose();
    this.exec();
  }
  choose(){
    const f=this.f,t=this.t;
    const dist=Math.abs(f.x-t.x), roll=Math.random();
    // React to attack
    if((t.state==='attack'||t.state==='special')&&roll<this.cfg.block){this.act='block';this.aAT=18;return;}
    // Super
    if(f.sp>=f.maxSp&&dist<160&&roll<.72){this.act='super';this.aAT=55;return;}
    // Special
    if(f.sp>=30&&dist<130&&roll<this.cfg.sp){this.act='special';this.aAT=35;return;}
    // Jump attack
    if(roll<this.cfg.jump&&dist<200){this.act='jatk';this.aAT=35;return;}
    if(dist>220){
      if(roll<this.cfg.aggr){this.act=f.x>t.x?'ml':'mr';this.aAT=18+Math.random()*18|0;}
      else{this.act='idle';this.aAT=18;}
    } else if(dist<90){
      if(roll<this.cfg.aggr){const atks=['light','heavy','kick'];this.act=atks[Math.random()*3|0];this.aAT=28;}
      else{this.act=f.x>t.x?'mr':'ml';this.aAT=14;}
    } else {
      if(roll<.45){this.act=f.x>t.x?'ml':'mr';this.aAT=12;}
      else if(roll<.65){this.act='kick';this.aAT=25;}
      else{this.act='idle';this.aAT=22;}
    }
  }
  exec(){
    const f=this.f,t=this.t;
    switch(this.act){
      case 'ml':f.move(-f.ch.speed);break;
      case 'mr':f.move(f.ch.speed);break;
      case 'jump':f.jump();break;
      case 'jatk':f.jump();if(f.aT%15===0&&!f.dead)f.atk('kick');break;
      case 'light':f.atk('light');break;
      case 'heavy':f.atk('heavy');break;
      case 'kick':f.atk('kick');break;
      case 'special':f.atk('special');break;
      case 'super':f.atk('super');break;
      case 'block':f.keys['down']=true;f.crouch();break;
    }
    if(this.act==='block'&&this.aAT<=0)f.keys['down']=false;
  }
}

// â”€â”€ HIT DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkHits(){chkHit(p1,p2);chkHit(p2,p1);}
function chkHit(a,d){
  if(!a.hitOn||a.hasHit||!a.atkHbx||d.dead) return;
  const ab=a.atkHbx,db=d.hbx;
  if(ab.x<db.x+db.w&&ab.x+ab.w>db.x&&ab.y<db.y+db.h&&ab.y+ab.h>db.y){
    a.hasHit=true; a.hitOn=false;
    const ap=a.ch.ap;
    let dm={light:ap.light,heavy:ap.heavy,kick:ap.kick,special:ap.special,super:ap.super}[a.atkType]||ap.light;
    // Iron fist ability
    if(a.hasAbil('ironFist')) dm=Math.floor(dm*1.1);
    // Rage ability
    if(a.hasAbil('rage')&&(a.hp/a.maxHp)<.25) dm=Math.floor(dm*1.25);
    // Crit
    let crit=Math.random()<(a.hasAbil('critical')?.27:.12);
    if(crit) dm=Math.floor(dm*1.6);
    const actual=d.takeDmg(dm,a.x);
    // Vampiric
    if(a.hasAbil('vampiric')&&!d.blocking){a.hp=Math.min(a.maxHp,a.hp+5);showAbilNotif('ğŸ©¸ +5 HP');}
    a.sp=Math.min(a.maxSp,a.sp+dm*.32);
    // Combo
    if(!d.blocking){
      a.combo++; a.comboT=a.hasAbil('comboWindow')?150:115;
      if(a.pid===1){
        G.sessionHits++;G.sessionDmg+=actual;G.sessionMaxCombo=Math.max(G.sessionMaxCombo,a.combo);
      }
      updCombo(a);
      if(a.combo>=5){
        // Mega combo ability
        if(a.hasAbil('megaCombo')) a.sp=Math.min(a.maxSp,a.sp+dm*.5);
        if(a.combo===5||a.combo===10||a.combo===15) showBigCombo(a.x,a.combo,a.ch.col);
      }
    }
    const hx=(ab.x+ab.w/2),hy=(ab.y+ab.h/2);
    spawnHit(hx,hy,a.atkType==='super'?'#fff':a.atkType==='special'?a.ch.col:crit?'#ffe600':'#fff');
    showDmg(hx,hy-18,actual,a.atkType==='super'?'s':crit?'c':d.blocking?'h':'n');
    updHUD();
    // Training mode: reset HP
    if(G.mode==='training'){setTimeout(()=>{if(d.dead||d.hp<d.maxHp*.3){d.dead=false;d.hp=d.maxHp;d.state='idle';d.stT=0;updHUD();}},800);}
  }
}

function updCombo(f){
  const el=document.getElementById(`cb${f.pid}`);
  const num=document.getElementById(`cb${f.pid}n`);
  if(f.combo>=2){el.classList.add('on');num.textContent=f.combo;}
  else el.classList.remove('on');
}

function showBigCombo(x,n,col){
  const el=document.createElement('div');
  el.className='big-combo';el.textContent=`${n} COMBO!`;
  el.style.color=col;el.style.textShadow=`0 0 20px ${col}`;
  el.style.left=(x-80)+'px';el.style.top=(GY-220)+'px';
  document.getElementById('gc').appendChild(el);
  setTimeout(()=>el.remove(),650);
}

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updHUD(){
  if(!p1||!p2) return;
  const upd=(p,px)=>{
    const pct=px.hp/px.maxHp*100, spc=px.sp/px.maxSp*100;
    document.getElementById(`p${p}hp`).style.width=pct+'%';
    document.getElementById(`p${p}hpt`).textContent=Math.ceil(px.hp);
    document.getElementById(`p${p}sp`).style.width=spc+'%';
    const hb=document.getElementById(`p${p}hp`);
    if(pct<25){hb.style.background=p===1?'linear-gradient(90deg,#ff0000,#ff4400)':'linear-gradient(270deg,#ff0000,#ff4400)';hb.style.boxShadow='0 0 8px rgba(255,0,0,.8)';}
    else if(pct<50){hb.style.background=p===1?'linear-gradient(90deg,#ff9900,#ffcc00)':'linear-gradient(270deg,#ff9900,#ffcc00)';}
  };
  upd(1,p1);upd(2,p2);
  // XP bar
  if(G.profile){
    const xp=document.getElementById('p1xp');
    if(xp) xp.style.width=(G.profile.xp/G.profile.xpToNext*100)+'%';
  }
}

// â”€â”€ STAGES DRAWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawStage(){
  const st=STAGES[G.stageIdx]; G.bgFrame++;
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,st.bg1);bg.addColorStop(.65,st.bg2);bg.addColorStop(1,'#000');
  ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
  drawStageDetails(st);
  // Floor
  const fg=ctx.createLinearGradient(0,GY-8,0,H);
  fg.addColorStop(0,st.fl);fg.addColorStop(1,'#000');
  ctx.fillStyle=fg;ctx.fillRect(0,GY,W,H-GY);
  ctx.save();ctx.shadowColor=st.flAcc;ctx.shadowBlur=18;ctx.strokeStyle=st.flAcc;ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(0,GY);ctx.lineTo(W,GY);ctx.stroke();ctx.restore();
  drawFloorGrid(st);
}

function drawStageDetails(st){
  const t=G.bgFrame;
  ctx.save();
  // Stars
  if(['space','void','city','thunder','ocean'].includes(st.type)){
    for(let i=0;i<80;i++){
      const s=i*137.508, sx=(s*7.3)%W, sy=(s*3.7)%(H*.75);
      ctx.globalAlpha=.4+(Math.sin(t*.02+s)*.5+.5)*.6;
      ctx.fillStyle='#fff';ctx.fillRect(sx,sy,i%4===0?2:1,i%4===0?2:1);
    }
  }
  ctx.globalAlpha=1;

  // City skyline
  if(st.type==='city'||st.type==='cyber'){
    drawCity(st,false);
  }
  // Fire effects
  if(st.type==='fire'||st.type==='blood'){
    for(let i=0;i<6;i++){
      const fx=(i*(W/5)+((t*(.4+i*.1))%(W/4)));
      ctx.globalAlpha=.18;
      for(let j=0;j<4;j++){
        ctx.fillStyle=j%2===0?st.a1:st.a2;ctx.shadowColor=ctx.fillStyle;ctx.shadowBlur=20;
        ctx.beginPath();ctx.ellipse(fx+(j*15),GY-30-j*20,8-j*1.5,14-j*2,Math.sin(t*.05+j)*.2,0,Math.PI*2);ctx.fill();
      }
    }
  }
  // Ice crystals
  if(st.type==='ice'){
    for(let i=0;i<10;i++){
      const s=i*73.5, ix=(s*5.3)%W, iy=GY-40-((s*2.1)%180);
      ctx.globalAlpha=.15+Math.sin(t*.02+s)*.08;
      ctx.strokeStyle=st.a1;ctx.lineWidth=1.5;ctx.shadowColor=st.a1;ctx.shadowBlur=8;
      ctx.beginPath();ctx.moveTo(ix,iy-25);ctx.lineTo(ix+8,iy);ctx.lineTo(ix,iy+25);ctx.lineTo(ix-8,iy);ctx.closePath();ctx.stroke();
    }
  }
  // Jungle vines
  if(st.type==='jungle'){
    for(let i=0;i<5;i++){
      const vx=i*(W/4)+50;
      ctx.globalAlpha=.25;ctx.strokeStyle=st.a1;ctx.lineWidth=3;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(vx,0);
      for(let j=0;j<8;j++) ctx.lineTo(vx+Math.sin(t*.03+j*.5)*20,j*70);
      ctx.stroke();
    }
  }
  // Space station
  if(st.type==='space'){
    ctx.globalAlpha=.3;ctx.strokeStyle=st.a1;ctx.lineWidth=1;
    const rx=W/2+Math.cos(t*.005)*100, ry=H*.3+Math.sin(t*.005)*40;
    ctx.strokeRect(rx-80,ry-15,160,30);ctx.strokeRect(rx-15,ry-50,30,100);
    for(let i=0;i<3;i++){const sx=(i*(W/3)+t*.2)%W;ctx.globalAlpha=.15;ctx.fillStyle='#fff';ctx.fillRect(sx,Math.sin(t*.04+i)*50+100,2,2);}
  }
  // Desert dunes
  if(st.type==='desert'){
    ctx.globalAlpha=.2;ctx.fillStyle=st.a2;ctx.beginPath();ctx.moveTo(0,GY);
    for(let dx=0;dx<=W;dx+=40) ctx.lineTo(dx,GY-20-Math.sin(dx*.02+t*.02)*30);
    ctx.lineTo(W,GY);ctx.fill();
  }
  // Thunder lightning
  if(st.type==='thunder'&&Math.random()<.015){
    ctx.globalAlpha=.7;ctx.strokeStyle=st.a1;ctx.lineWidth=2;ctx.shadowColor=st.a1;ctx.shadowBlur=20;
    const lx=Math.random()*W;let ly=0;
    ctx.beginPath();ctx.moveTo(lx,0);
    while(ly<H*.7){ly+=30+Math.random()*40;ctx.lineTo(lx+(Math.random()-.5)*60,ly);}
    ctx.stroke();
  }
  // Ocean waves
  if(st.type==='ocean'){
    ctx.globalAlpha=.2;ctx.strokeStyle=st.a1;ctx.lineWidth=2;
    for(let w=0;w<4;w++){
      ctx.beginPath();ctx.moveTo(0,H*.4+w*30);
      for(let wx=0;wx<W;wx+=20) ctx.lineTo(wx,H*.4+w*30+Math.sin(wx*.04+t*.04+w)*(8-w*1.5));
      ctx.stroke();
    }
  }
  // Temple pillars
  if(st.type==='temple'||st.type==='void'){
    for(let i=0;i<4;i++){
      const px=i*(W/3)+50;
      ctx.globalAlpha=.18;ctx.fillStyle=st.a2;
      ctx.fillRect(px,GY-160,20,160);
      ctx.fillRect(px-10,GY-170,40,12);
    }
  }

  ctx.globalAlpha=1;
  ctx.restore();
}

function drawCity(st,dark){
  const blds=[
    {x:0,w:80,h:185},{x:70,w:52,h:125},{x:112,w:72,h:205},{x:175,w:42,h:145},
    {x:208,w:92,h:175},{x:292,w:52,h:105},{x:336,w:62,h:225},{x:390,w:47,h:155},
    {x:428,w:57,h:182},{x:476,w:82,h:135},{x:550,w:62,h:205},{x:604,w:52,h:165},
    {x:648,w:72,h:215},{x:712,w:47,h:135},{x:751,w:87,h:180},{x:830,w:52,h:155},
    {x:874,w:82,h:195},{x:904,w:86,h:125},
  ];
  ctx.save();ctx.globalAlpha=dark?.55:.3;ctx.fillStyle='#020208';
  blds.forEach(b=>{
    ctx.fillRect(b.x,GY-b.h,b.w,b.h);
    ctx.save();ctx.globalAlpha=.35;
    const wc=Math.floor(b.w/16), wr=Math.floor(b.h/20);
    for(let r=1;r<wr;r++) for(let c=0;c<wc;c++){
      if(Math.sin(b.x+c*7+r*11)>.1){
        ctx.fillStyle=st.a1;ctx.shadowColor=st.a1;ctx.shadowBlur=3;
        ctx.fillRect(b.x+c*16+4,GY-b.h+r*20+4,6,8);
      }
    }
    ctx.restore();
  });
  ctx.restore();
}

function drawFloorGrid(st){
  ctx.save();ctx.globalAlpha=.1;ctx.strokeStyle=st.flAcc;ctx.lineWidth=.8;
  const sp=55, off=(G.bgFrame*.5)%sp;
  for(let x=-sp+off;x<W+sp;x+=sp){const p=(x-W/2)*1.8;ctx.beginPath();ctx.moveTo(x,GY);ctx.lineTo(W/2+p*.12,H);ctx.stroke();}
  for(let i=0;i<6;i++){const y=GY+i*18,pw=W*(1+i*.12);ctx.beginPath();ctx.moveTo((W-pw)/2,y);ctx.lineTo((W+pw)/2,y);ctx.stroke();}
  ctx.restore();
}

// â”€â”€ STAGE THUMBNAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawStageThumbnail(cvs,st){
  const c=cvs.getContext('2d');const w=cvs.width,h=cvs.height;
  const bg=c.createLinearGradient(0,0,0,h);bg.addColorStop(0,st.bg1);bg.addColorStop(1,st.bg2);
  c.fillStyle=bg;c.fillRect(0,0,w,h);
  c.fillStyle='#020208';c.globalAlpha=.5;
  [{x:0,ww:20,hh:40},{x:15,ww:15,hh:28},{x:28,ww:18,hh:45},{x:50,ww:12,hh:32},{x:65,ww:22,hh:38}].forEach(b=>c.fillRect(b.x,h*.6-b.hh,b.ww,b.hh));
  [{x:w-20,ww:20,hh:38},{x:w-38,ww:14,hh:26},{x:w-55,ww:18,hh:42}].forEach(b=>c.fillRect(b.x,h*.6-b.hh,b.ww,b.hh));
  c.globalAlpha=1;
  c.fillStyle=st.fl;c.fillRect(0,h*.6,w,h*.4);
  c.save();c.shadowColor=st.flAcc;c.shadowBlur=8;c.strokeStyle=st.flAcc;c.lineWidth=1.5;
  c.beginPath();c.moveTo(0,h*.6);c.lineTo(w,h*.6);c.stroke();c.restore();
}

// â”€â”€ CHAR PREVIEW DRAWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCharPreview(cvs,ch,scale=1){
  const c=cvs.getContext('2d');const w=cvs.width,h=cvs.height;
  c.clearRect(0,0,w,h);
  const bg=c.createLinearGradient(0,0,0,h);bg.addColorStop(0,'rgba(5,5,20,.9)');bg.addColorStop(1,`${ch.col}22`);
  c.fillStyle=bg;c.fillRect(0,0,w,h);
  c.save();c.translate(w/2,h-10);c.scale(scale,scale);
  const col=ch.col,col2=ch.col2,gy=0,bY=0;
  c.globalAlpha=.25;c.fillStyle='#000';c.beginPath();c.ellipse(0,gy+2,18,4,0,0,Math.PI*2);c.fill();c.globalAlpha=1;
  c.shadowColor=col;c.shadowBlur=8;c.strokeStyle=col2;c.lineWidth
  =8;
  // Legs preview
  c.beginPath();c.moveTo(-5,0);c.lineTo(-5,-12);c.stroke();
  c.beginPath();c.moveTo(5,0);c.lineTo(5,-12);c.stroke();
  // Body
  c.fillStyle=col2;c.beginPath();c.moveTo(-12,-12);c.lineTo(12,-12);c.lineTo(14,-30);c.lineTo(-14,-30);c.closePath();c.fill();
  // Chest accent
  c.save();c.globalAlpha=.5;c.fillStyle=col;
  if(ch.style==='electric'){c.beginPath();c.moveTo(-3,-16);c.lineTo(3,-20);c.lineTo(-1,-20);c.lineTo(3,-28);c.lineTo(-4,-22);c.lineTo(1,-22);c.closePath();c.fill();}
  else if(ch.style==='fire'){for(let i=0;i<3;i++){c.beginPath();c.arc(-4+i*4,-22+i*2,2,0,Math.PI*2);c.fill();}}
  else{c.fillRect(-8,-26,16,3);c.fillRect(-6,-20,12,2);}
  c.restore();
  // Arms
  c.strokeStyle=col2;c.lineWidth=6;c.lineCap='round';
  c.beginPath();c.moveTo(-10,-28);c.lineTo(-18,-20);c.stroke();
  c.beginPath();c.moveTo(10,-28);c.lineTo(18,-20);c.stroke();
  c.fillStyle=col;c.shadowBlur=6;c.beginPath();c.arc(18,-20,5,0,Math.PI*2);c.fill();
  // Head
  c.fillStyle=col2;c.fillRect(-3,-38,6,5);c.beginPath();c.arc(0,-44,10,0,Math.PI*2);c.fill();
  c.save();c.globalAlpha=.4;c.fillStyle=col;c.beginPath();c.arc(-2,-46,5,0,Math.PI*2);c.fill();c.restore();
  // Eyes
  c.fillStyle=col;c.fillRect(-5,-45,3,2);c.fillRect(1,-45,3,2);
  // Hair/spikes
  c.fillStyle=col;
  for(let i=0;i<3;i++){c.beginPath();c.moveTo(-6+i*6,-50);c.lineTo(-3+i*6,-58-i);c.lineTo(i*6,-50);c.fill();}
  c.restore();
}

// â”€â”€ INPUT HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let keys={};
window.addEventListener('keydown',(e)=>{
  if(G.paused&&e.code!=='Escape') return;
  keys[e.code]=true;
  // ESC: pause/unpause or back to menu
  if(e.code==='Escape'){
    if(G.state==='fight'){togglePause();}
    else if(G.state!=='title'){showTitle();}
  }
  // ENTER: quick start from title
  if(e.code==='Enter'&&G.state==='title'){goModes();}
  // Training reset position
  if(e.code==='KeyP'&&G.mode==='training'&&G.state==='fight'){
    if(p1){p1.x=W*.3;p1.y=GY;p1.state='idle';}
    if(p2){p2.x=W*.7;p2.y=GY;p2.state='idle';}
  }
});
window.addEventListener('keyup',(e)=>{
  keys[e.code]=false;
  if(p1&&matchKey(1,'down',e.code)) p1.keys['down']=false;
  if(p2&&matchKey(2,'down',e.code)) p2.keys['down']=false;
});

function matchKey(player,action,code){
  const prefix=`p${player}_`;
  return G.controls[prefix+action]===code;
}

function handleInput(){
  if(!p1||!p2||G.paused||G.roundOver) return;
  // P1 controls
  if(!p1.ai){
    if(keys[G.controls.p1_left]) p1.move(-p1.ch.speed);
    if(keys[G.controls.p1_right]) p1.move(p1.ch.speed);
    if(keys[G.controls.p1_up]) p1.jump();
    if(keys[G.controls.p1_down]){p1.crouch();}
    else{if(p1.keys['down'])p1.keys['down']=false;}
    if(keys[G.controls.p1_light]) p1.atk('light');
    if(keys[G.controls.p1_heavy]) p1.atk('heavy');
    if(keys[G.controls.p1_kick]) p1.atk('kick');
    if(keys[G.controls.p1_special]) p1.atk('special');
    if(keys[G.controls.p1_super]) p1.atk('super');
  }
  // P2 controls
  if(!p2.ai){
    if(keys[G.controls.p2_left]) p2.move(-p2.ch.speed);
    if(keys[G.controls.p2_right]) p2.move(p2.ch.speed);
    if(keys[G.controls.p2_up]) p2.jump();
    if(keys[G.controls.p2_down]){p2.crouch();}
    else{if(p2.keys['down'])p2.keys['down']=false;}
    if(keys[G.controls.p2_light]) p2.atk('light');
    if(keys[G.controls.p2_heavy]) p2.atk('heavy');
    if(keys[G.controls.p2_kick]) p2.atk('kick');
    if(keys[G.controls.p2_special]) p2.atk('special');
    if(keys[G.controls.p2_super]) p2.atk('super');
  }
  // Facing
  if(p1&&p2){p1.fr=p2.x>p1.x;p2.fr=p1.x>p2.x;}
}

// â”€â”€ GAME LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let p1=null,p2=null;
function gameLoop(){
  if(G.state!=='fight'){if(G.animFrame)cancelAnimationFrame(G.animFrame);return;}
  G.animFrame=requestAnimationFrame(gameLoop);
  if(G.paused) return;

  ctx.clearRect(0,0,W,H);
  drawStage();
  handleInput();
  if(p1){p1.update();if(p1.ai)p1.ai.update();}
  if(p2){p2.update();if(p2.ai)p2.ai.update();}
  checkHits();
  updParts();
  if(p1)p1.draw();
  if(p2)p2.draw();
  drawParts();
  updFX();

  // Check KO
  if(!G.roundOver&&p1&&p2){
    if(p1.dead||p2.dead){
      G.roundOver=true;
      const winner=p1.dead?2:1;
      if(winner===1)G.p1Wins++;else G.p2Wins++;
      updateWinDots();
      setTimeout(()=>{
        if(G.p1Wins>=2||G.p2Wins>=2||G.mode==='training'){
          endMatch(winner);
        } else {
          G.round++;nextRound();
        }
      },2500);
      announce(p1.dead?p2.ch.name:p1.ch.name,'ko',2400);
    }
  }
}

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer(){
  stopTimer();
  G.timer=99;
  const el=document.getElementById('tmr');
  el.textContent=G.timer;
  G.timerInt=setInterval(()=>{
    G.timer--;
    el.textContent=G.timer;
    if(G.timer<=10)el.classList.add('urg');
    if(G.timer<=0){
      stopTimer();
      if(!G.roundOver){
        G.roundOver=true;
        const w=(p1.hp>p2.hp)?1:2;
        if(w===1)G.p1Wins++;else G.p2Wins++;
        updateWinDots();
        announce('TIME UP','ko',1800);
        setTimeout(()=>{
          if(G.p1Wins>=2||G.p2Wins>=2){endMatch(w);}
          else{G.round++;nextRound();}
        },2200);
      }
    }
  },1000);
}

function stopTimer(){
  if(G.timerInt){clearInterval(G.timerInt);G.timerInt=null;}
  const el=document.getElementById('tmr');
  el.classList.remove('urg');
}

function updateWinDots(){
  for(let i=1;i<=2;i++){
    const w=i===1?G.p1Wins:G.p2Wins;
    const d1=document.getElementById(`p${i}w1`),d2=document.getElementById(`p${i}w2`);
    d1.className='wd';d2.className='wd';
    if(w>=1) d1.classList.add(i===1?'f1':'f2');
    if(w>=2) d2.classList.add(i===1?'f1':'f2');
  }
}

// â”€â”€ ROUND START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextRound(){
  G.roundOver=false;
  stopTimer();
  document.getElementById('rndLbl').textContent=`ROUND ${G.round}`;
  announce(`ROUND ${G.round}`,'rnd',1600);
  if(p1){p1.hp=p1.maxHp;p1.sp=0;p1.x=W*.3;p1.y=GY;p1.state='idle';p1.dead=false;p1.combo=0;p1.phoenixUsed=false;}
  if(p2){p2.hp=p2.maxHp;p2.sp=0;p2.x=W*.7;p2.y=GY;p2.state='idle';p2.dead=false;p2.combo=0;p2.phoenixUsed=false;}
  updHUD();
  setTimeout(()=>{announce('FIGHT!','fight',1400);startTimer();},1700);
}

// â”€â”€ END MATCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endMatch(winner){
  stopTimer();
  G.state='result';
  hideAllScreens();
  document.getElementById('scrResult').style.display='flex';
  
  const won=winner===1;
  document.getElementById('resTit').textContent=won?'Â¡VICTORIA!':'DERROTA';
  document.getElementById('resTit').style.color=won?'var(--c-yellow)':'var(--c-red)';
  document.getElementById('resWin').textContent=won?p1.ch.name+' GANA':p2.ch.name+' GANA';
  
  // Stats
  const stats=`
    <div class="rs-item"><div class="rs-lbl">GOLPES</div><div class="rs-val">${G.sessionHits}</div></div>
    <div class="rs-item"><div class="rs-lbl">DAÃ‘O TOTAL</div><div class="rs-val">${G.sessionDmg}</div></div>
    <div class="rs-item"><div class="rs-lbl">COMBO MÃXIMO</div><div class="rs-val">${G.sessionMaxCombo}</div></div>
  `;
  document.getElementById('resStats').innerHTML=stats;

  // XP & level up (only for P1 wins)
  if(won&&G.profile){
    const xpGain=120+Math.floor(Math.random()*80);
    G.profile.xp+=xpGain;
    G.profile.totalXp+=xpGain;
    G.profile.wins++;
    G.profile.totalFights++;
    G.profile.highestCombo=Math.max(G.profile.highestCombo,G.sessionMaxCombo);
    G.profile.totalDamage+=G.sessionDmg;
    
    let lvlUp=false;
    while(G.profile.xp>=G.profile.xpToNext){
      G.profile.xp-=G.profile.xpToNext;
      G.profile.level++;
      G.profile.xpToNext=Math.floor(G.profile.xpToNext*1.25);
      lvlUp=true;
      unlockContent();
    }
    
    document.getElementById('resXp').textContent=`+${xpGain} XP GANADOS`;
    if(lvlUp){
      document.getElementById('resLvl').style.display='block';
      snd('lvlup');
    } else {
      document.getElementById('resLvl').style.display='none';
    }
    
    writeSave(G.profile);
  } else if(!won&&G.profile){
    G.profile.losses++;
    G.profile.totalFights++;
    document.getElementById('resXp').textContent='';
    document.getElementById('resLvl').style.display='none';
    writeSave(G.profile);
  }

  // Mode-specific flows
  if(G.mode==='survival'){
    if(won){
      G.survivalWins++;
      showNotif(`Â¡${G.survivalWins} VICTORIAS CONSECUTIVAS!`,'var(--c-green)');
    }
  } else if(G.mode==='arcade'){
    if(won){
      G.arcadeIdx++;
      if(G.arcadeIdx>=G.arcadeOpponents.length){
        showNotif('Â¡ARCADE COMPLETADO!','var(--c-yellow)');
      }
    }
  } else if(G.mode==='tournament'){
    if(won){
      updateTournBracket(winner);
    }
  }
}

// â”€â”€ UNLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function unlockContent(){
  const lv=G.profile.level;
  // Unlock chars
  if(lv>=2&&!G.profile.unlockedChars.includes(4)){G.profile.unlockedChars.push(4);showNotif('Â¡PERSONAJE DESBLOQUEADO: ZARA!','var(--c-green)');}
  if(lv>=3&&!G.profile.unlockedChars.includes(5)){G.profile.unlockedChars.push(5);showNotif('Â¡PERSONAJE DESBLOQUEADO: RYKER!','var(--c-green)');}
  if(lv>=5&&!G.profile.unlockedChars.includes(6)){G.profile.unlockedChars.push(6);showNotif('Â¡PERSONAJE DESBLOQUEADO: LUNA!','var(--c-green)');}
  if(lv>=7&&!G.profile.unlockedChars.includes(7)){G.profile.unlockedChars.push(7);showNotif('Â¡PERSONAJE DESBLOQUEADO: BRUTUS!','var(--c-green)');}
  if(lv>=10&&!G.profile.unlockedChars.includes(8)){G.profile.unlockedChars.push(8);showNotif('Â¡PERSONAJE DESBLOQUEADO: NOVA!','var(--c-green)');}
  if(lv>=12&&!G.profile.unlockedChars.includes(9)){G.profile.unlockedChars.push(9);showNotif('Â¡PERSONAJE DESBLOQUEADO: DREV!','var(--c-green)');}
  if(lv>=15&&!G.profile.unlockedChars.includes(10)){G.profile.unlockedChars.push(10);showNotif('Â¡PERSONAJE DESBLOQUEADO: SERAPH!','var(--c-green)');}
  if(lv>=20&&!G.profile.unlockedChars.includes(11)){G.profile.unlockedChars.push(11);showNotif('Â¡PERSONAJE DESBLOQUEADO: KRAKEN!','var(--c-green)');}
  
  // Unlock stages
  if(lv>=2&&!G.profile.unlockedStages.includes(4)){G.profile.unlockedStages.push(4);showNotif('Â¡ESCENARIO DESBLOQUEADO: JUNGLE RUINS!','var(--c-green)');}
  if(lv>=4&&!G.profile.unlockedStages.includes(5)){G.profile.unlockedStages.push(5);showNotif('Â¡ESCENARIO DESBLOQUEADO: SPACE STATION!','var(--c-green)');}
  if(lv>=6&&!G.profile.unlockedStages.includes(6)){G.profile.unlockedStages.push(6);showNotif('Â¡ESCENARIO DESBLOQUEADO: DESERT STORM!','var(--c-green)');}
  if(lv>=8&&!G.profile.unlockedStages.includes(7)){G.profile.unlockedStages.push(7);showNotif('Â¡ESCENARIO DESBLOQUEADO: CYBER DOJO!','var(--c-green)');}
  if(lv>=10&&!G.profile.unlockedStages.includes(8)){G.profile.unlockedStages.push(8);showNotif('Â¡ESCENARIO DESBLOQUEADO: THUNDER PEAK!','var(--c-green)');}
  if(lv>=12&&!G.profile.unlockedStages.includes(9)){G.profile.unlockedStages.push(9);showNotif('Â¡ESCENARIO DESBLOQUEADO: OCEAN DEPTHS!','var(--c-green)');}
  if(lv>=15&&!G.profile.unlockedStages.includes(10)){G.profile.unlockedStages.push(10);showNotif('Â¡ESCENARIO DESBLOQUEADO: BLOOD COLISEUM!','var(--c-green)');}
  if(lv>=18&&!G.profile.unlockedStages.includes(11)){G.profile.unlockedStages.push(11);showNotif('Â¡ESCENARIO DESBLOQUEADO: SACRED TEMPLE!','var(--c-green)');}
  
  // Unlock abilities
  ABILITIES_CATALOG.forEach(ab=>{
    if(lv>=ab.lvl&&!G.profile.unlockedAbilities.includes(ab.id)){
      G.profile.unlockedAbilities.push(ab.id);
      showNotif(`Â¡HABILIDAD DESBLOQUEADA: ${ab.name}!`,'var(--c-purple)');
    }
  });
}

// â”€â”€ CONTINUE FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function continueFlow(){
  if(G.mode==='survival'){
    if(G.p1Wins>=2){
      G.survivalRound++;
      selectMode('survival');
    } else {
      showTitle();
    }
  } else if(G.mode==='arcade'){
    if(G.arcadeIdx>=G.arcadeOpponents.length){
      showTitle();
    } else {
      startArcadeFight();
    }
  } else if(G.mode==='tournament'){
    if(isTournComplete()){
      showTitle();
    } else {
      showScreen('scrTourn');
    }
  } else {
    showTitle();
  }
}

// â”€â”€ RESTART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function restartGame(){
  G.round=1;G.p1Wins=0;G.p2Wins=0;G.sessionHits=0;G.sessionDmg=0;G.sessionMaxCombo=0;
  startFight();
}

// â”€â”€ PAUSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePause(){
  G.paused=!G.paused;
  if(G.paused){
    stopTimer();
    document.getElementById('scrPause').style.display='flex';
  } else {
    document.getElementById('scrPause').style.display='none';
    if(G.state==='fight'&&!G.roundOver) startTimer();
  }
}

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideAllScreens(){
  ['scrTitle','scrModes','scrDiff','scrSelect','scrStage','scrProfile','scrControls','scrTourn','scrResult','scrPause'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('hud').style.display='none';
  document.getElementById('survivalHud').style.display='none';
  document.getElementById('trainingHud').style.display='none';
  document.getElementById('moveHints').style.display='none';
}

function showScreen(id){
  hideAllScreens();
  document.getElementById(id).style.display='flex';
  G.state=id.replace('scr','').toLowerCase();
}

function showTitle(){
  stopTimer();
  G.state='title';
  hideAllScreens();
  document.getElementById('scrTitle').style.display='flex';
  if(G.animFrame){cancelAnimationFrame(G.animFrame);G.animFrame=null;}
}

function goModes(){showScreen('scrModes');snd('select');}
function goDifficulty(){showScreen('scrDiff');snd('select');}
function goProfile(){buildProfile();showScreen('scrProfile');snd('select');}
function goControls(){buildControls();showScreen('scrControls');snd('select');}
function goCredits(){alert('NEON CLASH v2.0\n\nDesarrollado con â¤ï¸ por Claude\n\nMÃºsica y SFX: Procedural Audio\nMotor: Canvas 2D\n\nÂ¡Gracias por jugar!');}

function backFromSelect(){
  if(G.fromSelect){G.fromSelect=false;showScreen('scrStage');}
  else if(G.mode==='pve')goDifficulty();
  else goModes();
}

function backFromStage(){
  G.fromSelect=true;
  buildCharSelect();
  showScreen('scrSelect');
}

// â”€â”€ MODE SELECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectMode(mode){
  G.mode=mode;
  if(mode==='pvp'){
    buildCharSelect();
    showScreen('scrSelect');
  } else if(mode==='survival'){
    G.survivalRound=1;G.survivalWins=0;
    G.selP1=null;G.selP2=null;
    buildCharSelect();
    showScreen('scrSelect');
  } else if(mode==='arcade'){
    G.arcadeIdx=0;
    G.arcadeOpponents=[];
    for(let i=0;i<8;i++){
      let r;
      do{r=Math.floor(Math.random()*CHARS.length);}while(G.arcadeOpponents.includes(r));
      G.arcadeOpponents.push(r);
    }
    buildCharSelect();
    showScreen('scrSelect');
  } else if(mode==='training'){
    buildCharSelect();
    showScreen('scrSelect');
  } else if(mode==='tournament'){
    buildTournament();
    showScreen('scrTourn');
  } else {
    buildCharSelect();
    showScreen('scrSelect');
  }
  snd('select');
}

function selectDiff(diff){
  G.aiDiff=diff;
  G.mode='pve';
  buildCharSelect();
  showScreen('scrSelect');
  snd('select');
}

// â”€â”€ CHARACTER SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCharSelect(){
  const p1g=document.getElementById('p1cg'),p2g=document.getElementById('p2cg');
  p1g.innerHTML='';p2g.innerHTML='';
  
  CHARS.forEach((ch,i)=>{
    const locked=!G.profile.unlockedChars.includes(i);
    const c1=document.createElement('div');
    c1.className='ccard'+(locked?' locked':'');
    if(!locked)c1.onclick=()=>selectChar(1,i);
    
    const cvs1=document.createElement('canvas');
    cvs1.width=80;cvs1.height=110;
    if(!locked) drawCharPreview(cvs1,ch,.65);
    c1.appendChild(cvs1);
    
    const n1=document.createElement('div');n1.className='ccard-name';n1.textContent=ch.name;c1.appendChild(n1);
    const t1=document.createElement('div');t1.className='ccard-type';t1.textContent=ch.sub;c1.appendChild(t1);
    p1g.appendChild(c1);
    
    if(G.mode!=='pvp'&&G.mode!=='training') return;
    
    const c2=document.createElement('div');
    c2.className='ccard'+(locked?' locked':'');
    if(!locked)c2.onclick=()=>selectChar(2,i);
    
    const cvs2=document.createElement('canvas');
    cvs2.width=80;cvs2.height=110;
    if(!locked) drawCharPreview(cvs2,ch,.65);
    c2.appendChild(cvs2);
    
    const n2=document.createElement('div');n2.className='ccard-name';n2.textContent=ch.name;c2.appendChild(n2);
    const t2=document.createElement('div');t2.className='ccard-type';t2.textContent=ch.sub;c2.appendChild(t2);
    p2g.appendChild(c2);
  });
  
  updateModeLabel();
  updateCharPreviews();
}

function selectChar(p,idx){
  if(p===1){G.selP1=idx;}else{G.selP2=idx;}
  updateCharPreviews();
  snd('select');
  
  const both=(G.mode==='pvp'||G.mode==='training')?G.selP1!==null&&G.selP2!==null:G.selP1!==null;
  document.getElementById('fightBtn').disabled=!both;
}

function updateCharPreviews(){
  // P1
  if(G.selP1!==null){
    const ch=CHARS[G.selP1];
    document.getElementById('prevP1n').textContent=ch.name;
    drawCharPreview(document.getElementById('prevP1c'),ch,.8);
    document.getElementById('prevP1stats').innerHTML=buildStatBars(ch.stats);
    document.getElementById('prevP1ab').textContent=ch.sName+' / '+ch.suName;
    const cards=document.querySelectorAll('#p1cg .ccard');
    cards.forEach((c,i)=>{c.classList.remove('sp1');if(i===G.selP1)c.classList.add('sp1');});
  } else {
    document.getElementById('prevP1n').textContent='---';
    document.getElementById('prevP1c').getContext('2d').clearRect(0,0,80,110);
    document.getElementById('prevP1stats').innerHTML='';
    document.getElementById('prevP1ab').textContent='';
  }
  
  // P2
  if(G.selP2!==null){
    const ch=CHARS[G.selP2];
    document.getElementById('prevP2n').textContent=ch.name;
    drawCharPreview(document.getElementById('prevP2c'),ch,.8);
    document.getElementById('prevP2stats').innerHTML=buildStatBars(ch.stats);
    document.getElementById('prevP2ab').textContent=ch.sName+' / '+ch.suName;
    const cards=document.querySelectorAll('#p2cg .ccard');
    cards.forEach((c,i)=>{c.classList.remove('sp2');if(i===G.selP2)c.classList.add('sp2');});
  } else if(G.mode==='pvp'||G.mode==='training'){
    document.getElementById('prevP2n').textContent='---';
    document.getElementById('prevP2c').getContext('2d').clearRect(0,0,80,110);
    document.getElementById('prevP2stats').innerHTML='';
    document.getElementById('prevP2ab').textContent='';
  }
  
  // Auto-select P2 for CPU modes
  if((G.mode==='pve'||G.mode==='survival'||G.mode==='arcade')&&G.selP1!==null&&G.selP2===null){
    let r;
    do{r=Math.floor(Math.random()*CHARS.length);}while(r===G.selP1||!G.profile.unlockedChars.includes(r));
    G.selP2=r;
    updateCharPreviews();
  }
}

function buildStatBars(stats){
  const labels={spd:'VEL',pow:'POD',def:'DEF',sp:'ESP'};
  return Object.keys(stats).map(k=>`
    <div class="stat-row">
      <div class="stat-lbl">${labels[k]}</div>
      <div class="stat-bg"><div class="stat-fill" style="width:${stats[k]*10}%"></div></div>
    </div>
  `).join('');
}

function updateModeLabel(){
  const labels={pvp:'2 JUGADORES',pve:'VS CPU',arcade:'ARCADE',survival:'SUPERVIVENCIA',training:'ENTRENAMIENTO',tournament:'TORNEO'};
  const diffs={easy:'NOVATO',medium:'GUERRERO',hard:'MAESTRO',god:'DIOS'};
  document.getElementById('modeLabel').textContent='MODO: '+(labels[G.mode]||'---');
  if(G.mode==='pve'){
    document.getElementById('diffLabel').textContent='DIFICULTAD: '+diffs[G.aiDiff];
    document.getElementById('diffLabel').style.display='block';
  } else {
    document.getElementById('diffLabel').style.display='none';
  }
}

// â”€â”€ STAGE SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goStageSelect(fromFight){
  if(fromFight&&G.selP1===null) return;
  buildStageSelect();
  showScreen('scrStage');
  snd('select');
}

function buildStageSelect(){
  const grid=document.getElementById('stageGrid');
  grid.innerHTML='';
  STAGES.forEach((st,i)=>{
    const locked=!G.profile.unlockedStages.includes(i);
    const card=document.createElement('div');
    card.className='stcard'+(locked?' locked':'')+(i===G.stageIdx?' sel':'');
    
    const cvs=document.createElement('canvas');
    cvs.width=160;cvs.height=90;
    if(!locked) drawStageThumbnail(cvs,st);
    card.appendChild(cvs);
    
    const name=document.createElement('div');
    name.className='stcard-name';
    name.textContent=st.name;
    card.appendChild(name);
    
    if(!locked) card.onclick=()=>{
      G.stageIdx=i;
      document.querySelectorAll('.stcard').forEach(c=>c.classList.remove('sel'));
      card.classList.add('sel');
      document.getElementById('stgConfirm').disabled=false;
      snd('select');
    };
    
    grid.appendChild(card);
  });
}

function selectRandomStage(){
  const unlocked=G.profile.unlockedStages;
  G.stageIdx=unlocked[Math.floor(Math.random()*unlocked.length)];
  confirmStage();
}

function confirmStage(){
  snd('select');
  if(G.mode==='arcade'&&G.arcadeIdx===0){
    startArcadeFight();
  } else if(G.mode==='tournament'){
    startTournFight();
  } else {
    startFight();
  }
}

// â”€â”€ START FIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startFight(){
  G.state='fight';
  G.round=1;
  G.p1Wins=0;
  G.p2Wins=0;
  G.sessionHits=0;
  G.sessionDmg=0;
  G.sessionMaxCombo=0;
  
  hideAllScreens();
  document.getElementById('hud').style.display='flex';
  
  // Mode-specific HUDs
  if(G.mode==='survival'){
    document.getElementById('survivalHud').style.display='block';
    document.getElementById('srvRnd').textContent=G.survivalRound;
    document.getElementById('srvWins').textContent=G.survivalWins;
  }
  if(G.mode==='training'){
    document.getElementById('trainingHud').style.display='block';
    document.getElementById('p2hints').style.display='none';
  } else {
    document.getElementById('moveHints').style.display='flex';
  }
  
  // Init fighters
  p1=new Fighter(CHARS[G.selP1],W*.3,true,1);
  p2=new Fighter(CHARS[G.selP2],W*.7,false,2);
  
  // AI setup
  if(G.mode==='pve'||G.mode==='arcade'||G.mode==='survival'||G.mode==='training'){
    p2.ai=new AI(p2,p1,G.aiDiff);
  }
  
  // Set names
  document.getElementById('p1nm').textContent=p1.ch.name;
  document.getElementById('p2nm').textContent=p2.ch.name;
  
  // Level badges
  if(G.profile){
    document.getElementById('p1lvbdg').textContent='LV.'+G.profile.level;
    const p1xp=G.profile.xp/G.profile.xpToNext*100;
    document.getElementById('p1xp').style.width=p1xp+'%';
  }
  
  updateWinDots();
  updHUD();
  
  nextRound();
  gameLoop();
}

function startArcadeFight(){
  G.selP2=G.arcadeOpponents[G.arcadeIdx];
  startFight();
}

// â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildProfile(){
  const p=G.profile;
  const layout=document.getElementById('profileLayout');
  layout.innerHTML=`
    <div class="panel-box">
      <div class="panel-title">ğŸ‘¤ INFORMACIÃ“N</div>
      <div class="input-row">
        <div class="input-lbl">NOMBRE DE JUGADOR</div>
        <input type="text" class="input-field" id="profName" value="${p.name}" maxlength="16">
      </div>
      <div class="sep"></div>
      <div class="xp-section">
        <div class="xp-header">
          <div class="xp-lvl">NIVEL ${p.level}</div>
          <div class="xp-prog">${p.xp} / ${p.xpToNext} XP</div>
        </div>
        <div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${p.xp/p.xpToNext*100}%"></div></div>
      </div>
    </div>
    
    <div class="panel-box">
      <div class="panel-title">ğŸ“Š ESTADÃSTICAS</div>
      <div class="stats-grid">
        <div class="stat-item"><div class="stat-item-lbl">VICTORIAS</div><div class="stat-item-val">${p.wins}</div></div>
        <div class="stat-item"><div class="stat-item-lbl">DERROTAS</div><div class="stat-item-val">${p.losses}</div></div>
        <div class="stat-item"><div class="stat-item-lbl">COMBATES</div><div class="stat-item-val">${p.totalFights}</div></div>
        <div class="stat-item"><div class="stat-item-lbl">RATIO W/L</div><div class="stat-item-val">${p.wins>0?(p.wins/Math.max(1,p.losses)).toFixed(2):'0.00'}</div></div>
        <div class="stat-item"><div class="stat-item-lbl">MEJOR COMBO</div><div class="stat-item-val">${p.highestCombo}</div></div>
        <div class="stat-item"><div class="stat-item-lbl">DAÃ‘O TOTAL</div><div class="stat-item-val">${p.totalDamage}</div></div>
      </div>
    </div>
    
    <div class="panel-box">
      <div class="panel-title">ğŸ¯ HABILIDADES</div>
      <div class="abilities-list scroll-panel">
        ${ABILITIES_CATALOG.map(ab=>{
          const unlocked=p.unlockedAbilities.includes(ab.id);
          const locked=p.level<ab.lvl;
          return `<div class="ability-item ${unlocked?'unlocked':'locked'}">
            <div class="ability-icon">${ab.icon}</div>
            <div class="ability-info">
              <div class="ability-name ${unlocked?'':'locked'}">${ab.name}</div>
              <div class="ability-desc">${ab.desc}</div>
            </div>
            <div class="ability-lvl">${locked?`ğŸ”’ LV.${ab.lvl}`:unlocked?'âœ“':''}</div>
          </div>`;
        }).join('')}
      </div>
    </div>
    
    <div class="panel-box">
      <div class="panel-title">ğŸ† COLECCIÃ“N</div>
      <div class="input-row">
        <div class="input-lbl">PERSONAJES DESBLOQUEADOS</div>
        <div class="stat-item-val">${p.unlockedChars.length} / ${CHARS.length}</div>
      </div>
      <div class="input-row">
        <div class="input-lbl">ESCENARIOS DESBLOQUEADOS</div>
        <div class="stat-item-val">${p.unlockedStages.length} / ${STAGES.length}</div>
      </div>
      <div class="input-row">
        <div class="input-lbl">HABILIDADES DESBLOQUEADAS</div>
        <div class="stat-item-val">${p.unlockedAbilities.length} / ${ABILITIES_CATALOG.length}</div>
      </div>
    </div>
  `;
}

function saveProfile(){
  G.profile.name=document.getElementById('profName').value||'LUCHADOR';
  writeSave(G.profile);
  showNotif('PERFIL GUARDADO','var(--c-green)');
  snd('select');
}

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let listeningKey=null;

function buildControls(){
  const grid=document.getElementById('ctrlGrid');
  const actions={
    p1:{left:'Izquierda',right:'Derecha',up:'Saltar',down:'Agachar',light:'Golpe',heavy:'Pesado',kick:'Patada',special:'Especial',super:'Super'},
    p2:{left:'Izquierda',right:'Derecha',up:'Saltar',down:'Agachar',light:'Golpe',heavy:'Pesado',kick:'Patada',special:'Especial',super:'Super'}
  };
  
  grid.innerHTML='';
  ['p1','p2'].forEach(p=>{
    const col=document.createElement('div');
    col.innerHTML=`<div style="font-size:12px;letter-spacing:3px;color:${p==='p1'?'var(--c-blue)':'var(--c-red)'};margin-bottom:8px;font-weight:700;">${p==='p1'?'JUGADOR 1':'JUGADOR 2'}</div>`;
    Object.keys(actions[p]).forEach(a=>{
      const row=document.createElement('div');
      row.className='ctrl-row';
      row.innerHTML=`
        <div class="ctrl-action">${actions[p][a]}</div>
        <div class="ctrl-key" data-key="${p}_${a}">${keyLabel(G.controls[p+'_'+a])}</div>
      `;
      row.querySelector('.ctrl-key').onclick=(e)=>startListening(p+'_'+a,e.target);
      col.appendChild(row);
    });
    grid.appendChild(col);
  });
}

function keyLabel(code){
  const labels={
    KeyA:'A',KeyD:'D',KeyW:'W',KeyS:'S',KeyF:'F',KeyR:'R',KeyG:'G',KeyH:'H',KeyT:'T',KeyP:'P',
    ArrowLeft:'â†',ArrowRight:'â†’',ArrowUp:'â†‘',ArrowDown:'â†“',
    Digit1:'1',Digit2:'2',Digit3:'3',Digit4:'4',Digit5:'5',Space:'ESPACIO'
  };
  return labels[code]||code;
}

function startListening(key,el){
  listeningKey={key,el};
  el.classList.add('listening');
  el.textContent='...';
  const handler=(e)=>{
    e.preventDefault();
    if(!listeningKey) return;
    G.controls[listeningKey.key]=e.code;
    listeningKey.el.classList.remove('listening');
    listeningKey.el.textContent=keyLabel(e.code);
    listeningKey=null;
    window.removeEventListener('keydown',handler);
  };
  window.addEventListener('keydown',handler);
}

function saveControls(){
  G.profile.controls={...G.controls};
  writeSave(G.profile);
  showNotif('CONTROLES GUARDADOS','var(--c-green)');
  snd('select');
}

function resetControls(){
  G.controls={...DEFAULT_CONTROLS};
  buildControls();
  showNotif('CONTROLES RESETEADOS','var(--c-yellow)');
  snd('select');
}

// â”€â”€ TOURNAMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTournament(){
  // Generate 8 fighters bracket
  const pool=G.profile.unlockedChars.slice();
  G.tournPlayers=[];
  for(let i=0;i<8;i++){
    const r=pool[Math.floor(Math.random()*pool.length)];
    pool.splice(pool.indexOf(r),1);
    G.tournPlayers.push(r);
  }
  
  // Bracket structure: [round1matches, round2matches, finalMatch]
  G.tournBracket=[
    [{p1:0,p2:1,w:null},{p1:2,p2:3,w:null},{p1:4,p2:5,w:null},{p1:6,p2:7,w:null}],
    [{p1:null,p2:null,w:null},{p1:null,p2:null,w:null}],
    [{p1:null,p2:null,w:null}]
  ];
  
  G.tournRound=0;
  G.tournMatchIdx=0;
  drawTournBracket();
}

function drawTournBracket(){
  const bracket=document.getElementById('tournBracket');
  bracket.innerHTML='';
  
  const rounds=['RONDA 1','SEMIFINAL','FINAL'];
  G.tournBracket.forEach((rd,ri)=>{
    const col=document.createElement('div');
    col.className='bracket-col';
    col.innerHTML=`<div class="bracket-col-title">${rounds[ri]}</div>`;
    rd.forEach(m=>{
      const card=document.createElement('div');
      card.className='bracket-match';
      const p1name=m.p1!==null?CHARS[G.tournPlayers[m.p1]].name:'TBD';
      const p2name=m.p2!==null?CHARS[G.tournPlayers[m.p2]].name:'TBD';
      card.innerHTML=`
        <div class="bracket-fighter ${m.w===m.p1?'winner':m.w!==null?'loser':m.p1!==null?'':'tbd'}">${p1name}</div>
        <div class="bracket-fighter ${m.w===m.p2?'winner':m.w!==null?'loser':m.p2!==null?'':'tbd'}">${p2name}</div>
      `;
      col.appendChild(card);
    });
    bracket.appendChild(col);
  });
  
  updateTournBtn();
}

function updateTournBtn(){
  const btn=document.getElementById('tournNextBtn');
  if(isTournComplete()){
    btn.textContent='âœ“ TORNEO COMPLETO';
    btn.disabled=true;
  } else {
    btn.textContent='â–¶ SIGUIENTE PELEA';
    btn.disabled=false;
  }
}

function isTournComplete(){
  return G.tournBracket[2][0].w!==null;
}

function tournNext(){
  const m=G.tournBracket[G.tournRound][G.tournMatchIdx];
  if(m.p1===null||m.p2===null) return;
  
  G.selP1=G.tournPlayers[m.p1];
  G.selP2=G.tournPlayers[m.p2];
  G.stageIdx=Math.floor(Math.random()*G.profile.unlockedStages.length);
  startTournFight();
}

function startTournFight(){
  G.mode='tournament';
  startFight();
}

function updateTournBracket(winner){
  const m=G.tournBracket[G.tournRound][G.tournMatchIdx];
  m.w=winner===1?m.p1:m.p2;
  
  // Advance winner
  if(G.tournRound<2){
    const nextRound=G.tournBracket[G.tournRound+1];
    const nextMatchIdx=Math.floor(G.tournMatchIdx/2);
    if(G.tournMatchIdx%2===0){
      nextRound[nextMatchIdx].p1=m.w;
    } else {
      nextRound[nextMatchIdx].p2=m.w;
    }
  }
  
  // Next match
  G.tournMatchIdx++;
  if(G.tournMatchIdx>=G.tournBracket[G.tournRound].length){
    G.tournMatchIdx=0;
    G.tournRound++;
  }
  
  drawTournBracket();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
showTitle();
</script>
</body>
</html>